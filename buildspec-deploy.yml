version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto17
  build:
    commands:
      # JARãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ“ãƒ«ãƒ‰
      - echo "Building Lambda JAR file..."
      - cd backend
      - ./gradlew clean springCloudFunctionLambdaJar
      - cd ..
      - |
        # JARãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ ! -f "backend/build/libs/shirogane-holy-knights-0.1.0-aws-lambda.jar" ]; then
          echo "âŒ JAR file not found: backend/build/libs/shirogane-holy-knights-0.1.0-aws-lambda.jar"
          echo "Build failed or JAR file name mismatch"
          exit 1
        fi
        echo "âœ… JAR file found successfully"
      
      - echo Checking if Lambda function exists
      - |
        if aws lambda get-function --function-name "$LAMBDA_FUNCTION_NAME" >/dev/null 2>&1; then
          echo "Lambda function exists, updating code..."
          
          # é–¢æ•°ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°
          aws lambda update-function-code \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --zip-file "fileb://backend/build/libs/shirogane-holy-knights-0.1.0-aws-lambda.jar" || {
              echo "âŒ Failed to update Lambda function code"
              exit 1
            }
          
          # æ›´æ–°å®Œäº†ã¾ã§å¾…æ©Ÿ
          aws lambda wait function-updated \
            --function-name "$LAMBDA_FUNCTION_NAME"
          
          echo "Lambda function updated successfully"
          
          # æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’Publish
          echo "Publishing new version..."
          NEW_VERSION=$(aws lambda publish-version \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --query 'Version' \
            --output text)
          
          echo "Published version: $NEW_VERSION"
          
          # Aliasã‚’æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°
          echo "Updating alias 'live' to version $NEW_VERSION..."
          aws lambda update-alias \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --name "live" \
            --function-version "$NEW_VERSION"
          
          echo "âœ… Alias 'live' updated to version $NEW_VERSION (SnapStart enabled)"
        else
          echo "âŒ Lambda function $LAMBDA_FUNCTION_NAME not found"
          echo "Please create the infrastructure using Terraform first"
          exit 1
        fi

  post_build:
    commands:
      - echo Lambda deployment completed on `date`
      - |
        # é–¢æ•°æƒ…å ±ã®å–å¾—
        aws lambda get-function --function-name "$LAMBDA_FUNCTION_NAME" \
          --query 'Configuration.{FunctionName:FunctionName,Runtime:Runtime,LastModified:LastModified,CodeSize:CodeSize}' \
          --output table
      
      # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†åˆ¤å®š
      - echo "Starting deployment health check..."
      - chmod +x scripts/health-check-deployment.sh
      - scripts/health-check-deployment.sh
      
      - echo "ğŸ‰ Deployment completed successfully with health check validation"
