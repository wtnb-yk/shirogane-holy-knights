# SongSearchResultsSummary リファクタリング調査結果

**調査日時**: 2025年09月25日
**作成ブランチ**: feature/song-search-results-refactor
**調査者**: Claude

## 調査概要

`frontend/src/features/songs/components/display/results/SongSearchResultsSummary.tsx`を他機能と同様に基底コンポーネント（SearchResultsSummary）をラップする形にリファクタリングするための調査を実施。

## 現状分析

### SongSearchResultsSummary の現在の実装
- **ファイルパス**: `frontend/src/features/songs/components/display/results/SongSearchResultsSummary.tsx`
- **実装方式**: 独自実装（基底コンポーネント未使用）
- **行数**: 134行の完全独自実装
- **特有機能**:
  - SearchTarget（検索対象: 楽曲名のみ/アーティスト名のみ/両方）の表示
  - SingFrequencyCategory（歌唱回数カテゴリ: 1-2回/3-5回/6-10回/11回以上）フィルター
  - 個別フィルタークリアボタン（検索クリア、日付クリア、頻度クリア）

### 他機能の実装パターン
以下の機能は全て基底コンポーネント（SearchResultsSummary）をラップする形で実装済み：

1. **CalendarSearchResultsSummary** (38行)
   - イベントタイプカテゴリフィルター対応
   - filterSummary生成でカテゴリ名を表示

2. **NewsSearchResultsSummary** (44行)
   - ニュースカテゴリフィルター対応
   - useNewsCategories hook使用

3. **DiscographySearchResultsSummary** (44行)
   - アルバムタイプフィルター対応
   - useAlbumTypes hook使用

4. **ArchiveSearchResultsSummary** (50行)
   - タグフィルター + 日付フィルター対応
   - 複合フィルターサマリー生成

## 基底コンポーネント分析

### SearchResultsSummary の仕様
- **ファイルパス**: `frontend/src/components/common/SearchResultsSummary.tsx`
- **主要Props**:
  - `searchQuery`: 検索クエリ
  - `filterSummary?`: フィルター概要テキスト（オプション）
  - `totalCount`: 検索結果件数
  - `onClearAllFilters`: 全クリア関数
  - `hasFilters`: フィルター有無フラグ
  - `filters?`: フィルター詳細（selectedTags, startDate, endDate）

### 基底コンポーネントの制約
- **個別クリアボタン**: 未対応（全クリアのみ）
- **対応フィルター**: selectedTags, startDate, endDate のみ
- **カスタムフィルター表示**: filterSummaryで対応

## 使用箇所の分析

### SongSearchResultsSummary の使用箇所
- **使用ファイル**: `frontend/src/app/songs/page.tsx:133`
- **Props渡し**:
  ```typescript
  <SongSearchResultsSummary
    searchQuery={currentData.searchQuery}
    totalCount={currentData.totalCount}
    filters={currentData.filters}
    onClearSearch={currentData.clearSearch}  // 個別クリア
    onClearAllFilters={currentData.clearAllFilters}
  />
  ```

## 技術的制約・課題

### 1. 個別クリア機能の制約
- **現在**: 検索クリア、日付クリア、頻度クリアの3つの個別クリア機能あり
- **基底コンポーネント**: 全クリアのみ対応
- **対応方針**: 全クリア機能に統一（UX的には劣化の可能性）

### 2. Songs特有フィルターの対応
- **SearchTarget**: 検索対象の表示が必要
- **SingFrequencyCategory**: 頻度カテゴリの表示が必要
- **対応方針**: filterSummaryでテキスト表示、filters.selectedTagsで頻度ラベル配列を渡す

### 3. 型定義の課題
```typescript
// 現在の型
interface SongFilterOptions {
  startDate?: string;
  endDate?: string;
  frequencyCategories?: SingFrequencyCategory[];
}

// 基底コンポーネントの期待する型
interface filters {
  selectedTags?: string[];
  startDate?: string;
  endDate?: string;
}
```

## 根本原因・解決方針

### 根本原因
SongSearchResultsSummaryが他機能の統一パターン採用前に実装されており、基底コンポーネントを使用していない独自実装となっている。

### 解決方針
1. **基底コンポーネントラップ**: 他機能と同様のパターンに変更
2. **フィルター変換ロジック**: SongFilterOptions → 基底コンポーネント形式への変換
3. **フィルターサマリー生成**: Songs特有のフィルター情報をテキスト化
4. **UX調整**: 個別クリア → 全クリアへの変更受容

## 実装推奨事項

### リファクタリング後の構造
```typescript
export const SongSearchResultsSummary = ({
  searchQuery,
  searchTarget,
  totalCount,
  filters,
  onClearAllFilters
}: SongSearchResultsSummaryProps) => {
  // フィルターサマリー生成
  const filterParts: string[] = [];
  if (searchTarget !== SearchTarget.ALL) {
    filterParts.push(`検索対象: ${SEARCH_TARGET_LABELS[searchTarget]}`);
  }
  if (filters.frequencyCategories?.length) {
    const frequencies = filters.frequencyCategories.map(cat => FREQUENCY_LABELS[cat]).join(', ');
    filterParts.push(`歌唱回数: ${frequencies}`);
  }
  const filterSummary = filterParts.join(' / ');

  // 基底コンポーネント用filters変換
  const baseFilters = {
    selectedTags: filters.frequencyCategories?.map(cat => FREQUENCY_LABELS[cat]),
    startDate: filters.startDate,
    endDate: filters.endDate,
  };

  const hasFilters = Boolean(searchQuery.trim()) ||
    Boolean(filters.startDate) ||
    Boolean(filters.endDate) ||
    Boolean(filters.frequencyCategories?.length);

  return (
    <SearchResultsSummary
      searchQuery={searchQuery}
      filterSummary={filterSummary}
      totalCount={totalCount}
      onClearAllFilters={onClearAllFilters}
      hasFilters={hasFilters}
      filters={baseFilters}
    />
  );
};
```

### 必要な変更箇所
1. **SongSearchResultsSummary.tsx**: 完全リファクタリング
2. **使用側**: props変更は最小限（個別クリア関数の削除のみ）

## 影響範囲・リスク

### 影響範囲
- **コンポーネント**: SongSearchResultsSummary.tsx (134行 → 約40行)
- **使用箇所**: songs/page.tsx のprops調整
- **型定義**: Props interface の調整

### リスク
- **UX劣化**: 個別クリアボタンの削除
- **表示差異**: 基底コンポーネントのスタイル適用
- **機能削除**: SearchTargetの個別表示制約

## テスト計画

### 動作確認項目
1. **検索機能**: クエリ入力・実行・表示
2. **フィルター機能**: 日付・頻度カテゴリフィルター
3. **クリア機能**: 全クリアボタンの動作
4. **UI表示**: フィルターサマリーの表示内容
5. **レスポンシブ**: モバイル・デスクトップ表示

### テスト環境
- Playwright MCP ツール使用
- http://localhost:3001/songs での動作確認

## 次フェーズ推奨事項

1. **Plan フェーズ**: 詳細実装手順の策定
2. **Implement フェーズ**: 段階的実装・テスト
3. **UXレビュー**: 個別クリア機能削除の影響評価