# 調査レポート: event_typesとnews_categoriesテーブルへのCOLLABORATIONレコード追加

## 調査概要

### 調査日時
2025-10-14 11:41:22

### 調査対象
event_typesとnews_categoriesテーブルそれぞれに新しいレコード「COLLABORATION」を追加する実装の調査

### 調査目的
既存システムの構造を把握し、COLLABORATIONレコード追加の実装方針を策定する

## 調査結果サマリー

### 重要な発見
1. **news_categoriesテーブルには既にCOLLABORATIONが存在している**
   - 004-create-news-tables.sqlで初期データとして 'COLLABORATION' が投入済み
   - フロントエンドでも既に定義・使用されている
   - 追加作業は不要

2. **event_typesテーブルにはcollaborationが存在していない**
   - 現在のレコード: event, goods, campaign, others
   - collaborationは未定義
   - 追加作業が必要

## 詳細調査結果

### 1. データベース層の調査

#### news_categoriesテーブル
**マイグレーションファイル**: `backend/src/main/resources/db/changelog/changes/004-create-news-tables.sql`

テーブル構造:
```sql
CREATE TABLE news_categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

既存レコード:
- GOODS (id: 1)
- COLLABORATION (id: 2) ← 既に存在
- EVENT (id: 3)
- MEDIA (id: 4)
- CAMPAIGN (id: 5)
- OTHERS (id: 6)

#### event_typesテーブル
**マイグレーションファイル**: `backend/src/main/resources/db/changelog/changes/021-create-calendar-tables.sql`

テーブル構造:
```sql
CREATE TABLE event_types (
    id SERIAL PRIMARY KEY,
    type VARCHAR(30) NOT NULL UNIQUE
);
```

既存レコード:
- event (id: 1)
- goods (id: 2)
- campaign (id: 3, 022-add-campaign-event-type.sqlで追加)
- others (id: 4, 030-add-others-event-type.sqlで追加)

**collaboration は存在しない** ← 追加が必要

### 2. バックエンド層の調査

#### エンティティ定義
**CalendarEntities.kt** (`backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/CalendarEntities.kt`)
```kotlin
data class EventTypeEntity(
    @org.springframework.data.annotation.Id
    val id: Int,
    val type: String
)
```

**NewsEntities.kt** (`backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/NewsEntities.kt`)
```kotlin
data class NewsCategoryEntity(
    @org.springframework.data.annotation.Id
    val id: Int,
    val name: String,
    val sortOrder: Int,
    val createdAt: Instant
)
```

エンティティ定義は汎用的で、レコード追加による変更は不要。

### 3. ツール層の調査

#### calendar_importer.py
**ファイルパス**: `tools/scripts/calendar_importer.py`

現在のマッピング (66-71行目):
```python
EVENT_TYPE_MAPPING = {
    'event': 1,
    'goods': 2,
    'campaign': 3,
    'others': 4,
}
```

collaborationのマッピングが必要。

#### news_importer.py
**ファイルパス**: `tools/scripts/news_importer.py`

現在のマッピング (66-73行目):
```python
CATEGORY_MAPPING = {
    'グッズ': 1,
    'コラボ': 2,
    'イベント': 3,
    'メディア': 4,
    'キャンペーン': 5,
    'その他': 6,
}
```

既にコラボ (collaboration) のマッピングが存在している。

#### CSVデータの使用状況
**tools/data/news.csv**: 複数のレコードで「コラボ」カテゴリが使用されている
- 例: 「味ぽんとコラボ！」「白猫プロジェクト×ホロライブ コラボ」など

**tools/data/calendar_events.csv**: collaborationタイプはまだ使用されていない

### 4. フロントエンド層の調査

#### 型定義
**frontend/src/features/calendar/types.ts**
```typescript
export interface EventType {
  id: number
  type: string
}
```

**frontend/src/features/news/types/types.ts**
```typescript
export interface NewsCategoryDto {
  id: number;
  name: string;
  sortOrder: number;
}
```

型定義は汎用的で、レコード追加による変更は不要。

#### 定数・ユーティリティ

**frontend/src/constants/newsCategories.ts**
```typescript
export enum NewsCategory {
  GOODS = 'goods',
  COLLABORATION = 'collaboration',  // 既に定義済み
  EVENT = 'event',
  MEDIA = 'media',
  CAMPAIGN = 'campaign',
  OTHERS = 'others'
}
```

**frontend/src/features/calendar/utils/eventTypeUtils.ts**
```typescript
export const getEventTypeLabel = (type: string): string => {
  switch (type) {
    case 'event':
      return 'イベント';
    case 'goods':
      return 'グッズ';
    case 'campaign':
      return 'キャンペーン';
    case 'others':
      return 'その他';
    // collaboration のケースがない
    default:
      return type;
  }
};
```

#### スタイル定義

**frontend/src/features/news/utils/categoryStyles.ts**
```typescript
// COLLABORATIONのスタイルが既に定義されている
case NewsCategory.COLLABORATION:
  return `bg-badge-green/20 text-badge-green border-badge-green/30...`;
```

**frontend/src/features/calendar/utils/eventBadgeStyles.ts**
```typescript
const EVENT_TYPE_COLOR_MAP: Record<string, BadgeColor> = {
  event: 'blue',
  goods: 'orange',
  campaign: 'green',
  others: 'gray'
  // collaboration がない
};
```

### 5. 技術的制約と可能性

#### 制約
1. event_typesテーブルのtypeカラムはUNIQUE制約あり
2. 既存のイベントタイプIDは固定されている (event:1, goods:2, campaign:3, others:4)
3. 新規追加の場合、IDはSERIALで自動採番される (次は5になる)

#### 可能性
1. マイグレーションファイルでのデータ投入は実績あり (campaign, othersの追加例)
2. フロントエンドのコード構造は拡張性が高く、新規タイプの追加は容易
3. ツールのマッピングもハードコードだが追加は簡単

### 6. 既存システムとの整合性

#### データ整合性
- news_categoriesのCOLLABORATIONは既に使用されており、問題なし
- event_typesへのcollaboration追加は既存データに影響なし
- 中間テーブル (event_event_types) の構造は変更不要

#### UI/UX整合性
- ニュースカテゴリのCOLLABORATIONバッジスタイルは緑色 (badge-green)
- カレンダーイベントタイプのcampaignバッジも緑色 (badge-green)
- 色の重複を避けるため、collaborationには別の色を割り当てるべき
- 推奨: purple (紫) または pink (ピンク)

## 実装方針

### 1. データベースマイグレーション

**ファイル**: `backend/src/main/resources/db/changelog/changes/032-add-collaboration-event-type.sql`

```sql
--liquibase formatted sql

--changeset shirogane:032-add-collaboration-event-type
--comment: Add collaboration event type to event_types table

-- コラボレーションタイプを追加
INSERT INTO event_types (type) VALUES ('collaboration');
```

### 2. ツール更新

**ファイル**: `tools/scripts/calendar_importer.py`

EVENT_TYPE_MAPPINGに追加:
```python
EVENT_TYPE_MAPPING = {
    'event': 1,
    'goods': 2,
    'campaign': 3,
    'others': 4,
    'collaboration': 5,  # 新規追加
}
```

### 3. フロントエンド更新

#### eventTypeUtils.ts
```typescript
export const getEventTypeLabel = (type: string): string => {
  switch (type) {
    case 'event':
      return 'イベント';
    case 'goods':
      return 'グッズ';
    case 'campaign':
      return 'キャンペーン';
    case 'collaboration':  // 追加
      return 'コラボ';
    case 'others':
      return 'その他';
    default:
      return type;
  }
};
```

#### eventBadgeStyles.ts
```typescript
const EVENT_TYPE_COLOR_MAP: Record<string, BadgeColor> = {
  event: 'blue',
  goods: 'orange',
  campaign: 'green',
  collaboration: 'purple',  // 新規追加 (緑との重複を避けるため紫を推奨)
  others: 'gray'
};
```

## リスク評価

### 低リスク
- news_categoriesテーブル: 変更なし、リスクゼロ
- event_typesテーブル: 新規レコード追加のみ、既存データに影響なし
- バックエンドエンティティ: 変更不要
- データベーススキーマ: 変更なし

### 中リスク
- フロントエンドのスタイル定義: 色の選択が重要
  - 既存の色 (blue, orange, green, gray) との差別化が必要
  - UIの一貫性を保つ必要がある
- ツールのマッピング: IDの自動採番に依存
  - collaboration が必ず id=5 になる保証はない (他のマイグレーションが先に実行される可能性)
  - get_event_type_mapping関数でデータベースから動的に取得するため問題なし

### 対策
1. フロントエンドのE2Eテストで新規バッジスタイルを確認
2. ツールのインポート機能をテストデータで検証
3. マイグレーション実行後、データベースの状態を確認

## 次フェーズ（Plan）への推奨事項

### 実装優先順位
1. バックエンドマイグレーション (最優先)
2. フロントエンドのユーティリティとスタイル更新
3. ツールのマッピング更新
4. E2Eテストでの動作確認

### 実装時の注意点
1. マイグレーションファイルの命名規則に従う (032-xxx.sql)
2. コミットメッセージに影響範囲を明記
3. フロントエンドのバッジ色は紫 (purple) を推奨
4. Playwright MCPツールでE2E動作確認を実施

### テスト計画
1. データベースマイグレーションの確認
   - event_typesテーブルに 'collaboration' が追加されていることを確認
   - IDが正しく採番されていることを確認
2. カレンダーインポータの動作確認
   - collaboration タイプのイベントをCSVから正常にインポートできることを確認
3. フロントエンドの表示確認
   - カレンダーページでcollaborationバッジが正しく表示されることを確認
   - バッジ色が適切に設定されていることを確認
   - フィルタリング機能が正常に動作することを確認

## 参考資料

### 調査対象ファイル一覧

#### データベース
- backend/src/main/resources/db/changelog/changes/004-create-news-tables.sql
- backend/src/main/resources/db/changelog/changes/013-insert-initial-news-categories.sql
- backend/src/main/resources/db/changelog/changes/021-create-calendar-tables.sql
- backend/src/main/resources/db/changelog/changes/022-add-campaign-event-type.sql
- backend/src/main/resources/db/changelog/changes/030-add-others-event-type.sql

#### バックエンド
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/CalendarEntities.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/NewsEntities.kt

#### ツール
- tools/scripts/calendar_importer.py
- tools/scripts/news_importer.py
- tools/data/calendar_events.csv
- tools/data/news.csv

#### フロントエンド
- frontend/src/types/index.ts
- frontend/src/features/calendar/types.ts
- frontend/src/features/news/types/types.ts
- frontend/src/constants/newsCategories.ts
- frontend/src/features/calendar/utils/eventTypeUtils.ts
- frontend/src/features/news/utils/categoryStyles.ts
- frontend/src/features/calendar/utils/eventBadgeStyles.ts

## 結論

### 実装の必要性
- news_categoriesテーブル: 実装不要 (既に存在)
- event_typesテーブル: 実装が必要

### 推奨アプローチ
1. マイグレーションファイルで event_types テーブルに 'collaboration' を追加
2. フロントエンドのユーティリティとスタイル定義を更新
3. ツールのマッピングを更新
4. E2Eテストで動作確認

### 実装難易度
- 低: 既存の実装パターンに従った単純な追加作業
- 所要時間: 1-2時間程度

### 次のアクション
Plan フェーズに進み、詳細な実装手順を策定する。