# BottomSheetスクロール高さ問題 - 調査報告書

**調査日時**: 2025-09-28 02:12:53
**調査者**: Claude Code
**対象ブランチ**: main

## 問題の概要

### 調査対象問題
スクロール発生時のBottomSheet高さ表示問題
- SongsのBottomSheetで顕著（コンテンツが長くスクロールが発生）
- BottomSheet自体が画面下端まで表示されていない
- URL等の下にBottomSheet下の画面が見えてしまう

### ユーザ報告内容
「Songsの検索ボトムシートはURLのからボトムシートの要素が表示されているが、ボトムシート自体が画面下端まで表示されていないため、URL等の下にボトムシート下の画面が見えてしまっている」

## 技術的調査結果

### 関連ファイル分析

#### 1. BottomSheet.tsx (メインコンポーネント)
**ファイルパス**: `/frontend/src/components/common/BottomSheet/BottomSheet.tsx`

**問題箇所**: 37行目の高さ計算
```tsx
const maxHeight = isLoaded ? getMaxHeight(64) : 'calc(100vh - 64px)';
```

**実装詳細**:
- ヘッダー分64pxを差し引いた高さを設定
- フォールバック値: `calc(100vh - 64px)`
- 実際の値: `getMaxHeight(64)` → `window.innerHeight - 64`

#### 2. useViewportHeight.ts (ビューポート管理)
**ファイルパス**: `/frontend/src/hooks/useViewportHeight.ts`

**実装内容**:
```tsx
const height = window.innerHeight;  // 11行目
```
- `window.innerHeight`を使用（ブラウザUI除く実際の表示領域）
- CSS変数`--viewport-height`も設定

#### 3. コンテンツ比較分析
**SongsBottomSheetContent**: 110行、複雑なフィルタ・検索機能でスクロール発生
**CalendarBottomSheetContent**: 25行、シンプルな構成でスクロール発生しにくい

### 根本原因の特定

**計算値の不整合**
1. **フォールバック値**: `calc(100vh - 64px)`
   - `100vh`は論理的なビューポート高さ（ブラウザUI含む）

2. **実際の値**: `window.innerHeight - 64`
   - `window.innerHeight`は物理的な表示領域（ブラウザUI除く）

**問題の発生メカニズム**:
- 初期表示時はフォールバック値で適切に表示
- `useViewportHeight`ロード後、`window.innerHeight`ベースの値に変更
- この差により、BottomSheetの高さが実際の表示可能領域より小さくなる
- 結果として、BottomSheetが画面下端まで届かない

### 技術的制約・整合性確認

#### 既存システムとの関係
1. **ResponsiveModal**: デスクトップ/モバイル切り替えでBottomSheetを使用
2. **PageLayout**: 統合されたレイアウトシステム
3. **CSS変数**: `--viewport-height`として他コンポーネントでも利用

#### 影響範囲
- useViewportHeight.tsは複数箇所で使用されているため、変更時は影響範囲を慎重に検討必要
- CSS変数との整合性も重要

## 解決方針

### 推奨解決策
**フォールバック値と実際値の一貫性確保**

**方法1**: フォールバック値をCSS変数ベースに変更
```tsx
const maxHeight = isLoaded ? getMaxHeight(64) : 'calc(var(--viewport-height) - 64px)';
```

**方法2**: useViewportHeight.tsでの計算ロジック統一
- `100vh`ベースの計算に統一
- または実際の`window.innerHeight`ベースに統一

### 実装の優先度
**高**: この問題はユーザビリティに直接影響し、特にSongsページで顕著

## 次フェーズへの推奨事項

### PLANフェーズで検討すべき項目
1. 具体的な修正方法の選択（方法1 vs 方法2）
2. useViewportHeight.ts変更時の影響範囲調査
3. CSS変数との整合性確保方法
4. 動作確認方法（playwright MCP使用）

### 実装時の注意点
- 他のBottomSheet使用箇所への影響確認
- デスクトップ/モバイル両方での動作確認
- 異なるブラウザでの表示確認

## 結論

**調査ステータス**: 完了
**実装推奨**: Yes
**次フェーズ**: PLAN

問題の根本原因を特定し、解決方針を明確化しました。実装により確実に問題解決が可能です。