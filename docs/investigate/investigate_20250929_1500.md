# 本番環境 CSS エラー調査報告書

## 調査概要
- **日時**: 2025年9月29日
- **調査者**: Claude Code
- **対象**: 本番環境での CSS SyntaxError (f2e89ef87fdc1daf.css:1)
- **制約**: Tailwind CSS v4を維持したまま対応

## 問題の詳細

### エラー情報
```
f2e89ef87fdc1daf.css:1 Uncaught SyntaxError: Invalid or unexpected token
```

### 症状
- 開発環境では正常動作
- 本番環境でのみ CSS ファイルで JavaScript 構文エラー発生
- CSSファイルがJavaScriptとして解釈される問題

## 技術調査結果

### 現在の技術スタック
- **Next.js**: 15.5.2
- **Tailwind CSS**: 4.1.13
- **PostCSS**: 8.5.6
- **@tailwindcss/postcss**: 4.1.13
- **デプロイ**: AWS Amplify

### 設定ファイル分析

#### package.json
```json
"devDependencies": {
  "@tailwindcss/postcss": "^4.1.13",
  "tailwindcss": "4.1.13",
  "postcss": "8.5.6"
}
```

#### postcss.config.js
```javascript
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
}
```

#### globals.css
- `@import "tailwindcss"` 使用（v4形式）
- カスタムCSS変数・アニメーション定義

### ローカルビルド検証
```
✓ Compiled successfully in 31.7s
css/f2e89ef87fdc1daf.css              159 kB
```
- ローカルでは正常にビルド完了
- 同一ファイル名で159KBのCSSファイル生成

## 根本原因分析

### 主要原因
**Next.js 15 + Tailwind CSS v4の本番ビルド互換性問題**
- 調査で確認された既知の問題パターン
- "Tailwind V4 at NextJS 15: working on dev but not on prod"
- 開発環境と本番環境でのCSS処理方式の違い

### 副次的要因

1. **依存関係配置問題**
   - tailwindcss関連パッケージがdevDependenciesに配置
   - 本番ビルド時の依存関係アクセス制限

2. **PostCSS Plugin移行**
   - Tailwind CSS v4ではPostCSS pluginが分離
   - `@tailwindcss/postcss`の使用が必要

3. **AWS Amplify ビルド環境**
   - 静的ファイル配信時のMIMEタイプ問題の可能性

## 解決方針

### 方針A: 依存関係修正（最優先・低リスク）
```json
"dependencies": {
  "tailwindcss": "4.1.13",
  "@tailwindcss/postcss": "4.1.13",
  "postcss": "8.5.6"
}
```

### 方針B: Next.js設定調整（中優先・中リスク）
- webpack設定でCSS処理最適化
- output設定の調整

### 方針C: AWS Amplify設定最適化（中優先・低リスク）
- amplify.ymlのビルド手順詳細化
- 静的ファイル配信設定調整

### 方針D: PostCSS設定微調整（低優先・低リスク）
- より明示的なPostCSS設定

## 実装計画

### Phase 1: 即座実行（高優先・低リスク）
1. package.jsonの依存関係修正
2. ローカル動作確認・テスト
3. AWS Amplify build設定最適化

### Phase 2: 段階的実装（中優先）
4. Next.js webpack設定調整
5. PostCSS設定微調整
6. 本番デプロイ検証

### Phase 3: 検証・最適化
7. 長期安定性確認
8. パフォーマンス最適化

## リスク評価

### 低リスク解決策
- ✅ 依存関係のdependencies移動
- ✅ AWS Amplify設定調整

### 中リスク解決策
- ⚠️ Next.js webpack設定変更
- ⚠️ PostCSS設定大幅変更

### 制約遵守
- ✅ Tailwind CSS v4維持
- ✅ 既存機能への影響最小化
- ✅ AWS Amplifyデプロイ環境維持

## 推奨アクション

1. **即座実行**: 依存関係修正によるクイック修正
2. **段階検証**: 各修正後の本番デプロイ確認
3. **継続監視**: 長期安定性の監視体制構築

## 技術的根拠

### 外部調査結果
- GitHub Issues: "Next JS 15 - Tailwind 4.0 - Failed Installation"
- Stack Overflow: 同様問題の報告多数
- 公式ドキュメント: v4移行ガイドの確認

### 互換性確認
- Browser Support: Safari 16.4+, Chrome 111+, Firefox 128+
- Next.js 15.5.2 with Tailwind CSS 4.1.13の組み合わせ対応確認

## 結論

**実装推奨**: 段階的アプローチで確実な問題解決が可能
- 根本原因: 既知のNext.js 15 + Tailwind CSS v4互換性問題
- 解決可能性: 高（複数の解決策を準備）
- リスク: 低〜中（段階的実装でリスク軽減）
- 制約遵守: 完全（Tailwind CSS v4維持）