# 調査報告書: カレンダーModalコンポーネントのリファクタリング

**日時:** 2025/09/25 01:42:36
**ブランチ:** feature/modal-refactor
**対象コンポーネント:** DayEventsModal, EventDetailModal

## 1. 調査背景

ユーザーからの要請により、DayEventsModalとEventDetailModalコンポーネントの責務分離とリファクタリングの必要性について調査を実施。

## 2. 現状分析

### 2.1 DayEventsModal (frontend/src/features/calendar/components/DayEventsModal.tsx)

**現在の責務:**
- 日付のフォーマット処理
- イベントのソート処理
- Modal表示の管理
- イベントリストの表示
- 空状態の処理

**問題点:**
- 単一コンポーネント内に複数の責務が混在
- 日付フォーマット処理がコンポーネント内にハードコード
- イベントソート処理が他のコンポーネントと重複

### 2.2 EventDetailModal (frontend/src/features/calendar/components/EventDetailModal.tsx)

**現在の責務:**
- イベントタイプのラベル変換
- 時刻のフォーマット処理
- Modal表示の管理
- イベント詳細の各種情報表示（タイトル、バッジ、画像、時刻、説明文）
- 戻るボタンの処理

**問題点:**
- コンポーネントが肥大化（151行）
- 複数の表示責務が単一コンポーネントに集約
- フォーマット処理やラベル変換が他コンポーネントと重複

### 2.3 関連コンポーネント

**EventListItem:**
- 同様のフォーマット処理とラベル変換処理を持つ
- DayEventsModalとDayEventsBottomSheetで使用

**DayEventsBottomSheet:**
- DayEventsModalとほぼ同じ日付フォーマット処理とソート処理を持つ
- モバイル版の実装

## 3. 技術的制約

- React/Next.js環境
- TypeScriptの使用
- 既存のModalコンポーネント（@/components/ui/Modal）を利用
- 既存のスタイルシステムとの整合性維持が必要

## 4. リファクタリング方針

### 4.1 共通処理の抽出

**ユーティリティ関数の作成:**
```
frontend/src/features/calendar/utils/
├── formatters.ts       # 日付・時間フォーマット処理
├── eventTypeUtils.ts   # イベントタイプ関連処理
└── eventSortUtils.ts   # イベントソート処理
```

### 4.2 DayEventsModalの分割案

```
components/modals/DayEventsModal/
├── index.tsx                   # エクスポート用
├── DayEventsModal.tsx          # メインコンテナ（Modal管理）
├── DayEventsHeader.tsx         # 日付表示ヘッダー
├── DayEventsList.tsx           # イベントリスト表示
└── EmptyEventsMessage.tsx      # 空状態メッセージ
```

### 4.3 EventDetailModalの分割案

```
components/modals/EventDetailModal/
├── index.tsx                   # エクスポート用
├── EventDetailModal.tsx        # メインコンテナ（Modal管理）
├── EventDetailHeader.tsx       # ヘッダー（戻るボタン含む）
├── EventTitle.tsx              # タイトルとバッジ表示
├── EventImage.tsx              # 画像表示ロジック
├── EventTimeInfo.tsx           # 時刻情報表示
└── EventDescription.tsx        # 説明文とリンク表示
```

### 4.4 カスタムフックの活用

```typescript
// useEventFormat.ts
export const useEventFormat = () => {
  const formatDate = (date: Date) => { ... }
  const formatTime = (time?: string) => { ... }
  return { formatDate, formatTime }
}

// useEventSort.ts
export const useEventSort = () => {
  const sortByTime = (events: Event[]) => { ... }
  return { sortByTime }
}
```

## 5. 実装計画

### フェーズ1: ユーティリティ層の構築
1. formatters.tsの作成（日付・時間フォーマット関数）
2. eventTypeUtils.tsの作成（ラベル変換、スタイル取得）
3. eventSortUtils.tsの作成（イベントソート処理）
4. カスタムフックの作成

### フェーズ2: DayEventsModalのリファクタリング
1. 子コンポーネントの作成
2. 責務の分離と移譲
3. ユーティリティ関数への置き換え
4. 動作確認

### フェーズ3: EventDetailModalのリファクタリング
1. 子コンポーネントの作成
2. 責務の分離と移譲
3. ユーティリティ関数への置き換え
4. 動作確認

### フェーズ4: 関連コンポーネントの更新
1. EventListItemの更新
2. DayEventsBottomSheetの更新
3. 重複コードの削除

### フェーズ5: テストと最終確認
1. 全体的な動作確認
2. Playwrightを使用したE2Eテスト
3. パフォーマンス確認

## 6. 期待される効果

### 保守性の向上
- 単一責任原則の遵守
- コンポーネントの理解しやすさ向上
- 変更時の影響範囲の限定

### 再利用性の向上
- 共通処理の一元化
- 重複コードの削除
- 新機能追加時の効率化

### テスタビリティの向上
- 小さな単位でのテスト可能
- ユーティリティ関数の単体テスト容易化
- モックの作成が容易

## 7. リスクと対策

### リスク
- 既存機能への影響
- スタイルの崩れ
- パフォーマンスの低下

### 対策
- 段階的なリファクタリング
- 各フェーズでの動作確認
- Playwrightによる自動テスト
- Git履歴による変更の追跡

## 8. 次のステップ（推奨事項）

**PLAN フェーズへの移行を推奨**

本調査により、リファクタリングの必要性と実現可能性が確認された。
次のPLANフェーズでは、具体的な実装手順の詳細化と、各コンポーネントの詳細設計を行う。

## 9. 結論

DayEventsModalとEventDetailModalは責務が多く、リファクタリングにより大幅な改善が見込める。
提案したアプローチにより、保守性、再利用性、テスタビリティの向上が期待できる。