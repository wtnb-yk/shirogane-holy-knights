# EventDetailModal ResponsiveModal対応 調査報告書

**調査日時**: 2025/09/26 14:30:21
**ブランチ**: feature/calendar-responsive-modal
**担当**: Claude Code

## 調査概要

### 目的
CalendarのEventDetailModalをResponsiveModalに変更し、モバイルではボトムシート、デスクトップではモーダルとして表示するよう改善する。

### 調査対象
- EventDetailModal（frontend/src/features/calendar/components/modals/EventDetailModal/）
- 参考実装：SongDetailModal（frontend/src/features/songs/components/modals/SongDetailModal.tsx）
- ResponsiveModalコンポーネント（frontend/src/components/ui/ResponsiveModal.tsx）

## 現状分析

### 1. 現在のEventDetailModal実装

**ファイル構成**:
```
frontend/src/features/calendar/components/modals/EventDetailModal/
├── EventDetailModal.tsx        # メインコンポーネント
├── EventDetailHeader.tsx       # ヘッダー（戻るボタン含む）
├── EventTitle.tsx             # タイトルとバッジ表示
├── EventImage.tsx             # イベント画像
├── EventTimeInfo.tsx          # 時間情報
├── EventDescription.tsx       # 説明文とリンク
└── index.tsx                  # エクスポート
```

**現在の問題点**:
- 固定のModal + ModalContentを使用
- 画面サイズに関係なく同じ表示方式
- モバイルでの使いやすさが劣る

**現在のプロパティ**:
```typescript
interface EventDetailModalProps {
  event: Event | null;
  isOpen: boolean;
  onClose: () => void;
  fromDayModal?: boolean;
  onBackToDayModal?: () => void;
}
```

### 2. 参考実装：SongDetailModal

**特徴**:
- ResponsiveModalを使用
- useViewportフックでデスクトップ（≥1024px）判定
- SSR対応：ハイドレーション完了まではデスクトップ表示
- shouldUseDesktopLayoutロジック実装済み
- モバイル専用レイアウト（SongDetailBottomSheetLayout）

**実装パターン**:
```typescript
const { isDesktop, isLoaded } = useViewport();
const shouldUseDesktopLayout = !isLoaded || isDesktop;

return (
  <ResponsiveModal
    isOpen={isOpen}
    onClose={onClose}
    title={shouldUseDesktopLayout ? song.title : ""}
    className={shouldUseDesktopLayout ? "space-y-4 sm:space-y-6" : ""}
  >
    {shouldUseDesktopLayout ? (
      // デスクトップレイアウト
    ) : (
      // モバイルレイアウト
    )}
  </ResponsiveModal>
);
```

### 3. ResponsiveModalの技術仕様

**基本動作**:
- 1024px以上：Modalコンポーネント使用
- 1024px未満：BottomSheetコンポーネント使用
- SSR対応：`isLoaded`フラグでハイドレーション完了判定

**プロパティ**:
```typescript
interface ResponsiveModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
  title?: ReactNode;
  className?: string;
}
```

## 技術的制約・可能性

### 制約
1. **既存プロパティの互換性維持**: fromDayModal, onBackToDayModal機能
2. **SSRハイドレーション対応必須**
3. **DynamicComponentsでの動的インポート対応済み**

### 可能性
1. **ResponsiveModal**: 既に実装済み、すぐに使用可能
2. **useViewportフック**: 既に実装済み
3. **内部コンポーネント**: 全てReactコンポーネント、再利用可能
4. **既存動作フロー**: 変更不要

## 既存システム整合性

### 使用箇所
- **calendar/page.tsx**: 直接インポートして使用
- **DynamicComponents.tsx**: 動的インポート定義済み（未使用）

### 動作フロー
1. **イベントクリック** → EventDetailModal表示
2. **fromDayModal機能** → DayEventsModalからの遷移時に戻るボタン表示
3. **イベント選択契機** → サイズに関係なくイベントクリック時に開く（要件通り）

## 問題の根本原因と解決方針

### 根本原因
- EventDetailModalが固定のModalコンポーネントを使用
- 画面サイズに応じた最適化がされていない

### 解決方針
1. **ResponsiveModalの採用**
   - Modal + ModalContent → ResponsiveModal
   - useViewportフック導入
   - SSRハイドレーション対応

2. **既存機能の完全継承**
   - fromDayModal機能維持
   - 全プロパティの互換性保持
   - 既存の内部コンポーネント再利用

3. **レイアウト最適化**
   - デスクトップ：現在のレイアウト維持
   - モバイル：必要に応じてBottomSheet最適化検討

## 実装アプローチ

### Phase 1: 基本実装
1. EventDetailModal.tsxの修正
   - ResponsiveModalへの置き換え
   - useViewportフック導入
   - shouldUseDesktopLayoutロジック実装

2. 既存機能の確保
   - fromDayModal機能の互換性確認
   - 全プロパティの動作確認

### Phase 2: 最適化（必要に応じて）
1. モバイル専用レイアウトの検討
2. BottomSheet向けのコンポーネント最適化

## リスク分析

### 低リスク
- ResponsiveModal：既に安定稼働
- 内部コンポーネント：変更不要
- プロパティ互換性：維持可能

### 注意点
- SSRハイドレーション：適切な実装が必要
- fromDayModal機能：動作確認必須

## 推奨実装順序

1. **EventDetailModal.tsx修正**
   - ResponsiveModalへの置き換え
   - useViewportフック導入

2. **動作確認**
   - デスクトップでのモーダル表示
   - モバイルでのボトムシート表示
   - fromDayModal機能の互換性

3. **最適化検討**
   - 必要に応じてモバイル専用レイアウト追加

## 結論

**実装推奨度**: 高
**実装難易度**: 低
**リスク**: 低
**効果**: 高（モバイルUX向上）

ResponsiveModalへの変更は技術的に問題なく、既存機能との互換性も維持可能。SongDetailModalのパターンを参考に実装することで、安全かつ効果的な改善が期待できる。