# 調査報告: カレンダー画面イベント表示位置バグ

## 調査情報
- 日時: 2025-10-14 14:01:08
- ブランチ: fix/calendar-event-layout-padding
- 担当: Claude Code

## 問題の概要

カレンダー画面において、10月16日に予定が1つしかないにもかかわらず、2段目に表示されるバグが発見されました。

## 調査内容

### 1. バグの再現確認

Playwright MCP ツールを使用してカレンダー画面にアクセスし、10月16日の表示を確認しました。

**確認されたイベントデータ:**
- 10月1日: ボイスアーカイブ再販開始（単日イベント）
- 10月9日: 「ホロライブとなりの席ボイス」ボイス販売開始（単日イベント）
- 10月13-15日: 「妖怪ウォッチ ぷにぷに」コラボリポストキャンペーン（複数日イベント）
- 10月16日: 「妖怪ウォッチ ぷにぷに」コラボ開始（単日イベント）
- 10月22日: おかしの国のホロライブファンタジー 連載開始（単日イベント）
- 10月31日: ちゃお12月号 発売（単日イベント）

**問題:**
10月16日には単日イベントが1つしかないにもかかわらず、2段目（下側）に表示されていました。

### 2. 根本原因の特定

**問題箇所:**
`frontend/src/features/calendar/components/calender/internals/WeekView.tsx:30,36`

**原因の詳細:**

1. **問題のあるコード（修正前）:**
```typescript
const layout = calculateWeekEventLayout(weekStartDate, weekEndDate, events);
const totalBandHeight = layout.maxLanes * (BAND_HEIGHT + BAND_MARGIN);

// すべての日付セルに同じ totalBandHeight を適用
<CalendarDateCell
  bandReservedHeight={totalBandHeight}
  // ...
/>
```

2. **なぜバグが発生するか:**
   - 週全体の最大レーン数（maxLanes）に基づいて `totalBandHeight` を計算
   - 10月13-15日に複数日イベントが存在するため、週全体の maxLanes=1
   - totalBandHeight = 1 * (24 + 4) = 28px
   - **すべての日付セルに28pxのパディングが適用される**
   - 結果: 16日には複数日イベントがないのに、28pxのパディングが適用され、単日イベントが2段目に表示される

3. **期待される動作:**
   - 16日には複数日イベントが存在しないため、bandReservedHeight=0px であるべき
   - 単日イベントは1段目（上部）から表示されるべき

### 3. 関連コードの分析

**weekEventLayout.ts の動作:**
- `calculateWeekEventLayout()` 関数が複数日イベントをレーンに配置
- 各レーンの衝突判定を行い、適切な laneIndex を割り当て
- 単日イベントは各日付セルで個別に管理

**CalendarDateCell.tsx の動作:**
- `bandReservedHeight` プロップで複数日イベント用のスペースを予約
- 単日イベントは予約スペースの下に表示される
- 問題: 予約スペースが週全体で固定されているため、複数日イベントがない日にも適用される

### 4. 技術的制約・可能性

**制約:**
- カレンダーのレイアウトは週単位で計算される
- 複数日イベントは EventBand コンポーネントで週全体に横断して表示される
- 単日イベントは CalendarDateCell コンポーネントで各日付に表示される

**解決の方向性:**
- 各日付セルについて、その日に実際に存在する複数日イベントの最大レーン数を個別に計算
- 複数日イベントが存在しない日は bandReservedHeight=0px にする

## 解決方針

### 修正内容

**WeekView.tsx に getBandReservedHeight 関数を追加:**

```typescript
// 各日付について、その日に存在する複数日イベントの最大レーン数を計算
const getBandReservedHeight = (dayIndex: number) => {
  const segmentsOnThisDay = layout.eventBands.filter(
    segment => dayIndex >= segment.startDayIndex && dayIndex <= segment.endDayIndex
  );

  if (segmentsOnThisDay.length === 0) return 0;

  const maxLaneOnThisDay = Math.max(...segmentsOnThisDay.map(s => s.laneIndex)) + 1;
  return maxLaneOnThisDay * (BAND_HEIGHT + BAND_MARGIN);
};
```

**各 CalendarDateCell に個別の bandReservedHeight を適用:**

```typescript
<CalendarDateCell
  bandReservedHeight={getBandReservedHeight(dayIndex)}
  // ...
/>
```

### 期待される効果

- 10月16日のようにイベントが存在しない日は、bandReservedHeight=0px となり、単日イベントが1段目に表示される
- 10月13-15日のように複数日イベントが存在する日は、適切なパディングが適用される
- 他の日付の表示に影響を与えない

## 実装結果

### 修正ファイル
- `frontend/src/features/calendar/components/calender/internals/WeekView.tsx`

### 動作確認

Playwright MCP ツールを使用して修正後の動作を確認しました。

**結果:**
- ✅ 10月16日の単日イベントが1段目（上部）に正しく表示される
- ✅ 複数日イベントが存在しない日には不要なパディングが適用されない
- ✅ 13-15日の緑色の複数日イベントは引き続き正しく表示される
- ✅ 他の日付の表示に影響なし

### 修正前後の比較

**修正前:**
- 10月16日: イベントが2段目に表示（不要なパディング28px）

**修正後:**
- 10月16日: イベントが1段目に表示（パディング0px）

## 次のステップ

1. ✅ ブランチ作成: `fix/calendar-event-layout-padding`
2. ✅ WeekView.tsx の修正
3. ✅ Playwright による動作確認
4. ✅ 調査結果ドキュメント作成
5. コミットして完了

## 結論

カレンダー画面の表示バグは、週全体の最大レーン数をすべての日付セルに適用していたことが原因でした。各日付セルについて個別にパディングを計算することで、正しい表示位置にイベントを配置できるようになりました。

修正は完了し、期待通りに動作することを確認しました。
