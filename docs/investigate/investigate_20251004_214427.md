# 調査報告書: ページング設定リファクタリング

## 調査日時
2025-10-04 21:44:27

## 調査対象
各機能のページング設定についてリファクタリングを実施し、メンテナンス性を向上させる

## 背景
現在、ページング設定（ページサイズ等）が各機能の複数箇所に散在しており、メンテナンス性が低い状態。
変更時に複数箇所の修正が必要で、不一致が発生するリスクがある。

## 調査結果

### 1. 現状の問題点

#### 1.1 設定が複数箇所に分散
各機能において、ページサイズの設定が以下の箇所に分散している：

**フロントエンド（各機能ごとに3-4箇所）：**
- Hookのデフォルト引数
- ページコンポーネントのHook呼び出し時
- Paginationコンポーネントへの渡し値

**バックエンド：**
- 各SearchParamsDtoのデフォルト値

#### 1.2 設定値の不一致

機能ごとの設定値の現状：

| 機能 | Hook内 | Page呼び出し | Pagination表示 | Backend | 状態 |
|------|--------|-------------|----------------|---------|------|
| Songs (Stream) | 12 | 20 | 12 | 20 | 不一致 |
| Songs (Concert) | 12 | 20 | 12 | 20 | 不一致 |
| News | 20 | 10 | 10 | 20 | 不一致 |
| Discography | 20 | 12 | 12 | 20 | 不一致（但し定数化済み） |
| Archives (Videos) | 20 | 20 | 20 | 20 | 一致（但し定数化なし） |
| Archives (Streams) | 20 | 20 | 20 | 20 | 一致（但し定数化なし） |

**検出された具体的な不一致：**

1. **Songs機能**
   - `useStreamSongs.ts:40` - pageSize = 12
   - `useConcertSongs.ts:40` - pageSize = 12
   - `page.tsx:29,33` - pageSize = 20（Hook呼び出し時）
   - `page.tsx:176` - pageSize = 12（Pagination表示時）
   - バックエンド: size = 20

2. **News機能**
   - `useNews.ts:37` - pageSize = 20
   - `page.tsx:31` - pageSize = 10（Hook呼び出し時）
   - `page.tsx:102` - pageSize = 10（Pagination表示時）
   - バックエンド: pageSize = 20

3. **Discography機能**
   - `useDiscography.ts:38` - pageSize = 20
   - `page.tsx:15` - PAGE_SIZE = 12（定数定義）
   - `page.tsx:37,119` - PAGE_SIZE使用（一貫性あり）
   - バックエンド: pageSize = 20

4. **Archives機能**
   - `useVideos.ts:42` - pageSize = 20
   - `useStreams.ts:42` - pageSize = 20
   - `page.tsx:23,24,145` - pageSize = 20
   - バックエンド: pageSize = 20
   - 一致しているが定数化されていない

#### 1.3 パラメータ名の不統一

**バックエンド:**
- AlbumSearchParamsDto: `pageSize`
- NewsSearchParamsDto: `pageSize`
- VideoSearchParamsDto: `pageSize`
- StreamSearchParamsDto: `pageSize`
- **SongSearchParamsDto: `size`** ← 不統一
- **StreamSongSearchParamsDto: `size`** ← 不統一

#### 1.4 メンテナンス性の課題
- ページサイズ変更時に複数ファイルの複数箇所を修正する必要
- 修正漏れや不一致に気づきにくい
- コードレビューで見逃されやすい
- フロント・バックエンド間でデフォルト値が異なる

### 2. バックエンドの現状詳細

#### 2.1 各SearchParamsDtoのデフォルト値

**AlbumSearchParamsDto (AlbumDto.kt:131):**
```kotlin
val pageSize: Int = 20
```

**NewsSearchParamsDto (NewsDto.kt:83):**
```kotlin
val pageSize: Int = 20
```

**VideoSearchParamsDto (VideoDto.kt:54):**
```kotlin
val pageSize: Int = 20
```

**StreamSearchParamsDto (VideoDto.kt:128):**
```kotlin
val pageSize: Int = 20
```

**SongSearchParamsDto (SongDto.kt:20):**
```kotlin
val size: Int = 20  // 注: pageSizeではなくsize
```

**StreamSongSearchParamsDto (SongDto.kt:39):**
```kotlin
val size: Int = 20  // 注: pageSizeではなくsize
```

#### 2.2 バックエンドの役割
- これらはフォールバック値として機能
- フロントエンドが常にpageSizeを明示的に指定
- 実際にはこれらのデフォルト値は使用されていないが、一致させるべき

### 3. 関連ファイルの詳細分析

#### 3.1 フロントエンド

**Songs機能:**
```
frontend/src/features/songs/
├── hooks/
│   ├── useStreamSongs.ts (pageSize: 12)
│   └── useConcertSongs.ts (pageSize: 12)
└── app/songs/page.tsx (pageSize: 20 / 12の混在)
```

**News機能:**
```
frontend/src/features/news/
├── hooks/
│   └── useNews.ts (pageSize: 20)
└── app/news/page.tsx (pageSize: 10)
```

**Discography機能:**
```
frontend/src/features/discography/
├── hooks/
│   └── useDiscography.ts (pageSize: 20)
└── app/discography/page.tsx (PAGE_SIZE: 12 - 定数化済み)
```

**Archives機能:**
```
frontend/src/features/archives/
├── hooks/
│   ├── useVideos.ts (pageSize: 20)
│   └── useStreams.ts (pageSize: 20)
└── app/archives/page.tsx (pageSize: 20)
```

#### 3.2 バックエンド

```
backend/src/main/kotlin/.../adapter/controller/dto/
├── AlbumDto.kt (pageSize: 20)
├── NewsDto.kt (pageSize: 20)
├── VideoDto.kt (pageSize: 20 × 2箇所)
└── SongDto.kt (size: 20 × 2箇所)
```

### 4. 解決方針

#### 4.1 リファクタリングアプローチ

**基本方針：**
1. フロントエンド: 各機能ごとに1箇所に定数をまとめ、全ての箇所から参照
2. バックエンド: デフォルト値をフロントエンドに合わせる
3. パラメータ名を統一（size → pageSize）

**実装対象機能：**
1. Songs（歌枠・ライブ）
2. News
3. Discography
4. Archives（Videos & Streams）

#### 4.2 推奨ページサイズ

| 機能 | 推奨ページサイズ | 理由 |
|------|-----------------|------|
| Songs | 20 | グリッドレイアウトとの親和性 |
| News | 12 | カード表示に最適 |
| Discography | 12 | アルバムアート表示に適切 |
| Archives | 20 | 動画サムネイル表示量 |

### 5. 実装計画

#### フェーズ1: バックエンド修正

**1.1 デフォルト値をフロントエンドに合わせる**
- `AlbumSearchParamsDto`: `pageSize = 20` → `12`
- `NewsSearchParamsDto`: `pageSize = 20` → `12`
- `VideoSearchParamsDto`: `pageSize = 20` (変更なし)
- `StreamSearchParamsDto`: `pageSize = 20` (変更なし)

**1.2 パラメータ名の統一 (size → pageSize)**
- `SongSearchParamsDto`: `size` → `pageSize` + `toPageRequest()`修正
- `StreamSongSearchParamsDto`: `size` → `pageSize` + `toPageRequest()`修正

#### フェーズ2: フロントエンド設定ファイル作成

各機能に`config/pagination.ts`を作成:

**features/songs/config/pagination.ts:**
```typescript
export const PAGINATION_CONFIG = {
  PAGE_SIZE: 20,
  INITIAL_PAGE: 1,
} as const;
```

**features/news/config/pagination.ts:**
```typescript
export const PAGINATION_CONFIG = {
  PAGE_SIZE: 12,
  INITIAL_PAGE: 1,
} as const;
```

**features/discography/config/pagination.ts:**
```typescript
export const PAGINATION_CONFIG = {
  PAGE_SIZE: 12,
  INITIAL_PAGE: 1,
} as const;
```

**features/archives/config/pagination.ts:**
```typescript
export const PAGINATION_CONFIG = {
  PAGE_SIZE: 20,
  INITIAL_PAGE: 1,
} as const;
```

#### フェーズ3: フロントエンド既存コード修正

**3.1 APIクライアント修正**
- Songs関連API: `size` → `pageSize` パラメータ名変更

**3.2 各機能の修正箇所**
各機能で以下を設定ファイル参照に変更:
1. Hook内のデフォルト値
2. ページコンポーネントのHook呼び出し
3. Paginationコンポーネントへの渡し値

#### フェーズ4: 動作確認
1. ビルド確認
2. Playwrightで各機能のページング動作確認

#### フェーズ5: ドキュメント作成
実装ガイドラインの作成

### 6. 期待される効果

1. **メンテナンス性向上**
   - 設定変更が1箇所で完結
   - 修正漏れのリスク排除

2. **一貫性向上**
   - フロント・バックエンド間で設定値が一致
   - パラメータ名の統一

3. **可読性向上**
   - 設定の意図が明確化
   - コードレビューが容易に

4. **品質向上**
   - 不一致の発生を防止
   - バグの混入リスク低減

### 7. リスク分析

#### 7.1 実装リスク
- **低**: 既存のパターンを踏襲するため技術的リスクは低い

#### 7.2 影響範囲リスク
- **中**: パラメータ名変更（size → pageSize）がある
- APIの互換性は維持されるが、テストが必要

#### 7.3 テストリスク
- **低**: E2Eテストで動作確認可能

## 次フェーズへの推奨事項

### 実装フェーズで実施すべき内容

1. **バックエンド修正**
   - DTOのデフォルト値修正
   - パラメータ名統一

2. **フロントエンド設定ファイル作成**
   - 各機能のconfig/pagination.ts作成

3. **フロントエンド既存コード修正**
   - Hook、ページコンポーネント、APIクライアントの修正

4. **動作確認**
   - PlaywrightによるE2Eテスト

5. **ドキュメント更新**
   - 実装ガイドラインの作成

## 結論

ページング設定の一元管理リファクタリングは、技術的に実現可能であり、メンテナンス性・一貫性向上の観点から実施を強く推奨する。
フロント・バックエンド双方の修正により、完全な一貫性を確保できる。

## 添付資料

### 関連ファイル一覧

#### フロントエンド
- `frontend/src/app/songs/page.tsx`
- `frontend/src/app/news/page.tsx`
- `frontend/src/app/discography/page.tsx`
- `frontend/src/app/archives/page.tsx`
- `frontend/src/features/songs/hooks/useStreamSongs.ts`
- `frontend/src/features/songs/hooks/useConcertSongs.ts`
- `frontend/src/features/news/hooks/useNews.ts`
- `frontend/src/features/discography/hooks/useDiscography.ts`
- `frontend/src/features/archives/hooks/useVideos.ts`
- `frontend/src/features/archives/hooks/useStreams.ts`

#### バックエンド
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/AlbumDto.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/NewsDto.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/VideoDto.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SongDto.kt`

---
作成日時: 2025-10-04 21:44:27
作成者: Claude Code (investigate phase)
ブランチ: feature/refactor-pagination-config
