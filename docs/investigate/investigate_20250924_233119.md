# 調査報告書 - CalendarBottomSheetContent SelectableList リファクタリング

## 調査概要
- **調査日**: 2025-09-24 23:31:19
- **ブランチ**: feature/calendar-selectable-list
- **対象**: `frontend/src/features/calendar/components/CalendarBottomSheetContent.tsx`のSelectableListリファクタリング
- **参考**: `frontend/src/components/common/YearPresetsSection.tsx`の実装パターン

## 現状分析

### CalendarBottomSheetContent.tsx の現在実装
- **機能**: イベントタイプの単一選択フィルタ
- **データ型**:
  - `EventType[]` (入力)
  - `number[]` (選択状態: selectedEventTypes)
- **選択ロジック**:
  - 同じタイプクリック → 選択解除
  - 異なるタイプクリック → そのタイプのみ選択
- **UI**: 独自実装（44行のコンポーネント、手動でbutton要素とスタイリング）

### SelectableList コンポーネント
- **機能**: 汎用的な選択可能リストコンポーネント
- **特徴**:
  - ジェネリック型T対応（型安全性）
  - 統一されたデザインシステム
  - アクセシビリティ対応（role, aria-selected）
  - ローディング状態対応
  - 柔軟な表示名・キー生成

### YearPresetsSection.tsx の参考パターン
- **実装**: SelectableList<YearItem>を使用
- **変換処理**: 年データ → YearItemオブジェクト
- **選択管理**: フィルタ状態との双方向バインディング

## 技術的制約・課題

### 1. データ型の適合
- **現在**: `selectedEventTypes: number[]`
- **必要**: `EventType` オブジェクトとの相互変換

### 2. 選択ロジックの違い
- **SelectableList**: 複数選択前提の設計
- **CalendarBottomSheet**: 単一選択の要求

### 3. 後方互換性
- 外部コンポーネントのインターフェース維持が必要
- `onEventTypeChange: (types: number[]) => void` の保持

## リファクタリング方針

### 1. SelectableList導入アプローチ
```typescript
SelectableList<EventType>({
  title: "タイプ",
  items: eventTypes,
  selectedItems: selectedEventTypeObjects,
  onItemToggle: handleEventTypeToggle,
  onClearAll: handleClearAll,
  getDisplayName: getEventTypeLabel,
  getItemKey: (eventType) => eventType.id,
  allOptionLabel: "全て"
})
```

### 2. 内部状態管理
- `selectedEventTypes: number[]` → `EventType[]` への内部変換
- 外部インターフェースは number[] を維持

### 3. 単一選択ロジック実装
```typescript
const handleEventTypeToggle = (eventType: EventType) => {
  if (selectedEventTypeObjects.some(selected => selected.id === eventType.id)) {
    // 選択解除
    onEventTypeChange([]);
  } else {
    // 単一選択
    onEventTypeChange([eventType.id]);
  }
};
```

## 期待される効果

### 1. コード品質向上
- 44行 → 約15行への削減
- 重複実装の排除
- 統一されたUI/UXパターン

### 2. 保守性向上
- SelectableListの共通改善がすべての使用箇所に適用
- デザインシステムとの一貫性

### 3. アクセシビリティ
- WAI-ARIA準拠の自動適用
- キーボードナビゲーション対応

## 実装リスク

### 1. 低リスク
- SelectableListの実装が安定している
- 型安全性が確保されている
- 既存の動作ロジックを維持可能

### 2. 注意点
- getEventTypeLabel関数の移行
- 選択状態の変換処理での型エラー回避

## 推奨事項

### PLAN フェーズで実装すべき内容:
1. **型定義の整備**: EventType変換ユーティリティ
2. **SelectableList導入**: CalendarBottomSheetContentの置き換え
3. **単体テスト**: 選択ロジックの動作確認
4. **E2Eテスト**: UI動作の回帰テスト

### 実装優先度: 高
- 既存機能への影響が限定的
- コード品質向上効果が大きい
- 技術的リスクが低い

## 結論

**実装推奨**: SelectableListへのリファクタリングは技術的に実現可能で、コード品質・保守性の大幅な改善が期待できる。既存の選択動作を完全に維持しながら、統一されたデザインシステムへの移行が可能。