# SPECIALS機能廃止 調査結果

調査日時: 2025-10-27 13:47:33
調査者: Claude Code
ブランチ: main (調査時点)

## 1. 調査対象・スコープ

SPECIALS機能の完全廃止に向けた影響範囲調査を実施しました。
調査対象は以下の4つのレイヤー：

- フロントエンド（React/Next.js）
- バックエンド（Kotlin/Spring）
- データベース（PostgreSQL + Liquibase）
- ツール・スクリプト（Python）

## 2. 関連ファイル一覧

### 2.1 フロントエンド（12ファイル）

#### ページコンポーネント（3ファイル）
- `frontend/src/app/specials/page.tsx` - SPECIALS一覧ページ
- `frontend/src/app/specials/[id]/page.tsx` - SPECIALS詳細ページ
- `frontend/src/app/specials/layout.tsx` - SPECIALSレイアウト

#### 機能モジュール（9ファイル）
- `frontend/src/features/specials/hooks/useSpecials.ts` - 一覧取得フック
- `frontend/src/features/specials/hooks/useSpecialEventDetail.ts` - 詳細取得フック
- `frontend/src/features/specials/api/specialClient.ts` - API クライアント
- `frontend/src/features/specials/types/types.ts` - 型定義
- `frontend/src/features/specials/components/grids/SpecialsGrid.tsx` - グリッド表示
- `frontend/src/features/specials/components/cards/SpecialEventCard.tsx` - カード表示
- `frontend/src/features/specials/components/cards/SkeletonSpecialEventCard.tsx` - スケルトン
- `frontend/src/features/specials/components/details/SpecialEventDetail.tsx` - 詳細表示
- `frontend/src/features/specials/components/messages/MessagesGrid.tsx` - メッセージグリッド
- `frontend/src/features/specials/components/messages/MessageCard.tsx` - メッセージカード
- `frontend/src/features/specials/components/cards/internals/SpecialEventCardDescription.tsx` - カード内部
- `frontend/src/features/specials/config/gridConfig.ts` - グリッド設定

#### 型定義の修正が必要なファイル（1ファイル）
- `frontend/src/types/index.ts` (68-73行目) - SPECIALS型エクスポートを削除

### 2.2 バックエンド（21ファイル + 1修正）

#### コントローラー層（2ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/SpecialsController.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/port/SpecialsUseCasePort.kt`

#### ユースケース層（1ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/application/usecase/SpecialsUseCaseImpl.kt`

#### ドメイン層（3ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEvent.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEventType.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/Message.kt`

#### リポジトリ層（4ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/SpecialEventRepository.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/MessageRepository.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/SpecialEventRepositoryImpl.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/MessageRepositoryImpl.kt`

#### クエリビルダー層（2ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/SpecialEventQueryBuilder.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/MessageQueryBuilder.kt`

#### マッパー層（2ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/SpecialEventRowMapper.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/MessageRowMapper.kt`

#### エンティティ層（3ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventEntities.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventTypeEntity.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/MessageEntity.kt`

#### DTO層（3ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDto.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDetailDto.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/MessageDto.kt`

#### その他（1ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/model/SpecialEventSearchCriteria.kt`

#### テスト（1ファイル）
- `backend/src/test/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouterSpecialsTest.kt`

#### ルーター修正が必要（1ファイル）
- `backend/src/main/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouter.kt`
  - 12行目: `import com.shirogane.holy.knights.adapter.controller.SpecialsController` を削除
  - 26行目: `private val specialsController: SpecialsController,` を削除
  - 99-101行目: `RouteKey("GET", "/specials")` ルート定義を削除
  - 131-136行目: `/specials/{eventId}` パスパラメータ処理を削除

### 2.3 データベース（4テーブル）

#### テーブル一覧
1. `special_events` - スペシャルイベント本体
2. `special_event_types` - イベントタイプマスタ
3. `special_event_special_event_types` - イベントとタイプの中間テーブル
4. `messages` - イベントに紐づくメッセージ

#### マイグレーションファイル（削除禁止）
- `backend/src/main/resources/db/changelog/changes/035-create-special-events-table.sql`
- `backend/src/main/resources/db/changelog/changes/036-create-special-event-types-tables.sql`

#### 必要な作業
- 新規マイグレーションファイル作成（037番以降）でテーブル削除を実行
- 既存マイグレーションファイルは履歴保持のため削除しない

### 2.4 ツール・スクリプト（2ファイル）

- `tools/scripts/special_events_importer.py` - CSVインポートスクリプト
- `tools/data/special_events.csv` - サンプルデータ

## 3. 機能フロー分析

### 3.1 SPECIALS一覧表示フロー
```
ユーザー
  ↓ /specials にアクセス
frontend/src/app/specials/page.tsx
  ↓ useSpecials フック呼び出し
frontend/src/features/specials/hooks/useSpecials.ts
  ↓ GET /specials API 呼び出し
frontend/src/features/specials/api/specialClient.ts
  ↓ HTTP リクエスト
ApiGatewayRouter (GET /specials)
  ↓
SpecialsController.getSpecialEvents()
  ↓
SpecialsUseCaseImpl.getSpecialEvents()
  ↓
SpecialEventRepository.findAll() / count()
  ↓
Database: special_events テーブル
```

### 3.2 SPECIALS詳細表示フロー
```
ユーザー
  ↓ /specials/{eventId} にアクセス
frontend/src/app/specials/[id]/page.tsx
  ↓ useSpecialEventDetail フック呼び出し
frontend/src/features/specials/hooks/useSpecialEventDetail.ts
  ↓ GET /specials/{eventId} API 呼び出し
frontend/src/features/specials/api/specialClient.ts
  ↓ HTTP リクエスト
ApiGatewayRouter (GET /specials/{eventId})
  ↓
SpecialsController.getSpecialEventDetails(eventId)
  ↓
SpecialsUseCaseImpl.getSpecialEventDetails()
  ↓
SpecialEventRepository.findById()
MessageRepository.findBySpecialEventId()
  ↓
Database: special_events, messages テーブル
```

## 4. 既存システムとの整合性確認

### 4.1 ナビゲーションメニュー
調査対象: `frontend/src/components/Header/internals/Navigation.tsx`

```typescript
const navigationItems: NavigationMenuItems[] = [
  { href: '/about', label: 'ABOUT' },
  { href: '/archives', label: 'ARCHIVE' },
  { href: '/songs', label: 'SONG' },
  { href: '/news', label: 'NEWS' },
  { href: '/calendar', label: 'CALENDAR' },
];
```

結果: `/specials` へのリンクは存在しない
影響: ナビゲーションメニューの修正は不要

### 4.2 他機能からの参照
調査範囲: フロントエンド全体、バックエンド全体

結果: SPECIALS機能は完全独立しており、他機能からの参照なし
影響: 他機能への影響なし

### 4.3 共通型定義
調査対象: `frontend/src/types/index.ts`

```typescript
export type {
  SpecialEventDto,
  MessageDto,
  SpecialEventDetailDto,
  SpecialEventSearchResultDto
} from '@/features/specials/types/types';
```

結果: SPECIALS関連型がエクスポートされている（68-73行目）
影響: この部分を削除する必要あり

## 5. 技術的制約・可能性

### 5.1 データベース制約
- Liquibaseによるマイグレーション管理を使用
- 既存マイグレーションファイルは削除禁止（履歴保持のため）
- 新規マイグレーション（037番以降）で DROP TABLE を実行する必要あり

### 5.2 外部キー制約
```sql
-- messages テーブル
FOREIGN KEY (special_event_id) REFERENCES special_events(id) ON DELETE CASCADE

-- special_event_special_event_types テーブル
FOREIGN KEY (special_event_id) REFERENCES special_events(id) ON DELETE CASCADE
FOREIGN KEY (special_event_type_id) REFERENCES special_event_types(id) ON DELETE RESTRICT
```

削除順序:
1. `messages`
2. `special_event_special_event_types`
3. `special_event_types`
4. `special_events`

### 5.3 ビルド・テスト影響
- バックエンド: Kotlinコンパイルエラーが発生する可能性（未使用import、依存注入エラー）
- フロントエンド: TypeScriptコンパイルエラーが発生する可能性（型定義エラー）
- テスト: ApiGatewayRouterSpecialsTest.kt が削除されるため、テストカバレッジ低下

## 6. 問題の根本原因・解決方針

### 6.1 廃止理由（推測）
- SPECIALS機能の利用頻度が低い
- メンテナンスコストに見合わない
- 他機能との統合が検討されている可能性

### 6.2 解決方針

#### フェーズ1: データベース削除
1. 新規マイグレーションファイル作成（037-drop-special-events-tables.sql）
2. 外部キー制約に従った順序でテーブル削除
3. マイグレーション実行テスト

#### フェーズ2: バックエンド削除
1. ApiGatewayRouter.kt からSPECIALS関連コードを削除
2. SPECIALS関連ファイル21個を削除
3. テストファイル削除
4. Kotlinコンパイル確認

#### フェーズ3: フロントエンド削除
1. `frontend/src/app/specials/` ディレクトリ削除
2. `frontend/src/features/specials/` ディレクトリ削除
3. `frontend/src/types/index.ts` から型エクスポート削除
4. TypeScriptコンパイル確認

#### フェーズ4: ツール削除
1. `tools/scripts/special_events_importer.py` 削除
2. `tools/data/special_events.csv` 削除

#### フェーズ5: 動作確認
1. バックエンドビルド＆テスト実行
2. フロントエンドビルド確認
3. Playwright E2Eテストで全体動作確認

## 7. 次フェーズ（Plan）への推奨事項

### 7.1 実装推奨理由
- 完全独立機能のため、他機能への影響リスクが極めて低い
- ナビゲーションメニューに含まれていないため、ユーザー影響が最小限
- 外部キー制約が明確で、安全な削除順序が確立されている

### 7.2 注意事項
- データベースマイグレーションは本番環境で不可逆的な変更となる
- 事前にデータバックアップを推奨
- ステージング環境での十分な検証が必要

### 7.3 推奨作業フロー
1. feature/remove-specials ブランチ作成
2. 段階的削除（DB → Backend → Frontend → Tools）
3. 各フェーズでビルド＆テスト確認
4. E2Eテスト実施
5. コードレビュー
6. ステージング環境デプロイ＆検証
7. 本番環境デプロイ

## 8. リスク評価

| リスク項目 | 発生確率 | 影響度 | 対策 |
|-----------|---------|-------|------|
| データベース削除の不可逆性 | 低 | 高 | 事前バックアップ、ステージング検証 |
| 他機能への意図しない影響 | 極低 | 中 | E2Eテスト実施 |
| ビルドエラー | 中 | 低 | 段階的削除、各フェーズでコンパイル確認 |
| ユーザー影響 | 極低 | 低 | ナビゲーションに含まれず、影響最小限 |

## 9. まとめ

SPECIALS機能は完全独立した機能であり、安全に削除可能です。
データベーステーブルは新規マイグレーションで削除し、既存マイグレーションファイルは履歴保持のため削除しません。
フロントエンド12ファイル、バックエンド21ファイル、ツール2ファイルの削除と、2ファイルの修正が必要です。

次フェーズのPlanでは、具体的な実装手順を策定し、段階的な削除を実施することを推奨します。