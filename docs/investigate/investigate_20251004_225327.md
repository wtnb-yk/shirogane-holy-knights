# event_typesに「その他（others）」追加の影響範囲調査結果

調査日時: 2025-10-04 22:53:27

## 調査概要
event_typesテーブルに新しいタイプ「その他（others）」を追加する際の、DB・バックエンド・フロントエンド・ツールへの影響範囲を調査しました。

## 影響範囲詳細

### 1. データベース（DBマイグレーション）
影響ファイル: 新規作成が必要
- `backend/src/main/resources/db/changelog/changes/030-add-others-event-type.sql`

現状:
- event_typesテーブル定義: `021-create-calendar-tables.sql:7-10`
  - id: SERIAL PRIMARY KEY
  - type: VARCHAR(30) NOT NULL UNIQUE
- 既存データ: 'event'(id=1), 'goods'(id=2), 'campaign'(id=3)

必要な対応:
```sql
INSERT INTO event_types (type) VALUES ('others');
```

技術的制約:
- VARCHAR(30)のため'others'（6文字）は問題なし
- SERIALによる自動採番でID=4が割り当てられる見込み
- ON DELETE RESTRICT制約により使用中typeは削除不可

### 2. バックエンド
影響: なし（修正不要）

理由:
- CalendarRepositoryImpl:64-73 で`findAllEventTypes()`がDBから動的取得
- EventType/EventTypeEntityはtype文字列を保持するのみ
- APIエンドポイント`GET /calendar/event-types`が自動的に新typeを返す

関連ファイル:
- `backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/Event.kt:43-46` (EventType定義)
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/CalendarRepositoryImpl.kt:64-73`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/CalendarController.kt:21-22`

### 3. フロントエンド
影響: 3ファイルの修正が必要

#### 3.1 イベントタイプラベル表示
ファイル1: `frontend/src/features/calendar/utils/eventTypeUtils.ts:1-12`
```typescript
// 現状: event, goods, campaign のみ対応
export const getEventTypeLabel = (type: string): string => {
  switch (type) {
    case 'event': return 'イベント';
    case 'goods': return 'グッズ';
    case 'campaign': return 'キャンペーン';
    default: return type;
  }
};
```
修正内容: `case 'others': return 'その他';` を追加

ファイル2: `frontend/src/components/Section/EventTypePresetsSection.tsx:19-30`
- 同じくgetEventTypeLabelが重複定義されている
- 同様の修正が必要

#### 3.2 バッジスタイル
ファイル3: `frontend/src/features/calendar/utils/eventBadgeStyles.ts:5-9`
```typescript
// 現状の色定義
const EVENT_TYPE_COLOR_MAP: Record<string, BadgeColor> = {
  event: 'blue',
  goods: 'orange',
  campaign: 'green'
};
```
修正内容: `others: 'purple'` (または適切な色) を追加

使用箇所:
- CalendarEventItem.tsx
- MobileEventCard.tsx
- EventTitle.tsx
- EventListItem.tsx

### 4. ツール（データインポート）
影響ファイル: `tools/scripts/calendar_importer.py`

現状 (66-70行目):
```python
EVENT_TYPE_MAPPING = {
    'event': 1,
    'goods': 2,
    'campaign': 3,
}
```

修正内容: `'others': 4` を追加
注意: IDは自動採番のため、マイグレーション実行後にDBで実際のIDを確認して更新

影響範囲:
- `get_event_type_mapping()` 関数がDBから動的取得するため、マッピングは自動更新される
- ただし、CSVで'others'を使用する場合は明示的な追加が推奨

### 5. データファイル
ファイル: `tools/data/calendar_events.csv`
- 現在、event_types列は'event', 'goods', 'campaign', 'event goods'（複数タイプ）を使用
- 'others'タイプのレコードは未存在
- 将来的に'others'を使用可能

## 技術的考察

### アーキテクチャの特徴
- バックエンド: 完全にDB駆動で新typeに自動対応
- フロントエンド: UI表示部分のみハードコード（ラベル・色）
- ツール: CSVインポート時の型変換マッピングが必要

### 既存システムとの整合性
- 複数event_type対応済み（event_event_types中間テーブル）
- newsカテゴリと同様のマスタテーブル方式
- APIレスポンスの後方互換性は保たれる

## 実装推奨事項

### 実装順序
1. DBマイグレーションファイル作成・実行
2. フロントエンド3ファイルの修正
3. ツールのマッピング更新
4. 動作確認（Playwright E2Eテスト）

### 動作確認項目
1. DBマイグレーション正常実行確認
2. `GET /calendar/event-types` APIで'others'取得確認
3. フロントエンドで「その他」ラベル表示確認
4. フィルタリング動作確認
5. バッジ色表示確認
6. CSVインポートで'others'タイプのイベント登録確認

### ブランチ戦略
- ブランチ名: `feature/add-others-event-type`
- ベースブランチ: `main`
- PR時の確認: 上記動作確認項目の完了

## 結論
- status: COMPLETED
- next: PLAN
- details: "調査完了。feature/add-others-event-typeブランチ作成推奨。実装方針策定を推奨。"
