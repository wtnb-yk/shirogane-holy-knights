# Special Events Importer 実装調査

## 調査日時
2025-10-17 14:13

## 調査対象
ツールにspecial_eventsのインポーターを追加する

## 背景
現在、バックエンドにspecial_eventsテーブルとAPIエンドポイントが実装されているが、データをインポートするツールが存在しない。既存のインポーターパターンに従い、CSVからデータベースへのインポート機能を追加する必要がある。

## 調査結果

### 1. データベース構造

#### テーブル定義 (backend/src/main/resources/db/changelog/changes/035-create-special-events-table.sql)
```sql
CREATE TABLE special_events (
    id UUID PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### インデックス
- idx_special_events_start_date
- idx_special_events_end_date
- idx_special_events_title
- idx_special_events_date_range

#### 制約
- CHECK制約: end_date > start_date

### 2. ドメインモデル

#### SpecialEvent (backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEvent.kt)
```kotlin
data class SpecialEvent(
    val id: SpecialEventId,
    val title: String,
    val description: String,
    val startDate: LocalDate,
    val endDate: LocalDate,
    val status: SpecialEventStatus
)

enum class SpecialEventStatus {
    UPCOMING,
    ACTIVE,
    ENDED
}
```

注: statusは計算フィールドで、現在日時とstart_date/end_dateの比較により決定される

### 3. 既存インポーターパターン分析

#### 調査対象インポーター
- tools/scripts/albums_importer.py
- tools/scripts/calendar_importer.py
- tools/scripts/news_importer.py

#### 共通パターン
1. **環境設定**
   - ENV_FILE環境変数で設定ファイルを指定
   - config/.env.{local,dev,prd} から接続情報を読み込み
   - DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD

2. **データベース接続**
   - psycopg2-binary を使用
   - localhost は 127.0.0.1 に変換（IPv6エラー回避）
   - connect_timeout=10

3. **データ処理**
   - pandas でCSVファイルを読み込み
   - UUID自動生成（uuid.uuid4()）
   - 日付/時刻の柔軟なパース
   - バリデーション処理

4. **インポート処理**
   - UPSERT機能（ON CONFLICT ... DO UPDATE）
   - execute_batch による一括処理
   - トランザクション管理（commit/rollback）

5. **検証機能**
   - インポート前後のレコード数確認
   - 最新データのサンプル表示

#### calendar_importer.pyとの類似点
special_eventsとcalendar_eventsは構造が類似しているため、calendar_importer.pyをベースにするのが適切:
- 両方とも日付範囲を持つ
- タイトル、説明、開始日、終了日のフィールド構成が類似
- TIMESTAMPデータ型を使用

### 4. justfile統合パターン

#### 既存コマンド例
```justfile
# ニュースデータインポート
news-import-local:
    cd scripts && ENV_FILE=../config/.env.local python3 news_importer.py

news-import-dev:
    cd scripts && ENV_FILE=../config/.env.dev python3 news_importer.py

news-import-prd:
    cd scripts && ENV_FILE=../config/.env.prd python3 news_importer.py
```

全てのインポーターが local/dev/prd の3環境をサポートしている。

### 5. データディレクトリ構成

tools/data/ 配下に以下のファイルが存在:
- albums.csv
- calendar_events.csv
- news.csv
- music_videos.csv
など

新規追加予定: special_events.csv

### 6. CSVフォーマット設計

#### 必須カラム
- title: イベントタイトル
- start_date: 開始日（YYYY-MM-DD形式推奨）
- end_date: 終了日（YYYY-MM-DD形式推奨）

#### オプションカラム
- description: イベント説明

#### サンプルデータ
```csv
title,description,start_date,end_date
2025年新春キャンペーン,新春特別企画です,2025-01-01,2025-01-15
バレンタインイベント,バレンタイン限定イベント,2025-02-10,2025-02-14
```

### 7. 技術的制約と考慮事項

#### データベース制約
- start_date と end_date の関係: end_date > start_date
- title は NOT NULL かつ最大255文字
- description は TEXT型（制限なし）

#### 日付フォーマット対応
複数の日付フォーマットをサポートする必要がある:
- YYYY-MM-DD
- YYYY/MM/DD
- MM/DD/YYYY
- DD/MM/YYYY

calendar_importer.pyのparse_date関数を再利用可能。

#### タイムゾーン
- データベースにはTIMESTAMP型で保存
- アプリケーションではLocalDateとして扱う
- インポート時はUTCタイムスタンプとして扱うか、日付の00:00:00として扱うか要検討
  → calendar_importer.pyの実装を参考にする

### 8. 既存システムとの整合性

#### バックエンドAPI
- GET /api/specials - 一覧取得
- GET /api/specials/{id} - 詳細取得

実装済み:
- SpecialsController
- SpecialEventRepository
- SpecialEventRepositoryImpl
- SpecialEventQueryBuilder
- SpecialEventRowMapper

#### フロントエンド
- frontend/src/features/specials/hooks/useSpecials.ts

既にspecial_eventsテーブルからデータを取得する機能が実装されているため、インポーターで追加したデータは即座にフロントエンドで表示可能。

### 9. 実装方針

#### 実装するファイル
1. **tools/scripts/special_events_importer.py**
   - calendar_importer.py をベースに作成
   - 以下の関数を実装:
     - load_env_file(): 環境変数読み込み
     - get_db_connection(): DB接続取得
     - parse_date(): 日付解析
     - generate_event_id(): UUID生成
     - read_special_events_csv(): CSV読み込み
     - validate_and_prepare_data(): データ検証
     - import_special_events_data(): データインポート
     - verify_import(): 結果検証
     - clear_existing_data(): 既存データ削除（オプション）
     - main(): メイン処理

2. **tools/data/special_events.csv**
   - サンプルデータを含むテンプレートファイル
   - ヘッダー: title,description,start_date,end_date

3. **tools/justfile**
   - special-events-import-local コマンド追加
   - special-events-import-dev コマンド追加
   - special-events-import-prd コマンド追加

4. **tools/README.md** (オプション)
   - 新しいコマンドの使用方法を追加

#### UPSERT戦略
```sql
INSERT INTO special_events (id, title, description, start_date, end_date)
VALUES (%s, %s, %s, %s, %s)
ON CONFLICT (id)
DO UPDATE SET
    title = EXCLUDED.title,
    description = EXCLUDED.description,
    start_date = EXCLUDED.start_date,
    end_date = EXCLUDED.end_date,
    updated_at = CURRENT_TIMESTAMP
```

#### 日時変換ロジック
CSV内の日付文字列（YYYY-MM-DD）をTIMESTAMP型に変換:
- 開始日: 当日の00:00:00 UTC
- 終了日: 当日の23:59:59 UTC または翌日の00:00:00 UTC

calendar_importer.pyでは日付のみを保存しているため、同様のアプローチを採用。

### 10. リスクと対策

#### リスク1: 日付バリデーション
- 問題: start_date > end_date のデータがCSVに含まれる可能性
- 対策: インポート前にPythonレベルでバリデーション実施

#### リスク2: 重複データ
- 問題: 同じイベントが複数回インポートされる可能性
- 対策: タイトルと日付の組み合わせで重複チェックを行うか、UUIDベースのUPSERT

#### リスク3: 既存データの上書き
- 問題: 既存データが意図せず上書きされる可能性
- 対策:
  - UPSERTによる既存ID上書きを許可
  - または新規データのみを追加するINSERT ... ON CONFLICT DO NOTHING

calendar_importer.pyは全削除+再インポート戦略を採用しているため、同様のアプローチも検討。

### 11. テスト計画

#### 単体テスト項目
1. CSV読み込み機能
   - 正常系: 有効なCSVファイル
   - 異常系: ファイルが存在しない
   - 異常系: 空のCSVファイル
   - 異常系: カラムが不足

2. 日付パース機能
   - 各種日付フォーマットの正常パース
   - 無効な日付フォーマットのエラーハンドリング

3. データバリデーション
   - 必須フィールドのチェック
   - 日付順序のチェック（start_date < end_date）

4. データベースインポート
   - 新規データの追加
   - 既存データの更新（UPSERT）

#### 統合テスト項目
1. local環境でのインポート実行
2. インポート後のAPIでのデータ確認
3. フロントエンドでの表示確認

### 12. 次フェーズへの推奨事項

#### PLAN フェーズで実施すべきこと
1. 詳細な実装計画の作成
2. サンプルデータの準備
3. エラーハンドリングの詳細設計

#### IMPLEMENT フェーズで実施すべきこと
1. special_events_importer.py の実装
2. special_events.csv の作成
3. justfile への統合
4. README.md の更新

#### TEST フェーズで実施すべきこと
1. local環境でのテスト実行
2. サンプルデータでのインポート確認
3. API経由でのデータ取得確認
4. フロントエンドでの表示確認

#### REVIEW フェーズで実施すべきこと
1. コードレビュー
2. パフォーマンステスト
3. ドキュメントの最終確認

## 結論

### 実装可否判定
**実装推奨** - 既存のインポーターパターンが確立されており、special_eventsテーブルも実装済みのため、実装に必要な情報は全て揃っている。

### 推奨実装アプローチ
1. calendar_importer.py をベースに special_events_importer.py を作成
2. 日付パース機能を再利用
3. UUIDによるUPSERT戦略を採用
4. 環境別実行（local/dev/prd）をサポート

### 見積もり工数
- スクリプト作成: 2-3時間
- テストデータ準備: 30分
- justfile統合: 15分
- テスト実行: 1時間
- ドキュメント作成: 30分

**合計**: 約4-5時間

### 次のステップ
1. feature/special-events-importer ブランチを作成
2. PLAN フェーズに移行し、詳細な実装計画を策定
3. IMPLEMENT フェーズで実装を実施

## 参考ファイル

### 主要参照ファイル
- backend/src/main/resources/db/changelog/changes/035-create-special-events-table.sql
- backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEvent.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventEntities.kt
- tools/scripts/calendar_importer.py
- tools/scripts/albums_importer.py
- tools/justfile

### 関連ドキュメント
- .kiro/specs/specials-feature/tasks.md
- tools/README.md
