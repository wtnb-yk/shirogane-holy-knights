# 調査レポート: album_tracksテーブルへのartistカラム追加

## 調査日時
2025-10-16 11:05:45

## 調査対象
album_tracksテーブルにartistカラムを追加し、Discography機能とCSVインポートツールを改修する。

## 現状分析

### 1. データベース構造

#### 現在のalnum_tracksテーブル構造
ファイル: `backend/src/main/resources/db/changelog/changes/025-restructure-album-tables.sql`

```sql
CREATE TABLE album_tracks
(
    id           VARCHAR(255) PRIMARY KEY,
    album_id     VARCHAR(255) NOT NULL REFERENCES albums (id) ON DELETE CASCADE,
    song_id      UUID NOT NULL REFERENCES songs (id) ON DELETE CASCADE,
    track_number INTEGER NOT NULL,
    created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (album_id, song_id)
);
```

**問題点:**
- `artist` カラムが存在しない
- 現在は `songs` テーブルからアーティスト情報を取得している

### 2. バックエンド実装

#### AlbumQueryBuilder.kt (Line 30, 80)
現在のクエリ:
```kotlin
CONCAT(s.id, ':', s.title, ':', s.artist, ':', atr.track_number)
```

- `songs` テーブルの `s.artist` からアーティスト情報を取得
- `album_tracks` と `songs` を JOIN している

#### AlbumRowMapper.kt (Line 37-59)
```kotlin
private fun parseTracks(tracksStr: String): List<AlbumTrack> {
    // parts[2] でアーティスト情報を取得
    AlbumTrack(
        songId = SongId(parts[0]),
        title = parts[1],
        artist = parts[2],  // <- songs.artist から取得
        trackNumber = parts[3].toInt()
    )
}
```

#### ドメインモデルとDTO
- `Album.kt` の `AlbumTrack` データクラス: `artist: String` フィールドあり
- `AlbumDto.kt` の `AlbumTrackDto`: `artist: String` フィールドあり

**既にドメインモデルとDTOは対応済み**

### 3. フロントエンド実装

#### AlbumTrackList.tsx (Line 19-20)
```tsx
<div className="text-xs sm:text-sm text-text-secondary truncate">
  {track.artist}
</div>
```

**既にUI表示は対応済み**

### 4. データソース

#### albums.csv
```csv
title,artist,album_type,release_date,cover_image_url,track_number,song_title
のえさんぽ,白銀ノエル,Album,2023-11-25,/albums/...,1,ほめのび
```

- `artist` カラムはアルバムレベルの情報
- 各行に同じアーティスト名が記載されている
- 例: 「白銀ノエル」「不知火建設」「Various Artists」など

#### album_track_releases.csv
- ファイルは空（0行）
- 現時点では使用されていない

#### albums_importer.py (Line 224-241)
現在の実装:
```python
# アルバムトラック情報をインサート
track_id = str(uuid.uuid4())
cursor.execute("""
    INSERT INTO album_tracks (id, album_id, song_id, track_number)
    VALUES (%s, %s, %s, %s)
""", (
    track_id,
    album_id,
    song_id,
    track['track_number']
))
```

**問題点:**
- `artist` カラムへのINSERTがない
- CSVの `artist` 情報が使われていない

## 技術的制約と可能性

### 制約
1. 既存データは削除可能（ユーザー指示）
2. `artist` カラムは NOT NULL制約
3. カラム順序: `song_id` の次に `artist` を配置

### 可能性
1. テーブル再作成で順序制御可能
2. CSVデータに必要な情報は揃っている
3. バックエンド・フロントエンドは既に対応済み

## 既存システムとの整合性

### 影響範囲
1. **データベース**: マイグレーション必要
2. **バックエンドクエリ**: AlbumQueryBuilder.ktの修正必要
3. **インポートツール**: albums_importer.pyの修正必要
4. **フロントエンド**: 修正不要（既に対応済み）
5. **ドメインモデル/DTO**: 修正不要（既に対応済み）

## 根本原因と解決方針

### 根本原因
- album_tracksテーブル設計時に、アーティスト情報をsongsテーブルに依存させる設計を採用
- しかし、実際のデータではアルバムごとにアーティストが異なる（コンピレーションアルバムなど）

### 解決方針
1. **データベース変更**: album_tracksテーブルにartistカラムを追加
2. **クエリ変更**: songsテーブルではなくalbum_tracksテーブルからartistを取得
3. **データ投入**: CSVのartist情報を各トラックに設定

## 実装計画概要

### 1. データベースマイグレーション
- 新規ファイル: `034-add-artist-to-album-tracks.sql`
- album_tracksテーブルを DROP して再作成
- カラム順序: id, album_id, song_id, artist, track_number, created_at

### 2. バックエンド修正
- `AlbumQueryBuilder.kt`:
  - `s.artist` を `atr.artist` に変更
  - songs JOINは維持（song_id参照のため）

### 3. インポートツール修正
- `albums_importer.py`:
  - INSERT文に `artist` カラムを追加
  - CSVの `artist` 値を使用

### 4. 動作確認
- PlaywrightでDiscographyページの表示確認
- トラックリストのアーティスト表示確認

## リスクと注意点

### リスク
1. 既存データ削除（許容済み）
2. songs.artist との不整合（TODO値が残る可能性）

### 注意点
1. マイグレーション実行順序の確保
2. インデックス再作成の確認
3. 外部キー制約の維持

## 次フェーズへの推奨事項

### PLANフェーズで決定すべき事項
1. マイグレーションファイルの詳細設計
2. ロールバック戦略
3. テストケースの定義
4. デプロイ手順

### IMPLEMENTフェーズでの作業
1. マイグレーションファイル作成
2. バックエンドコード修正
3. インポートツール修正
4. E2Eテスト実行
5. 動作確認

## 添付資料

### 関連ファイル
- データベース: `backend/src/main/resources/db/changelog/changes/025-restructure-album-tables.sql`
- クエリビルダー: `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumQueryBuilder.kt`
- RowMapper: `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/AlbumRowMapper.kt`
- インポートツール: `tools/scripts/albums_importer.py`
- CSVデータ: `tools/data/albums.csv`
- UI コンポーネント: `frontend/src/features/discography/components/AlbumTrackList.tsx`

### データサンプル
```csv
のえさんぽ,白銀ノエル,Album,2023-11-25,/albums/...,1,ほめのび
SPOTLIGHT vol.2,Various Artists,Compilation,2022-01-26,/albums/...,9,ハロ／ハワユ
```

## 結論
album_tracksテーブルへのartistカラム追加は技術的に実現可能。既存の実装はほぼ対応済みで、データベース変更とクエリ修正、インポートツール修正のみで対応可能。次のPLANフェーズで詳細な実装計画を策定することを推奨。