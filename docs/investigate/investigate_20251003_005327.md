# Specials機能コンポーネントリファクタリング調査報告

## 調査日時
2025-10-03 00:53:27

## 調査対象
frontend/src/features/specials/componentsのコンポーネント分割と設計改善

## 調査範囲

### 対象ファイル
- `frontend/src/features/specials/components/SpecialsGrid.tsx`
- `frontend/src/app/specials/page.tsx`

### 参照した他機能
- `frontend/src/features/news/components/`
- `frontend/src/features/archives/components/`
- `frontend/src/features/calendar/components/`

## 現状分析

### 既存の構造
```
frontend/src/features/specials/
├── api/
│   └── specialClient.ts
├── components/
│   └── SpecialsGrid.tsx (68行、全てのUIロジックが集約)
├── hooks/
│   └── useSpecials.ts
└── types/
    ├── index.ts
    └── types.ts
```

### 問題点

1. コンポーネントの分割不足
   - `SpecialsGrid.tsx`に全てのUIロジックが埋め込まれている
   - カードコンポーネント、ステータスバッジなどが分離されていない
   - 再利用性が低い

2. ディレクトリ構造の不足
   - `cards/`, `grids/`, `internals/`ディレクトリが存在しない
   - 他機能との一貫性がない

3. デザインパターンの未適用
   - `InteractiveCard`や`StaggeredItem`などの既存コンポーネントを活用していない
   - パフォーマンス最適化（`React.memo`, `useCallback`, `useMemo`）が不足

4. 設計ドキュメントとの乖離
   - `.kiro/specs/specials-feature/design.md`で定義されているコンポーネントが未実装
   - `SpecialEventCard`、`CountdownTimer`などの言及があるが未実装

## 他機能のベストプラクティス

### News機能の構造
```
frontend/src/features/news/components/
├── cards/
│   ├── NewsCard.tsx (React.memo使用、InteractiveCard + StaggeredItem)
│   ├── SkeletonNewsCard.tsx
│   └── internals/
│       ├── NewsCardBody.tsx
│       ├── NewsCardImage.tsx
│       └── NewsCardMeta.tsx
├── grids/
│   ├── NewsGrid.tsx (useCallback, useMemoで最適化)
│   └── internals/
│       └── NewsListGrid.tsx (グリッド基盤コンポーネント)
└── ...
```

### Archives機能の構造
```
frontend/src/features/archives/components/
├── cards/
│   ├── StreamCard.tsx (variant対応: default, featured, pickup)
│   ├── VideoCard.tsx
│   ├── SkeletonCard.tsx
│   └── internals/
│       ├── ArchiveCardBadge.tsx
│       ├── ArchiveCardImage.tsx
│       ├── ArchiveCardOverlay.tsx
│       └── ArchiveCardTags.tsx
├── grids/
│   ├── StreamsGrid.tsx
│   ├── VideosGrid.tsx
│   └── internals/
│       └── SpecialGrid.tsx
└── ...
```

### 共通パターン
1. **カードコンポーネント**
   - `InteractiveCard` + `StaggeredItem`を使用
   - `React.memo`で最適化
   - internalsに小コンポーネントを配置

2. **グリッドコンポーネント**
   - `useCallback`でrenderItem, renderSkeletonを定義
   - `useMemo`でemptyMessageを定義
   - internalsにグリッド基盤コンポーネントを配置

3. **最適化手法**
   - コンポーネントのメモ化
   - コールバックのメモ化
   - 不要な再レンダリングの防止

## 技術的制約

### 利用可能な共通コンポーネント
- `InteractiveCard`: クリック可能なカード基盤
- `StaggeredItem`: アニメーション付きアイテム
- `LoadingState`: ローディング表示
- `ErrorDisplay`: エラー表示

### スタイリング規則
- Tailwind CSSを使用
- カラーパレット: `bg-bg-primary`, `text-text-primary`, `accent-green`, `accent-blue`など
- レスポンシブ: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`パターン

### パフォーマンス要件
- React.memoによるメモ化
- useCallbackでコールバックの再生成を防止
- useMemoで計算結果のキャッシュ

## 解決方針

### アーキテクチャ設計

#### ディレクトリ構造
```
frontend/src/features/specials/components/
├── cards/
│   ├── SpecialEventCard.tsx
│   ├── SkeletonSpecialEventCard.tsx
│   └── internals/
│       ├── SpecialEventCardDescription.tsx
│       └── SpecialEventStatusBadge.tsx
└── grids/
    ├── SpecialsGrid.tsx
    └── internals/
        └── SpecialsListGrid.tsx
```

#### コンポーネント設計

##### SpecialEventCard
- 責務: 単一のイベントカード表示
- 使用コンポーネント: `InteractiveCard`, `StaggeredItem`
- Props: `event: SpecialEventDto`, `index: number`, `onEventClick: (event) => void`
- 最適化: `React.memo`

##### SpecialEventCardDescription
- 責務: タイトルと説明文の表示
- Props: `title: string`, `description: string`
- スタイル: `line-clamp-3`で説明文を3行に制限

##### SpecialEventStatusBadge
- 責務: ステータスバッジの表示
- Props: `status: 'upcoming' | 'active' | 'ended'`, `date: string`
- スタイル: ステータスに応じた背景色（active: green, upcoming: blue, ended: gray）

##### SkeletonSpecialEventCard
- 責務: ローディング中のスケルトン表示
- NewsCardやArchiveCardのSkeletonパターンに準拠

##### SpecialsGrid
- 責務: イベントグリッドの調整とレンダリングロジック
- 使用コンポーネント: `SpecialsListGrid`
- 最適化: `useCallback`, `useMemo`

##### SpecialsListGrid
- 責務: グリッドレイアウトと状態管理
- Props: `items`, `loading`, `error`, `renderItem`, `renderSkeleton`, `emptyMessage`
- ローディング、エラー、空状態のハンドリング

### 実装手順

1. ディレクトリ作成
   - `frontend/src/features/specials/components/cards/`
   - `frontend/src/features/specials/components/cards/internals/`
   - `frontend/src/features/specials/components/grids/`
   - `frontend/src/features/specials/components/grids/internals/`

2. 内部コンポーネント実装
   - `SpecialEventCardDescription.tsx`
   - `SpecialEventStatusBadge.tsx`

3. カードコンポーネント実装
   - `SpecialEventCard.tsx`
   - `SkeletonSpecialEventCard.tsx`

4. グリッドコンポーネント実装
   - `SpecialsListGrid.tsx`
   - `SpecialsGrid.tsx`（リファクタリング）

5. 既存ファイル削除
   - `frontend/src/features/specials/components/SpecialsGrid.tsx`

6. ページコンポーネント更新
   - `frontend/src/app/specials/page.tsx`のインポートパス変更

### テスト計画

#### 動作確認項目
1. イベント一覧の表示
2. ローディング状態の表示
3. エラー状態の表示
4. 空状態の表示
5. カードクリックイベント
6. レスポンシブデザイン（モバイル、タブレット、デスクトップ）
7. ステータスバッジの表示（upcoming, active, ended）

#### テスト方法
- Playwright MCPツールを使用したE2Eテスト
- `http://localhost:3001/specials`での動作確認
- 既存の期待動作が正常に動作することを確認

## 既存システムとの整合性

### 使用する共通コンポーネント
- `InteractiveCard` (frontend/src/components/Card/InteractiveCard.tsx)
- `StaggeredItem` (frontend/src/components/Card/StaggeredItem.tsx)
- `LoadingState` (frontend/src/components/Loading/LoadingState.tsx)
- `ErrorDisplay` (frontend/src/components/Error/ErrorDisplay.tsx)

### 既存フックとの連携
- `useSpecials` (frontend/src/features/specials/hooks/useSpecials.ts)
  - そのまま使用、変更なし

### 型定義
- `SpecialEventDto` (frontend/src/features/specials/types/types.ts)
  - そのまま使用、変更なし

## ブランチ戦略

### 現在のブランチ
- `feat/specials` (作業中ブランチ)

### 作業方針
- 現在のブランチ `feat/specials` で作業を継続
- コミット後、`main` ブランチへのPRを作成

## 推奨事項

### 次フェーズ（PLAN）への推奨
1. 提案した構造でコンポーネント分割を実施
2. 他機能との一貫性を保つ
3. パフォーマンス最適化を適用
4. Playwright MCPツールで動作確認

### 将来的な拡張性
- カウントダウンタイマーコンポーネントの追加（設計ドキュメント要件）
- イベント詳細表示機能の追加（必要に応じて）
- フィルタリング・検索機能の追加（必要に応じて）

## 結論

現在の`SpecialsGrid.tsx`は機能的には動作しているが、他機能との一貫性、保守性、再利用性の観点から改善が必要。提案したコンポーネント分割により、以下のメリットが得られる：

1. コードの保守性向上
2. 他機能との一貫性確保
3. コンポーネントの再利用性向上
4. パフォーマンス最適化
5. 将来的な拡張の容易性

実装を推奨する。
