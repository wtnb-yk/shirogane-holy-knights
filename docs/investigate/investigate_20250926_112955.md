# オーバーレイコンポーネント共通化調査

## 調査概要

**調査日時**: 2025-09-26 11:29:55
**対象**: モーダル、ボトムシート、ヘッダーメニューのオーバーレイ実装
**目的**: 個別実装されているオーバーレイの共通化によるコード管理の改善

## 現状分析

### 1. 現在のオーバーレイ実装箇所

#### 1.1 Modal コンポーネント
- **ファイル**: `/frontend/src/components/ui/Modal.tsx`
- **実装内容**:
  - 独自のオーバーレイ実装（71-76行目）
  - `bg-gray-900/20` による半透明背景
  - `animate-modal-fade-in/out` アニメーション
  - ESCキー対応、スクロール制御
  - z-index: 50

#### 1.2 BottomSheet コンポーネント
- **ファイル**: `/frontend/src/components/common/BottomSheet/BottomSheet.tsx`
- **実装内容**:
  - 独自のオーバーレイ実装（58-63行目）
  - `bg-black/20` による半透明背景
  - アニメーションなし（オーバーレイ部分）
  - ESCキー対応、スクロール制御
  - z-index: 50（オーバーレイ）、51（BottomSheet本体）

#### 1.3 ヘッダーナビゲーション用Overlay
- **ファイル**: `/frontend/src/components/header/internals/Overlay.tsx`
- **実装内容**:
  - 専用のOverlayコンポーネント
  - `bg-black/20` による半透明背景
  - アニメーションなし
  - z-index: 40
  - createPortalでbodyに直接レンダリング

#### 1.4 ResponsiveModal
- **ファイル**: `/frontend/src/components/ui/ResponsiveModal.tsx`
- **実装内容**:
  - デバイス判定によりModalまたはBottomSheetを切り替え
  - オーバーレイ自体は各コンポーネントの実装に依存

## 問題点の特定

### 1. コードの重複
- 3箇所で類似のオーバーレイ実装が存在
- スクロール制御、キーボード操作の処理が重複
- アニメーション定義の重複

### 2. 一貫性の欠如
- 異なる背景色（`bg-gray-900/20` vs `bg-black/20`）
- 異なるz-index値（40、50、51）
- アニメーションの有無が不統一

### 3. 管理の複雑さ
- 修正や機能追加時に複数箇所の変更が必要
- z-indexの階層管理が分散
- スタイル定義が各コンポーネントに分散

## 技術的制約と可能性

### アニメーション設定
- **既存定義** (`globals.css`):
  - `modalFadeIn/Out`: オーバーレイフェード
  - `modalSlideScale/Out`: モーダルコンテンツアニメーション
  - `slideDown`: メニュー用アニメーション

### z-index階層構造
- z-10: 一般的なポップアップ要素
- z-40: ヘッダーメニューのオーバーレイ
- z-50: モーダル、ボトムシート、ヘッダー、トースト
- z-[51]: BottomSheet本体
- z-52: MultiSelectドロップダウン

### 依存関係
- Tailwind CSS使用
- React 18のcreatePortal使用（ヘッダーのみ）
- `useViewport` フック使用（レスポンシブ対応）

## 解決方針

### 1. 共通Overlayコンポーネントの作成
新しい共通コンポーネント `/components/ui/Overlay.tsx` を作成し、以下の機能を統合：

#### 基本機能
- 表示/非表示制御
- クリックイベント処理
- キーボードイベント処理
- スクロール制御

#### プロパティ設計
```typescript
interface OverlayProps {
  isOpen: boolean;
  onClose: () => void;
  zIndex?: 40 | 50 | 60; // 用途別z-index
  variant?: 'default' | 'dark' | 'light';
  animate?: boolean;
  disableScroll?: boolean;
  closeOnEsc?: boolean;
  closeOnClick?: boolean;
  portal?: boolean; // createPortal使用オプション
}
```

### 2. 既存コンポーネントのリファクタリング

#### Modal.tsx
- 内部のオーバーレイ実装を削除
- 共通Overlayコンポーネントを使用

#### BottomSheet.tsx
- 内部のオーバーレイ実装を削除
- 共通Overlayコンポーネントを使用

#### Navigation.tsx
- 既存のOverlayを共通コンポーネントに置き換え

### 3. z-index管理の統一
定数ファイルで管理：
```typescript
export const Z_INDEX = {
  overlay: {
    navigation: 40,
    modal: 50,
    bottomSheet: 50,
  },
  content: {
    modal: 50,
    bottomSheet: 51,
    dropdown: 52,
  }
};
```

### 4. アニメーションの統一
共通のアニメーションクラスを定義し、variantで制御

## 実装の影響範囲

### 直接影響を受けるファイル
1. `/components/ui/Modal.tsx`
2. `/components/common/BottomSheet/BottomSheet.tsx`
3. `/components/header/internals/Overlay.tsx`
4. `/components/header/internals/Navigation.tsx`
5. `/components/ui/ResponsiveModal.tsx`

### 間接的に影響を受ける可能性があるファイル
- 各種モーダルを使用しているコンポーネント
- BottomSheetを使用しているコンポーネント

## リスク評価

### 低リスク
- 既存のプロパティインターフェースは維持可能
- 段階的な移行が可能

### 中リスク
- z-index変更による表示順序の影響
- アニメーションタイミングの微調整が必要

### 対策
- 既存のテストケースで動作確認
- ブラウザでの表示確認（レスポンシブ含む）
- 段階的なリリース（まずは1コンポーネントから）

## 推奨実装手順

### Phase 1: 準備
1. 共通Overlayコンポーネントの作成
2. z-index定数ファイルの作成
3. ユニットテストの作成

### Phase 2: 移行
1. ヘッダーのOverlayを共通コンポーネントに移行（最もシンプル）
2. BottomSheetのオーバーレイを移行
3. Modalのオーバーレイを移行

### Phase 3: 最適化
1. アニメーションの統一
2. パフォーマンス最適化
3. ドキュメント作成

## 次のアクション

**推奨**: Plan フェーズへ移行し、詳細な実装計画を策定

### 実装優先度
1. **高**: 共通Overlayコンポーネントの作成
2. **高**: 既存コンポーネントの移行
3. **中**: z-index管理の統一
4. **低**: アニメーション最適化

## 結論

オーバーレイの共通化は技術的に実現可能であり、コードの保守性と一貫性を大幅に向上させることができます。段階的な実装により、リスクを最小限に抑えながら移行可能です。