# 調査レポート: DayEventsModal/EventDetailModal モバイル表示改善

## 調査日時
2025-10-14 17:33:43

## 調査目的
DayEventsModalとEventDetailModalがモバイルサイズでBottomSheetとして表示される現在の実装について、より適切な表示方法を検討する。

## 現状分析

### ResponsiveModalを使用しているコンポーネント

#### 1. DayEventsModal
- **ファイルパス**: `frontend/src/features/calendar/components/modals/DayEventsModal.tsx`
- **用途**: 特定日付のイベント一覧表示
- **表示内容**:
  - 日付タイトル
  - イベント件数
  - イベントリスト（EventListItem）
- **コンテンツ量**: 可変（その日のイベント数に依存）
- **ユーザー操作**: 各イベントをクリックするとEventDetailModalへ遷移

#### 2. EventDetailModal
- **ファイルパス**: `frontend/src/features/calendar/components/modals/EventDetailModal.tsx`
- **用途**: イベントの詳細情報表示
- **表示内容**:
  - イベントタイトル
  - イベントタイプバッジ
  - イベント画像
  - 開始・終了日時
  - 説明文
  - 外部リンクボタン
- **コンテンツ量**: 中程度（説明文の長さに依存）
- **ユーザー操作**: DayEventsModalから遷移した場合は「戻る」ボタンで戻れる

#### 3. SongDetailModal
- **ファイルパス**: `frontend/src/features/songs/components/modals/SongDetailModal.tsx`
- **用途**: 楽曲詳細とパフォーマンス履歴表示
- **表示内容**:
  - 楽曲基本情報（タイトル、アーティスト、歌唱回数、最新歌唱日）
  - パフォーマンスリスト（各配信での歌唱記録）
- **コンテンツ量**: 可変（パフォーマンス数に依存、多い場合は長いリストになる）
- **ユーザー操作**: 各パフォーマンスをクリックすると動画プレイヤーで再生

### 他のモーダルコンポーネント（参考）

#### Modal（中央表示）
- **SearchOptionsModal**: 検索オプション設定
- デスクトップ・モバイル共に画面中央に表示

#### DynamicModal（dynamic import + 中央表示）
- **DiscographyDetailModal**: アルバム詳細
- 重いコンポーネントのため遅延ロード

#### DynamicSearchOptionsModal
- **SongSearchOptionsModal**: 楽曲検索オプション
- **ArchiveSearchOptionsModal**: アーカイブ検索オプション

## 問題点の特定

### BottomSheetの問題点

1. **視認性の課題**
   - 画面下部から展開するため、コンテンツの全体像が初期表示で把握しづらい
   - ユーザーは画面を引き上げてコンテンツ全体を見る必要がある
   - 特にEventDetailModalのようなスクロールが必要なコンテンツで顕著

2. **情報アーキテクチャの問題**
   - イベント詳細など、まとまった情報を読む場合にBottomSheetは不適切
   - ヘッダー（タイトル、閉じるボタン）が常に表示されるため、コンテンツ領域が狭くなる

3. **ナビゲーションの不明確さ**
   - DayEventsModal → EventDetailModal の階層的な遷移がBottomSheetでは伝わりにくい
   - 「戻る」ボタンの存在に気づきにくい

### ResponsiveModal修正による影響範囲

ResponsiveModalを修正すると、以下3つのコンポーネント全てに影響が出る：
- DayEventsModal
- EventDetailModal
- SongDetailModal

これらのコンテンツ特性は異なるため、一律の変更は適切ではない可能性がある。

## 技術的制約の調査

### 現在のアーキテクチャ

```
ResponsiveModal
├─ デスクトップ（lg以上）: Modal（中央表示）
└─ モバイル（lg未満）: BottomSheet（下部からスライドイン）
```

### 使用されているHooks
- `useViewport`: デスクトップ/モバイルの判定（1024px = lg breakpoint）
- `useViewportHeight`: ビューポート高さの動的計算（iOS Safari対応）

### アニメーション
- Modal: `animate-modal-slide-scale`（上からスライド + スケール）
- BottomSheet: `animate-bottom-sheet-in`（下からスライド）

## 解決方針の検討

### オプション1: ResponsiveModalにmobileVariantプロパティを追加（推奨）

**概要**
- `mobileVariant?: 'bottomSheet' | 'fullScreen'`プロパティを追加
- デフォルトは`'bottomSheet'`で後方互換性を保つ
- 各モーダルで個別に選択可能

**メリット**
- 各モーダルのコンテンツ特性に応じて最適な表示方法を選択できる
- 既存のResponsiveModalの構造を活かせる（破壊的変更を避けられる）
- SongDetailModalも検証した上で個別に判断できる
- 将来的な拡張性が高い（他のバリアントも追加可能）

**デメリット**
- APIが若干複雑になる
- 新しいコンポーネント（FullScreenModal）の実装が必要

**実装内容**
1. FullScreenModalコンポーネントの新規作成
2. ResponsiveModalに`mobileVariant`プロパティを追加
3. DayEventsModalで`mobileVariant="fullScreen"`を指定
4. EventDetailModalで`mobileVariant="fullScreen"`を指定
5. SongDetailModalは動作検証後に判断

### オプション2: 新しいコンポーネントを個別に作成

**概要**
- FullScreenResponsiveModalという新しいコンポーネントを作成
- DayEventsModalとEventDetailModalで使用

**メリット**
- 責務が明確
- 既存のResponsiveModalに影響しない

**デメリット**
- コンポーネントが増える
- コードの重複が発生する可能性
- 一貫性が損なわれる

### オプション3: ResponsiveModalのデフォルト動作を変更

**概要**
- モバイル時にBottomSheet → FullScreenModalに一律変更

**メリット**
- 一貫性が高い
- シンプルな実装

**デメリット**
- 全てのコンポーネントに影響
- SongDetailModalで適切かの検証が必須
- 後方互換性がない

## 推奨する解決策

**オプション1（mobileVariantプロパティ追加）を推奨**

### 理由
1. 柔軟性と拡張性が高い
2. 後方互換性を保ちつつ段階的に改善できる
3. 各モーダルのコンテンツ特性に応じた最適化が可能
4. SongDetailModalへの影響を最小限に抑えられる

### 実装の詳細設計

#### FullScreenModal仕様
- **表示方法**: モバイルで画面全体を覆う
- **アニメーション**: 画面上部からスライドイン
- **ヘッダー**: 固定位置、タイトル、戻るボタン、閉じるボタン
- **コンテンツ領域**: スクロール可能
- **背景**: 白（または bg-bg-primary）
- **z-index**: BottomSheetと同じ階層

#### ResponsiveModal拡張
```typescript
interface ResponsiveModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
  title: ReactNode;
  className?: string;
  backButton?: {
    show: boolean;
    onClick: () => void;
  };
  mobileVariant?: 'bottomSheet' | 'fullScreen'; // 新規追加
}
```

#### 適用方針
- **DayEventsModal**: `mobileVariant="fullScreen"`
  - 理由: イベント一覧は画面全体で見た方が把握しやすい
- **EventDetailModal**: `mobileVariant="fullScreen"`
  - 理由: 詳細情報をしっかり読む用途にはフルスクリーンが適切
- **SongDetailModal**: 暫定的に現状維持（`mobileVariant`指定なし = BottomSheet）
  - E2Eテストで動作確認後、必要に応じて`fullScreen`に変更

## 次のステップ（Planフェーズ）

1. FullScreenModalコンポーネントの実装
2. ResponsiveModalの拡張
3. 各モーダルの更新
4. アニメーションの追加（globals.css）
5. E2Eテスト実施（Playwright）
   - DayEventsModalの表示・遷移確認
   - EventDetailModalの表示・ナビゲーション確認
   - SongDetailModalの現状動作確認
   - デスクトップ表示の回帰テスト

## まとめ

ResponsiveModalに`mobileVariant`プロパティを追加することで、以下を実現できる：
- DayEventsModalとEventDetailModalのモバイルUX改善
- SongDetailModalへの影響を最小限に抑える
- 後方互換性の維持
- 将来的な拡張性の確保

この方針により、段階的かつ安全に改善を進められる。
