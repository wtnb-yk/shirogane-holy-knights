# 調査報告書: 本番環境CSSエラー調査

## 調査ID
investigate_20251006_095622

## 調査対象
本番環境で発生している以下のエラー:
```
f2e89ef87fdc1daf.css:1 Uncaught SyntaxError: Invalid or unexpected token
```

## 調査期間
2025年10月6日

## 調査担当
Claude Code

## 現在のブランチ
main

---

## 1. 問題の概要

### 1.1 症状
- 本番環境でブラウザのコンソールに `f2e89ef87fdc1daf.css:1 Uncaught SyntaxError: Invalid or unexpected token` というエラーが表示される
- CSS自体は問題なく効いている
- ユーザー体験に直接的な影響はないが、コンソールエラーが発生している

### 1.2 環境情報
- Next.js: 15.1.6
- Tailwind CSS: 4.1.13
- PostCSS: 8.5.6
- React: 19.1.1
- Node.js: 20以上

---

## 2. 調査プロセス

### 2.1 調査対象ファイルの特定

#### CSSファイルの確認
```bash
/Users/yuki_watanabe/My/shirogane-holy-knights/frontend/.next/static/css/f2e89ef87fdc1daf.css
```

ファイル分析結果:
- ファイルタイプ: `ASCII text, with very long lines (65536), with no line terminators`
- 行数: 0行（改行なし）
- 内容: 圧縮されたCSSファイル（Minified）
- フォントフェース定義、Tailwindユーティリティクラスなどが1行に圧縮されている

#### Build Manifestの確認
`build-manifest.json`にて以下を確認:
```json
"rootMainFiles": [
  "static/chunks/webpack-c7a003135a2fe1fa.js",
  "static/chunks/d764cd1b-ff94fc829997fa44.js",
  "static/css/f2e89ef87fdc1daf.css",
  "static/chunks/vendors-50c8cdae85bf71b5.js",
  "static/chunks/main-app-11dfb4bc8b989b0a.js"
]
```

### 2.2 根本原因の特定

HTMLファイル（例: `specials.html`）内で以下の問題を発見:

#### 問題のコード
```html
<link rel="stylesheet" href="/_next/static/css/f2e89ef87fdc1daf.css" data-precedence="next"/>
<!-- 正しい読み込み方法 -->

<script src="/_next/static/css/f2e89ef87fdc1daf.css" async=""></script>
<!-- 問題: CSSファイルがscriptタグで読み込まれている -->
```

**根本原因**:
CSSファイルが`<link rel="stylesheet">`で正しく読み込まれているにもかかわらず、追加で`<script src="...css">`タグでも読み込まれている。これにより、ブラウザがCSSファイルをJavaScriptとして解釈しようとし、SyntaxErrorが発生している。

---

## 3. 技術的分析

### 3.1 Next.js 15のビルドプロセス

#### webpack設定（next.config.js）
```javascript
webpack: (config, { dev, isServer }) => {
  if (!dev && !isServer) {
    config.optimization.splitChunks = {
      cacheGroups: {
        vendor: { ... },
        ui: { ... },
        features: { ... },
      },
    }
  }
  return config
}
```

#### PostCSS設定
```javascript
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: { ... },
  },
}
```

### 3.2 Tailwind CSS v4の特徴

プロジェクトではTailwind CSS v4を使用:
- `@import "tailwindcss";`をglobals.cssで使用
- `@theme`ディレクティブでカスタム変数を定義
- PostCSS経由で処理

### 3.3 なぜエラーが発生するか

1. CSSファイルは改行なしで1行に圧縮されている（プロダクションビルド最適化）
2. ブラウザが`<script>`タグ経由でCSSを読み込もうとする
3. JavaScriptパーサーがCSS構文を解釈できず、SyntaxErrorを発生させる
4. エラーメッセージ: "Invalid or unexpected token"（CSS構文はJavaScriptとして無効）

### 3.4 なぜCSSは効いているか

- `<link rel="stylesheet">`タグが正しく配置されているため
- ブラウザは正しいタグからCSSを適用
- `<script>`タグのエラーは実行エラーであり、レンダリングには影響しない

---

## 4. 影響範囲

### 4.1 現在の影響
- **機能面**: 影響なし（CSSは正常に適用されている）
- **パフォーマンス**: 微小な影響（不要なリクエスト/パース処理）
- **開発体験**: コンソールエラーによるデバッグの妨げ
- **SEO**: 影響なし
- **ユーザー体験**: 影響なし

### 4.2 潜在的リスク
- エラーモニタリングツールでの誤検知
- 実際の問題が埋もれる可能性
- ブラウザによっては異なる挙動の可能性

---

## 5. 原因の推定

### 5.1 考えられる原因

1. **Next.js 15のバグ**
   - App Routerでのアセット管理の問題
   - Build manifestの生成ロジックの不具合

2. **カスタムwebpack設定の影響**
   - `splitChunks`設定が意図しない動作を引き起こしている

3. **Tailwind CSS v4との互換性問題**
   - `@tailwindcss/postcss`との統合で予期しない挙動

4. **Next.jsのアセット最適化機能**
   - `output: 'standalone'`設定との相互作用

### 5.2 最も可能性の高い原因

Next.js 15のビルドプロセスにおいて、CSSファイルがrootMainFilesに含まれており、これがscriptタグとして出力される動作になっている可能性が高い。

---

## 6. 解決方針

### 6.1 短期的対応（推奨）

#### オプション1: Next.js設定の調整
`next.config.js`の`webpack`設定を見直し、CSSファイルがscriptチャンクとして扱われないようにする。

#### オプション2: Next.jsバージョンアップ
- 最新のNext.js 15.xにアップデートして問題が修正されているか確認

### 6.2 中期的対応

#### オプション3: カスタムDocument修正
App Routerを使用しているため、レンダリングロジックの調整が必要な場合がある。

### 6.3 長期的対応

#### オプション4: ビルドプロセスの最適化
- webpack設定の全面的な見直し
- 不要な最適化設定の削除
- Next.js推奨のデフォルト設定への回帰

---

## 7. 推奨アクション

### 7.1 即座に実施すべき対応
1. Next.jsの最新パッチバージョンへのアップデート確認
2. 公式GitHubでの類似Issue検索
3. webpack設定の段階的な無効化テスト

### 7.2 検証すべき項目
- [ ] Next.js 15の最新バージョンで問題が再現するか
- [ ] カスタムwebpack設定を無効化した場合の挙動
- [ ] 開発環境での動作確認
- [ ] 他のページでも同様の問題が発生しているか

### 7.3 調査が必要な項目
- [ ] build-manifestの生成ロジック
- [ ] rootMainFilesの処理フロー
- [ ] Next.js App Routerのアセット読み込みメカニズム

---

## 8. 次フェーズへの提言

### 8.1 Plan フェーズで実施すべきこと

1. **webpack設定の調整計画**
   - splitChunks設定の段階的な変更
   - テスト戦略の策定

2. **Next.js設定の見直し**
   - `output: 'standalone'`の影響調査
   - 代替設定の検討

3. **検証環境の構築**
   - 本番環境の再現
   - A/Bテストの準備

### 8.2 実装不要の判断基準

以下の場合、実装は不要:
- Next.jsの次期マイナーバージョンで修正される見込みがある
- 実害がなく、コンソールエラーのみの問題である

---

## 9. 参考情報

### 9.1 関連ファイル
- `/Users/yuki_watanabe/My/shirogane-holy-knights/frontend/next.config.js`
- `/Users/yuki_watanabe/My/shirogane-holy-knights/frontend/postcss.config.js`
- `/Users/yuki_watanabe/My/shirogane-holy-knights/frontend/tailwind.config.ts`
- `/Users/yuki_watanabe/My/shirogane-holy-knights/frontend/src/app/globals.css`
- `/Users/yuki_watanabe/My/shirogane-holy-knights/frontend/.next/build-manifest.json`

### 9.2 調査コマンド
```bash
# CSSファイルの確認
file frontend/.next/static/css/f2e89ef87fdc1daf.css
head -20 frontend/.next/static/css/f2e89ef87fdc1daf.css

# ビルドマニフェストの確認
cat frontend/.next/build-manifest.json | jq '.rootMainFiles'

# 参照箇所の検索
grep -r "f2e89ef87fdc1daf" frontend/.next/
```

### 9.3 技術スタック
- Next.js 15.1.6
- Tailwind CSS 4.1.13
- @tailwindcss/postcss 4.1.13
- React 19.1.1
- PostCSS 8.5.6

---

## 10. まとめ

### 10.1 調査結論

本番環境で発生しているCSSエラーは、Next.js 15のビルドプロセスにおいて、CSSファイルが誤って`<script>`タグで読み込まれていることが原因である。

### 10.2 重要度評価

- **緊急度**: 低（機能に影響なし）
- **重要度**: 中（コード品質・開発体験に影響）
- **複雑度**: 中（Next.js内部動作の理解が必要）

### 10.3 次のステップ

**推奨**: PLANフェーズに進み、webpack設定の調整とNext.js設定の最適化を計画する。

**代替案**: 実装せず、Next.jsの次期バージョンアップデートを待つ。

---

## 調査完了日時
2025年10月6日 09:56:22