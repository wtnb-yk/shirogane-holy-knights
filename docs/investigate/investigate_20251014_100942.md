# stream_tagsテーブルにVRChatを追加する調査レポート

## 調査概要

**調査日時**: 2025-10-14 10:09:42
**ブランチ**: feature/add-vrchat-stream-tag
**目的**: stream_tagsテーブルにVRChatタグを追加するための実装方針の策定

## 調査対象

stream_tagsテーブルにVRChatタグを追加し、フロントエンド、バックエンド、ツールにおける必要な修正箇所を特定する。

## 調査結果

### 1. データベース構造

#### stream_tagsテーブル
- **場所**: PostgreSQL 14 / shiroganeデータベース
- **定義**: `backend/src/main/resources/db/changelog/changes/009-create-stream-tag-tables.sql`
- **構造**:
  - id (SERIAL PRIMARY KEY)
  - name (VARCHAR(50) NOT NULL UNIQUE)
  - description (TEXT)
  - created_at (TIMESTAMP DEFAULT CURRENT_TIMESTAMP)

#### 既存タグ一覧
現在16個のタグが存在（ID 1-16）:
- 雑談、ゲーム、歌枠、ASMR、企画、コラボ、3D、記念、同時視聴、耐久、案件、参加型、新衣装、ライブ、英語勉強、カード開封

**初期データ挿入**: `backend/src/main/resources/db/changelog/changes/014-insert-initial-stream-tags.sql`

#### video_stream_tagsテーブル（中間テーブル）
- **役割**: videosテーブルとstream_tagsテーブルの多対多関係を管理
- **構造**:
  - video_id (VARCHAR(50) NOT NULL, FK to videos)
  - tag_id (INTEGER NOT NULL, FK to stream_tags)
  - created_at (TIMESTAMP)
  - PRIMARY KEY (video_id, tag_id)

### 2. バックエンド（Kotlin/Spring Boot）

#### データフロー
1. **Repository層**: `VideoRepositoryImpl.kt`
   - `getAllStreamTags()` メソッド (128-140行目)
   - SQL: `SELECT name FROM stream_tags ORDER BY name`
   - データベースから動的にタグを取得

2. **Controller層**: `VideoController.kt`
   - `getAllStreamTags()` メソッド (28-29行目)
   - APIレスポンスを返す

3. **APIルーター**: `ApiGatewayRouter.kt`
   - エンドポイント: `GET /stream-tags` (63-65行目)
   - VideoControllerのgetAllStreamTags()を呼び出し

#### Entity定義
`VideoEntities.kt` (58-65行目):
```kotlin
@Table("stream_tags")
data class StreamTagEntity(
    @Id
    val id: Long? = null,
    val name: String,
    val description: String?,
    val createdAt: Instant?
)
```

**重要**: バックエンドはデータベースから動的にタグを取得するため、VRChat追加時のコード変更は不要。

### 3. フロントエンド（Next.js/TypeScript）

#### データフロー
1. **API Client**: `archiveClient.ts` (42-44行目)
   - `StreamApi.getAllTags()`: `/stream-tags` エンドポイントを呼び出し

2. **React Hook**: `useAllStreamTags.ts`
   - APIからタグを取得し、コンポーネントに提供

**重要**: フロントエンドはAPIから動的にタグを取得するため、VRChat追加時のコード変更は不要。

### 4. ツール（Python）

#### stream_tag_extractor.py
- **役割**: タイトルと説明からタグを自動抽出し、CSVファイルに出力
- **場所**: `tools/scripts/stream_tag_extractor.py`
- **特徴**:
  - 各タグに対してキーワードマッチングロジックを実装
  - 既存タグの例: 雑談（84-90行目）、ゲーム（92-119行目）、歌枠（121-125行目）など
  - VRChat追加時は専用のキーワードマッチングロジックを追加することが推奨

#### stream_tags_importer.py
- **役割**: CSVファイルからvideo_stream_tagsテーブルにデータをインポート
- **場所**: `tools/scripts/stream_tags_importer.py`
- **特徴**: タグ名からIDを自動解決するため、VRChat追加後は追加のコード変更不要

#### Justfileコマンド
- `just stream-tags-extract-local`: タグ抽出実行（ローカルDB）
- `just stream-tags-import-local`: タグインポート実行（ローカルDB）
- dev/prd環境用のコマンドも存在

### 5. マイグレーション管理

**Liquibase**を使用してデータベース変更を管理:
- マイグレーションファイル配置: `backend/src/main/resources/db/changelog/changes/`
- 既存の最新マイグレーション: `024-optimize-query-performance.sql`
- 新規マイグレーションファイル番号: `025-add-vrchat-stream-tag.sql`

## 技術的制約

1. **UNIQUE制約**: stream_tags.nameカラムにUNIQUE制約があるため、タグ名の重複は不可
2. **ID採番**: 既存のIDは1-16まで使用済み。VRChatのIDは17を使用
3. **外部キー制約**: video_stream_tagsテーブルからの参照が存在するため、既存タグの削除には注意が必要

## 実装方針

### 必須修正

#### 1. データベースマイグレーション
**ファイル**: `backend/src/main/resources/db/changelog/changes/025-add-vrchat-stream-tag.sql`

```sql
--liquibase formatted sql

--changeset shirogane:025-add-vrchat-stream-tag
--comment: Add VRChat tag to stream_tags table

INSERT INTO public.stream_tags (id, name, description)
VALUES (17, 'VRChat', 'VRChat')
ON CONFLICT (name) DO NOTHING;

--rollback DELETE FROM stream_tags WHERE name = 'VRChat';
```

### 推奨修正（オプション）

#### 2. stream_tag_extractor.pyへのキーワードマッチング追加
**ファイル**: `tools/scripts/stream_tag_extractor.py`

VRChatタグを自動的に抽出するためのロジックを追加:

```python
elif tag_name == "VRChat":
    keywords = ["VRChat", "VRC", "vrchat", "バーチャル", "アバター", "ワールド巡り"]
    if any(keyword in title for keyword in keywords):
        matched_tags.append(tag_id)
```

挿入位置: 既存のタグマッチングロジックの末尾（189行目付近）

## 既存システムとの整合性

1. **バックエンド**: データベースから動的に取得するため、コード変更不要
2. **フロントエンド**: APIから動的に取得するため、コード変更不要
3. **ツール**: stream_tags_importer.pyはタグ名からIDを自動解決するため、変更不要

## リスク評価

- **リスクレベル**: 低
- **影響範囲**: データベースのみ（バックエンド、フロントエンドは影響なし）
- **ロールバック**: Liquibaseのrollbackコマンドで簡単に戻せる

## テスト計画

### 1. データベーステスト
- [ ] マイグレーション実行後、stream_tagsテーブルにVRChatが追加されていることを確認
- [ ] VRChatタグのIDが17であることを確認
- [ ] UNIQUE制約が正常に機能することを確認（重複挿入の失敗）

### 2. バックエンドAPI テスト
- [ ] GET /stream-tags エンドポイントのレスポンスにVRChatが含まれることを確認
- [ ] タグの順序がアルファベット順であることを確認

### 3. フロントエンドテスト
- [ ] アーカイブページでVRChatタグが選択肢として表示されることを確認
- [ ] VRChatタグでフィルタリングが正常に動作することを確認

### 4. ツールテスト（オプション）
- [ ] stream_tag_extractor.pyでVRChatキーワードが正しく抽出されることを確認
- [ ] stream_tags_importer.pyでVRChatタグが正しくインポートされることを確認

## 推奨実装順序

1. マイグレーションファイルの作成
2. ローカル環境でマイグレーション実行とテスト
3. stream_tag_extractor.pyの修正（オプション）
4. 動作確認（Playwright MCPツールを使用）
5. コミット・プルリクエスト作成
6. dev環境へのデプロイ
7. 本番環境へのデプロイ

## 次フェーズへの推奨事項

**次フェーズ**: PLAN

### 実装タスク
1. マイグレーションファイル作成
2. stream_tag_extractor.pyへのキーワードマッチング追加（オプション）
3. ローカル環境での動作確認
4. E2Eテスト実行（Playwright）
5. コミット・プッシュ

### 期待所要時間
- 実装: 30分
- テスト: 30分
- 合計: 約1時間

## 参考ファイル一覧

### データベース
- `backend/src/main/resources/db/changelog/changes/009-create-stream-tag-tables.sql`
- `backend/src/main/resources/db/changelog/changes/014-insert-initial-stream-tags.sql`
- `backend/docs/database-schema.md`

### バックエンド
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/VideoRepositoryImpl.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/VideoController.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouter.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/VideoEntities.kt`
- `backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/VideoRepository.kt`

### フロントエンド
- `frontend/src/features/archives/api/archiveClient.ts`
- `frontend/src/features/archives/hooks/useAllStreamTags.ts`

### ツール
- `tools/scripts/stream_tag_extractor.py`
- `tools/scripts/stream_tags_importer.py`
- `tools/justfile`

## 結論

VRChatタグの追加は、データベースマイグレーションファイルの作成のみで実現可能。バックエンドとフロントエンドは動的にタグを取得するため、コード変更は不要。ツール側のキーワードマッチングロジック追加はオプションだが、自動タグ付けの精度向上のため推奨される。

実装難易度は低く、リスクも最小限であるため、即座に実装を開始できる。