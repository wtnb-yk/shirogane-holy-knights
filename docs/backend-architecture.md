# バックエンドアーキテクチャ設計書

## 概要

団員ポータルバックエンドは、Kotlin/Spring BootによるRESTful APIとして実装されています。アーキテクチャはHexagonal Architecture（別名：Ports and Adapters、クリーンアーキテクチャ）のパターンに従って設計されており、レイヤー間の依存関係を明確に制御しています。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────┐
│                  クライアント                     │
└───────────────────────┬─────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────┐
│                    API Gateway                  │
└───────────────────────┬─────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────┐
│               Spring Cloud Function (AWS)       │
└───────────────────────┬─────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────┐
│                  Spring Bootアプリケーション       │
├─────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────┐    │
│  │           アダプタ層（入力）               │    │
│  │ @RestController, @RequestMapping        │    │
│  └──────────────────┬──────────────────────┘    │
│                     │                           │
│  ┌─────────────────▼──────────────────────┐     │
│  │           アプリケーション層              │     │
│  │ UseCases, DTOs, Ports                  │     │
│  └──────────────────┬─────────────────────┘     │
│                     │                           │
│  ┌─────────────────▼──────────────────────┐     │
│  │              ドメイン層                  │     │
│  │ Entities, Repository Interfaces        │     │
│  └──────────────────┬──────────────────────┘     │
│                     │                           │
│  ┌─────────────────▼──────────────────────┐     │
│  │          アダプタ層（出力）              │     │
│  │ JdbcTemplate, Repository Impl             │     │
│  └──────────────────┬──────────────────────┘     │
│                     │                           │
└─────────────────────┬─────────────────────────┘
                      │
┌─────────────────────▼─────────────────────────┐
│                 PostgreSQL                    │
└─────────────────────────────────────────────────┘
```

## ディレクトリ構造

```
com.shirogane.holy.knights
├── domain                      # ドメイン層
│   ├── model                   # ドメインモデル
│   ├── repository              # リポジトリインターフェース
│   └── service                 # ドメインサービス
│
├── application                 # アプリケーション層
│   ├── dto                     # データ転送オブジェクト
│   ├── usecase                 # ユースケース実装
│   └── port                    # ポート定義
│       ├── in                  # 入力ポート（ユースケースインターフェース）
│       └── out                 # 出力ポート（リポジトリポートなど）
│
├── adapter                     # アダプタ層
│   ├── in                      # 入力アダプタ
│   │   └── controller          # コントローラー（HTTPリクエストハンドラ）
│   └── out                     # 出力アダプタ
│       └── persistence         # 永続化アダプタ（リポジトリ実装）
│
└── infrastructure              # インフラストラクチャ層
    ├── config                  # アプリケーション設定
    ├── database                # データベース接続
    └── lambda                  # AWS Lambda統合
```

## レイヤー説明

### 1. ドメイン層

ドメイン層はビジネスロジックの中心です。外部の技術的な詳細に依存せず、純粋なビジネスルールとロジックを表現します。

- **モデル**: アーカイブなどのドメインエンティティと値オブジェクト
- **リポジトリインターフェース**: データアクセスの抽象化
- **ドメインサービス**: エンティティ間の操作を担当するサービス

### 2. アプリケーション層

アプリケーション層はユースケース（アプリケーションの具体的な振る舞い）を実装します。ドメイン層に依存しますが、アダプタ層には依存しません。

- **ユースケース**: アプリケーション固有のビジネスロジック
- **DTOs**: データ転送オブジェクト
- **ポート**: アプリケーション層と外部との通信インターフェース
  - **入力ポート**: コントローラーからの入力を受け取るインターフェース
  - **出力ポート**: データベースなど外部システムへのアクセスを抽象化

### 3. アダプタ層

アダプタ層は外部インターフェースとアプリケーション層を接続します。技術的な詳細を実装します。

- **入力アダプタ**: HTTPリクエストをアプリケーション層が理解できる形に変換
  - **コントローラー**: Spring Web MVCと@RestControllerアノテーションを使用したRESTful API
- **出力アダプタ**: アプリケーション層の要求をデータベースなどの外部システムへの操作に変換
  - **リポジトリ実装**: Spring JDBCテンプレートを使用したデータベースアクセス

### 4. インフラストラクチャ層

インフラストラクチャ層は技術的な詳細を担当します。フレームワークやデータベース接続などの実装を含みます。

- **設定**: application.ymlとSpring Bean定義
- **データベース**: Spring Bootデータソース設定
- **Lambda**: Spring Cloud FunctionによるAWS Lambda統合

## 依存関係の流れ

依存関係はドメイン層に向かって内側に流れます：

```
インフラストラクチャ層 → アダプタ層 → アプリケーション層 → ドメイン層
```

この依存関係の方向により、ドメイン層は外部の技術的な詳細から独立して、ビジネスロジックに集中できます。

## API エンドポイント


## 今後の拡張予定

- **認証機能**: Spring SecurityとAmazon Cognitoを使用した認証の実装
- **キャッシュ機能**: Spring Cacheを活用したキャッシュ機能の実装
- **テスト拡充**: Spring Boot Testを活用した各レイヤーのテスト実装
- **APIドキュメント**: SpringDoc OpenAPIを使用したAPI仕様書の自動生成