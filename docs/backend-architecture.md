# バックエンドアーキテクチャ設計書

## 概要

団員ポータルバックエンドは、Kotlin/KtorによるRESTful APIとして実装されています。アーキテクチャはHexagonal Architecture（別名：Ports and Adapters、クリーンアーキテクチャ）のパターンに従って設計されており、レイヤー間の依存関係を明確に制御しています。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────┐
│                  クライアント                     │
└───────────────────────┬─────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────┐
│                    API Gateway                  │
└───────────────────────┬─────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────┐
│               Lambda Handler (AWS)              │
└───────────────────────┬─────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────┐
│                  Ktorアプリケーション             │
├─────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────┐    │
│  │           アダプタ層（入力）              │    │
│  │ Controllers, Routes                     │    │
│  └──────────────────┬──────────────────────┘    │
│                     │                           │
│  ┌─────────────────▼──────────────────────┐     │
│  │           アプリケーション層             │     │
│  │ UseCases, DTOs, Ports                  │     │
│  └──────────────────┬──────────────────────┘     │
│                     │                           │
│  ┌─────────────────▼──────────────────────┐     │
│  │              ドメイン層                 │     │
│  │ Entities, Repository Interfaces        │     │
│  └──────────────────┬──────────────────────┘     │
│                     │                           │
│  ┌─────────────────▼──────────────────────┐     │
│  │          アダプタ層（出力）              │     │
│  │ Repository Implementations             │     │
│  └──────────────────┬──────────────────────┘     │
│                     │                           │
└─────────────────────┬─────────────────────────┘
                      │
┌─────────────────────▼─────────────────────────┐
│                 PostgreSQL                    │
└─────────────────────────────────────────────────┘
```

## ディレクトリ構造

```
com.shirogane.holy.knights
├── domain                      # ドメイン層
│   ├── model                   # ドメインモデル
│   ├── repository              # リポジトリインターフェース
│   └── service                 # ドメインサービス
│
├── application                 # アプリケーション層
│   ├── dto                     # データ転送オブジェクト
│   ├── usecase                 # ユースケース実装
│   └── port                    # ポート定義
│       ├── in                  # 入力ポート（ユースケースインターフェース）
│       └── out                 # 出力ポート（リポジトリポートなど）
│
├── adapter                     # アダプタ層
│   ├── in                      # 入力アダプタ
│   │   └── controller          # コントローラー（HTTPリクエストハンドラ）
│   └── out                     # 出力アダプタ
│       └── persistence         # 永続化アダプタ（リポジトリ実装）
│
└── infrastructure              # インフラストラクチャ層
    ├── config                  # アプリケーション設定
    ├── database                # データベース接続
    └── lambda                  # AWS Lambda統合
```

## レイヤー説明

### 1. ドメイン層

ドメイン層はビジネスロジックの中心です。外部の技術的な詳細に依存せず、純粋なビジネスルールとロジックを表現します。

- **モデル**: アーカイブなどのドメインエンティティと値オブジェクト
- **リポジトリインターフェース**: データアクセスの抽象化
- **ドメインサービス**: エンティティ間の操作を担当するサービス

### 2. アプリケーション層

アプリケーション層はユースケース（アプリケーションの具体的な振る舞い）を実装します。ドメイン層に依存しますが、アダプタ層には依存しません。

- **ユースケース**: アプリケーション固有のビジネスロジック
- **DTOs**: データ転送オブジェクト
- **ポート**: アプリケーション層と外部との通信インターフェース
  - **入力ポート**: コントローラーからの入力を受け取るインターフェース
  - **出力ポート**: データベースなど外部システムへのアクセスを抽象化

### 3. アダプタ層

アダプタ層は外部インターフェースとアプリケーション層を接続します。技術的な詳細を実装します。

- **入力アダプタ**: HTTPリクエストをアプリケーション層が理解できる形に変換
  - **コントローラー**: KtorルーティングとHTTPリクエスト/レスポンス処理
- **出力アダプタ**: アプリケーション層の要求をデータベースなどの外部システムへの操作に変換
  - **リポジトリ実装**: データベースアクセスの具体的な実装

### 4. インフラストラクチャ層

インフラストラクチャ層は技術的な詳細を担当します。フレームワークやデータベース接続などの実装を含みます。

- **設定**: アプリケーション設定、依存関係注入
- **データベース**: データベース接続、マイグレーション
- **Lambda**: AWS Lambda統合のハンドラー

## 依存関係の流れ

依存関係はドメイン層に向かって内側に流れます：

```
インフラストラクチャ層 → アダプタ層 → アプリケーション層 → ドメイン層
```

この依存関係の方向により、ドメイン層は外部の技術的な詳細から独立して、ビジネスロジックに集中できます。

## API エンドポイント

現在実装されているAPIエンドポイントは以下のとおりです：

- **GET /api/v1/archives**: アーカイブ一覧を取得
- **GET /api/v1/archives/{id}**: 特定IDのアーカイブ詳細を取得
- **GET /api/v1/archives/search**: 検索条件でアーカイブを検索
- **GET /api/v1/archives/{id}/related**: 関連アーカイブを取得
- **GET /health**: ヘルスチェック

## 今後の拡張予定

- **認証機能**: Amazon Cognitoを使用した認証の実装
- **キャッシュ機能**: 検索結果のキャッシュによるパフォーマンス向上
- **テスト拡充**: ユニットテスト、インテグレーションテストの実装
- **API仕様**: OpenAPIを使用したAPI仕様書の自動生成