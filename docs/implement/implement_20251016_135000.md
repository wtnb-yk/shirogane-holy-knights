# 実装詳細記録: album_tracksテーブルへのartistカラム追加

## 実装日時
2025-10-16 13:50:00

## 実装対象
album_tracksテーブルにartistカラムを追加し、Discography機能とCSVインポートツールを改修する。

## 参照プラン
- プランファイル: `docs/plan/plan_20251016_111500.md`
- 調査レポート: `docs/investigate/investigate_20251016_110545.md`

## 実装内容

### 1. マイグレーションファイル作成

**ファイル**: `backend/src/main/resources/db/changelog/changes/034-add-artist-to-album-tracks.sql`

**作成内容**:
- album_tracksテーブルをDROP（CASCADE）
- artistカラム（VARCHAR(255) NOT NULL）を追加して再作成
- カラム順序: id, album_id, song_id, artist, track_number, created_at
- 外部キー制約とインデックスを再作成
- track_releasesテーブルも再作成（外部キー制約のため）

**重要な修正**:
- 初回作成時、VARCHAR(255)型でテーブルを定義したが、実際のデータベースはUUID型を使用していた
- エラー: `foreign key constraint "album_tracks_album_id_fkey" cannot be implemented`
- 対応: id, album_id, album_track_id を全てUUID型に修正

**最終的なテーブル定義**:
```sql
CREATE TABLE album_tracks
(
    id           UUID PRIMARY KEY,
    album_id     UUID NOT NULL REFERENCES albums (id) ON DELETE CASCADE,
    song_id      UUID NOT NULL REFERENCES songs (id) ON DELETE CASCADE,
    artist       VARCHAR(255) NOT NULL,
    track_number INTEGER NOT NULL,
    created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (album_id, song_id)
);
```

**マイグレーション結果**:
- ステータス: 成功
- 実行ログ: "Liquibase: Update has been successful. Rows affected: 1"
- 確認: `\d album_tracks` でartistカラムが正常に追加されたことを確認

### 2. バックエンドクエリ修正

**ファイル**: `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumQueryBuilder.kt`

**修正内容**:
- Line 30: `s.artist` → `atr.artist` に変更
- Line 80: `s.artist` → `atr.artist` に変更（buildGetByIdQuery）

**修正箇所**:
```kotlin
// 修正前
COALESCE(STRING_AGG(CONCAT(s.id, ':', s.title, ':', s.artist, ':', atr.track_number), '|' ORDER BY atr.track_number), '') as tracks,

// 修正後
COALESCE(STRING_AGG(CONCAT(s.id, ':', s.title, ':', atr.artist, ':', atr.track_number), '|' ORDER BY atr.track_number), '') as tracks,
```

**影響範囲**:
- `buildSearchQuery()`: 全アルバム検索クエリ
- `buildGetByIdQuery()`: 個別アルバム取得クエリ
- AlbumRowMapper.ktは変更不要（parts[2]の位置は変わらないため）

### 3. CSVインポートツール修正

**ファイル**: `tools/scripts/albums_importer.py`

**CSV構造の変更**:
- 新規カラム追加: `track_artist`
- 各トラックごとに異なるアーティストを指定可能（コンピレーションアルバム対応）

**修正内容**:

1. CSV読み込み処理の修正（Line 147-175）:
```python
# track_artistカラムを読み取り
track_artist = row['track_artist'] if pd.notna(row['track_artist']) else artist

# トラック情報に追加
albums_data[album_key]['tracks'].append({
    'track_number': track_number,
    'song_title': song_title,
    'artist': track_artist  # 追加
})
```

2. INSERT文の修正（Line 233-244）:
```python
cursor.execute("""
    INSERT INTO album_tracks (id, album_id, song_id, artist, track_number)
    VALUES (%s, %s, %s, %s, %s)
""", (
    track_id,
    album_id,
    song_id,
    track['artist'],  # track_artistを使用
    track['track_number']
))
```

### 4. マイグレーション実行

**実行手順**:
1. Docker Composeを停止: `docker compose down`
2. Docker Composeを起動: `docker compose up -d`
3. Liquibaseコンテナが自動的にマイグレーションを実行

**実行結果**:
- 初回実行: 失敗（VARCHAR/UUID型不一致）
- マイグレーションファイル修正後: 成功
- 変更セット実行数: 1（034-add-artist-to-album-tracks）
- 既存の変更セット: 37

**データベース確認**:
```
Table "public.album_tracks"
    Column    |            Type
--------------+-----------------------------
 id           | uuid
 album_id     | uuid
 song_id      | uuid
 artist       | character varying(255)  <- 追加成功
 track_number | integer
 created_at   | timestamp without time zone
```

## 発生した問題と対応

### 問題1: マイグレーションファイルの型不一致

**エラー内容**:
```
ERROR: foreign key constraint "album_tracks_album_id_fkey" cannot be implemented
Detail: Key columns "album_id" and "id" are of incompatible types: character varying and uuid.
```

**原因**:
- プランではVARCHAR(255)型を想定していた
- 実際のデータベースはUUID型を使用していた
- 025-restructure-album-tables.sqlを確認していなかった

**対応**:
1. `docker compose exec postgres psql -U postgres -d shirogane -c "\d albums"` で実際の型を確認
2. マイグレーションファイルを全てUUID型に修正
3. 再度マイグレーション実行

### 問題2: CSVデータ構造の不足

**発見内容**:
- 当初のCSVには`track_artist`カラムが存在しなかった
- アルバムレベルの`artist`カラムのみ存在
- コンピレーションアルバムで各トラックのアーティストを区別できない

**対応**:
- ユーザーがCSVに`track_artist`カラムを追加
- albums_importer.pyを修正してtrack_artistを読み取り、使用するように変更

## 変更ファイル一覧

### 新規作成
| ファイルパス | 説明 |
|------------|------|
| `backend/src/main/resources/db/changelog/changes/034-add-artist-to-album-tracks.sql` | マイグレーションファイル（UUID型対応） |
| `docs/implement/implement_20251016_135000.md` | 本実装詳細記録 |

### 修正
| ファイルパス | 変更内容 |
|------------|---------|
| `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumQueryBuilder.kt` | s.artist → atr.artist（2箇所） |
| `tools/scripts/albums_importer.py` | track_artistカラム対応 |
| `tools/data/albums.csv` | track_artistカラム追加（ユーザー対応） |

### 確認のみ（変更不要）
| ファイルパス | 理由 |
|------------|------|
| `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumRowMapper.kt` | parts[2]の位置は変わらない |
| `backend/src/main/kotlin/com/shirogane/holy/knights/domain/Album.kt` | 既にartistフィールドあり |
| `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/AlbumDto.kt` | 既にartistフィールドあり |
| `frontend/src/features/discography/components/AlbumTrackList.tsx` | 既にtrack.artistを表示 |

## 残タスク

### 必須タスク
1. CSVデータのインポート実行
2. バックエンドAPI動作確認（`/api/albums`）
3. Playwright E2Eテストでフロントエンド動作確認

### テスト項目
1. **データインポート確認**:
   - albums_importer.pyが正常に実行される
   - album_tracksテーブルにartistデータが投入される
   - エラーが発生しない

2. **API動作確認**:
   - `/api/albums` APIのレスポンスにtracks[].artistが含まれる
   - artistの値が正しい（CSVのtrack_artistと一致）

3. **E2Eテスト**:
   - http://localhost:3001/discography でアルバム一覧が表示される
   - アルバムをクリックしてモーダルが表示される
   - トラックリストに各トラックのアーティスト名が表示される
   - コンピレーションアルバム（SPOTLIGHT vol.2）で複数アーティストが表示される

## 技術的メモ

### Liquibaseのchangelogファイル管理
- `backend/src/main/resources/db/changelog/changelog.xml`が`<includeAll path="changes"/>`で全てのマイグレーションファイルを読み込む
- ファイル名のプレフィックス番号順に実行される
- changelog-master.xmlへの個別登録は不要

### UUID型の扱い
- PostgreSQLではUUID型とVARCHAR型は互換性がない
- 外部キー制約では型が完全一致する必要がある
- マイグレーションファイル作成時は必ず既存テーブルの型を確認すること

### CSVデータ設計
- アルバムレベルの情報: artist（アルバム全体のアーティスト）
- トラックレベルの情報: track_artist（各トラックのアーティスト）
- track_artistが空の場合はアルバムのartistをフォールバック

## 次フェーズへの引き継ぎ

### TESTフェーズへ
実装は完了しましたが、以下の動作確認が必要です：
1. CSVデータインポート
2. API動作確認
3. E2Eテスト

これらの確認後、TESTフェーズで正式なテストを実施してください。

## 実装完了ステータス

### 完了した項目
- ✅ マイグレーションファイル作成（UUID型対応）
- ✅ マイグレーション実行成功
- ✅ AlbumQueryBuilder.kt修正
- ✅ albums_importer.py修正（track_artist対応）
- ✅ Docker Compose環境起動

### 未完了の項目
- ⏳ CSVデータインポート
- ⏳ バックエンドAPI動作確認
- ⏳ フロントエンドE2Eテスト

## 所要時間
- マイグレーションファイル作成: 20分（型不一致のトラブルシュート含む）
- バックエンド修正: 5分
- CSVインポートツール修正: 10分
- マイグレーション実行・確認: 15分
- **合計**: 約50分
