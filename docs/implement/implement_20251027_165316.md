# SPECIALS機能廃止 実装詳細記録

実装日時: 2025-10-27 16:53:16
実装者: Claude Code
計画書: docs/plan/plan_20251027_144626.md

## 1. 実装概要

SPECIALS機能を完全廃止しました。データベース、バックエンド、フロントエンド、ツールの全レイヤーから関連コードとデータを削除しました。

## 2. 実施内容

### 2.1 ブランチ作成
- ブランチ名: feature/remove-specials
- ベースブランチ: main
- 作成コマンド: `git checkout -b feature/remove-specials`

### 2.2 データベースマイグレーション作成

**作成ファイル:**
- `backend/src/main/resources/db/changelog/changes/037-drop-special-events-tables.sql`

**削除対象テーブル:**
1. messages
2. special_event_special_event_types
3. special_event_types
4. special_events

外部キー制約に従い、逆順でDROP TABLE文を記述しました。

### 2.3 バックエンド修正

#### 2.3.1 ApiGatewayRouter.kt の修正

**修正箇所:**

1. **import文削除（12行目）**
   ```kotlin
   import com.shirogane.holy.knights.adapter.controller.SpecialsController
   ```

2. **依存注入削除（26行目）**
   ```kotlin
   private val specialsController: SpecialsController,
   ```

3. **ルート定義削除（99-101行目）**
   ```kotlin
   RouteKey("GET", "/specials") to { _ ->
       specialsController.getSpecialEvents()
   },
   ```

4. **パスパラメータ処理削除（131-136行目）**
   ```kotlin
   if (httpMethod == "GET" && path.startsWith("/specials/") && path != "/specials/") {
       val eventId = path.removePrefix("/specials/")
       if (eventId.isNotBlank()) {
           return { _ -> specialsController.getSpecialEventDetails(eventId) }
       }
   }
   ```

#### 2.3.2 バックエンドファイル削除（22ファイル）

**コントローラー層（2ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/SpecialsController.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/port/SpecialsUseCasePort.kt

**ユースケース層（1ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/application/usecase/SpecialsUseCaseImpl.kt

**ドメイン層（3ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEvent.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEventType.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/Message.kt

**リポジトリ層（4ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/SpecialEventRepository.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/MessageRepository.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/SpecialEventRepositoryImpl.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/MessageRepositoryImpl.kt

**クエリビルダー層（2ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/SpecialEventQueryBuilder.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/MessageQueryBuilder.kt

**マッパー層（2ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/SpecialEventRowMapper.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/MessageRowMapper.kt

**エンティティ層（3ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventEntities.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventTypeEntity.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/MessageEntity.kt

**DTO層（3ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDto.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDetailDto.kt
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/MessageDto.kt

**その他（1ファイル）:**
- backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/model/SpecialEventSearchCriteria.kt

**テスト（1ファイル）:**
- backend/src/test/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouterSpecialsTest.kt

#### 2.3.3 バックエンドビルド確認

**実行コマンド:**
```bash
cd backend && ./gradlew clean build
```

**結果:**
- ✅ BUILD SUCCESSFUL in 51s
- ✅ コンパイルエラー: 0件
- ✅ テスト: 全てパス

### 2.4 フロントエンド修正

#### 2.4.1 フロントエンドディレクトリ削除（2ディレクトリ）

**削除コマンド:**
```bash
rm -rf frontend/src/app/specials/
rm -rf frontend/src/features/specials/
```

**削除されたファイル（15ファイル）:**
- frontend/src/app/specials/page.tsx
- frontend/src/app/specials/[id]/page.tsx
- frontend/src/app/specials/layout.tsx
- frontend/src/features/specials/hooks/useSpecials.ts
- frontend/src/features/specials/hooks/useSpecialEventDetail.ts
- frontend/src/features/specials/api/specialClient.ts
- frontend/src/features/specials/types/types.ts
- frontend/src/features/specials/components/grids/SpecialsGrid.tsx
- frontend/src/features/specials/components/cards/SpecialEventCard.tsx
- frontend/src/features/specials/components/cards/SkeletonSpecialEventCard.tsx
- frontend/src/features/specials/components/details/SpecialEventDetail.tsx
- frontend/src/features/specials/components/messages/MessagesGrid.tsx
- frontend/src/features/specials/components/messages/MessageCard.tsx
- frontend/src/features/specials/components/cards/internals/SpecialEventCardDescription.tsx
- frontend/src/features/specials/config/gridConfig.ts

#### 2.4.2 frontend/src/types/index.ts の修正

**削除箇所（68-73行目）:**
```typescript
export type {
  SpecialEventDto,
  MessageDto,
  SpecialEventDetailDto,
  SpecialEventSearchResultDto
} from '@/features/specials/types/types';
```

#### 2.4.3 フロントエンドビルド確認

**実行コマンド:**
```bash
cd frontend && pnpm build
```

**結果:**
- ✅ Compiled successfully in 3.6s
- ✅ TypeScriptコンパイルエラー: 0件
- ✅ ページ数: 12ページ（/specials と /specials/[id] が削除されたことを確認）

**ビルド前: 13ページ**
- /specials が含まれていた

**ビルド後: 12ページ**
- /specials が削除された

### 2.5 ツールファイル削除（2ファイル）

**削除コマンド:**
```bash
rm tools/scripts/special_events_importer.py
rm tools/data/special_events.csv
```

### 2.6 E2Eテスト実施

Playwright MCPツールを使用してE2Eテストを実施しました。

#### 2.6.1 主要ページの表示確認

**テスト対象ページ:**

1. **トップページ（/）**
   - ✅ 正常に表示
   - ✅ ナビゲーションメニューが機能

2. **アーカイブページ（/archives）**
   - ✅ 正常に表示
   - ✅ フィルタリング機能が表示

3. **カレンダーページ（/calendar）**
   - ✅ 正常に表示
   - ✅ カレンダーが表示

4. **ニュースページ（/news）**
   - ✅ 正常に表示
   - ✅ 検索機能が表示

5. **ソングページ（/songs）**
   - ✅ 正常に表示
   - ✅ 検索機能が表示

#### 2.6.2 SPECIALS削除確認

**テスト対象:**
- /specials へのアクセス

**結果:**
- ✅ 404エラーページが表示
- ✅ ページタイトル: "404: This page could not be found."
- ✅ コンソールエラー: "Failed to load resource: the server responded with a status of 404 (Not Found)"

## 3. 成功基準の達成状況

### 3.1 技術的成功基準
- ✅ バックエンドビルドがエラーなく完了
- ✅ バックエンドテストが全てパス
- ✅ フロントエンドビルドがエラーなく完了
- ✅ E2Eテストで主要機能が正常動作
- ✅ /specials へのアクセスが404エラーになる

### 3.2 品質基準
- ✅ コンパイルエラー: 0件
- ✅ テスト失敗: 0件
- ✅ 型定義エラー: 0件
- ✅ リンター警告: 新規発生なし

### 3.3 ドキュメント基準
- ✅ 調査結果ドキュメント: docs/investigate/investigate_20251027_134733.md
- ✅ 実装計画ドキュメント: docs/plan/plan_20251027_144626.md
- ✅ 実装詳細記録ドキュメント: docs/implement/implement_20251027_165316.md

## 4. ファイル変更サマリー

### 4.1 新規作成（1ファイル）
- backend/src/main/resources/db/changelog/changes/037-drop-special-events-tables.sql

### 4.2 修正（2ファイル）
- backend/src/main/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouter.kt
- frontend/src/types/index.ts

### 4.3 削除（37ファイル）
- バックエンド: 22ファイル
- フロントエンド: 15ファイル
- ツール: 2ファイル

## 5. 実装時の問題と解決

### 5.1 問題: フロントエンドディレクトリの削除漏れ

**問題内容:**
最初のディレクトリ削除後、ビルド時に /specials ページが残っていた。

**原因:**
作業ディレクトリが backend/ になっており、相対パスでの削除が失敗していた。

**解決策:**
親ディレクトリに移動して、正しい絶対パスで削除を実行:
```bash
cd .. && rm -rf frontend/src/app/specials/ frontend/src/features/specials/
```

**結果:**
再ビルド後、/specials ページが削除されたことを確認。

### 5.2 問題: Node.jsバージョンの切り替え

**問題内容:**
pnpm コマンドが見つからないエラーが発生。

**原因:**
nodenv で Node.js 20.5.1 がインストールされているが、シェルで有効化されていなかった。

**解決策:**
nodenv で Node.js バージョンを明示的に指定:
```bash
eval "$(nodenv init -)" && nodenv shell 20.5.1 && pnpm build
```

**結果:**
フロントエンドビルドが正常に完了。

## 6. 次のステップ

実装が完了しました。次のステップは以下の通りです:

1. ✅ 実装完了
2. ⏭️ コミット作成（TEST フェーズで実施）
3. ⏭️ プッシュ＆プルリクエスト作成（TEST フェーズで実施）

## 7. 備考

- 全ての作業は feature/remove-specials ブランチで実施
- バックエンド、フロントエンドともにビルドエラーなし
- E2Eテストで主要機能の動作確認完了
- /specials へのアクセスが404になることを確認
- 計画通りに全ての実装が完了
