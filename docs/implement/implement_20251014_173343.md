# 実装詳細: DayEventsModal/EventDetailModal モバイル表示改善

## 実装日時
2025-10-14 19:10:58

## プラン参照
`docs/plan/plan_20251014_173343.md`

## 実装概要
DayEventsModalとEventDetailModalをモバイルでフルスクリーン表示に変更し、視認性とナビゲーションを改善しました。

---

## 実装内容

### 1. 新規作成ファイル（3ファイル）

#### 1.1 FullScreenModal.tsx
**パス**: `frontend/src/components/FullScreenModal/FullScreenModal.tsx`

**実装内容**:
- フルスクリーンモーダルコンポーネントの作成
- `useViewportHeight`フックを使用してiOS Safari対応
- ヘッダー固定、コンテンツスクロール可能
- GPU加速アニメーション（`animate-full-screen-in`）
- z-index: `TAILWIND_Z_INDEX.CONTENT.MODAL`（57）

**主な機能**:
- `mobileVariant`プロパティで表示方法を選択可能
- 背景オーバーレイ（`FullScreenModalOverlay`）
- 動的高さ計算（`maxHeight`）でiOS Safariのアドレスバー対応

#### 1.2 FullScreenModalHeader.tsx
**パス**: `frontend/src/components/FullScreenModal/FullScreenModalHeader.tsx`

**実装内容**:
- 固定ヘッダーコンポーネント
- 戻るボタン（ChevronLeft）と閉じるボタン（X）
- タイトル表示
- 下部ボーダー（`border-b border-surface-border`）

**主な機能**:
- 条件付き戻るボタン表示（`backButton?.show`）
- IconButtonコンポーネント使用
- アクセシビリティ対応（`aria-label`）

#### 1.3 index.ts
**パス**: `frontend/src/components/FullScreenModal/index.ts`

**実装内容**:
- FullScreenModal と FullScreenModalHeader のエクスポート

---

### 2. 既存ファイル修正（6ファイル）

#### 2.1 globals.css
**パス**: `frontend/src/app/globals.css`
**変更箇所**: 605行目以降に追加

**追加内容**:
```css
/* FullScreenModal専用アニメーション */
@keyframes fullScreenSlideIn {
  from {
    opacity: 0;
    transform: translateY(-100%);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fullScreenSlideOut {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-100%);
  }
}

.animate-full-screen-in {
  animation: fullScreenSlideIn 350ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.animate-full-screen-out {
  animation: fullScreenSlideOut 250ms ease-in forwards;
}
```

**効果**:
- 上から下にスライドイン（`translateY(-100%)` → `translateY(0)`）
- GPU加速（`transform`と`opacity`のみ使用）
- 滑らかなイージング（`cubic-bezier(0.16, 1, 0.3, 1)`）

#### 2.2 Overlay.tsx
**パス**: `frontend/src/components/Overlay/Overlay.tsx`
**変更箇所**: 150行目以降に追加

**追加内容**:
```typescript
export function FullScreenModalOverlay(props: Omit<OverlayProps, 'zIndex' | 'variant'>) {
  return (
    <Overlay
      {...props}
      zIndex="modal"
      animate={true}
    />
  );
}
```

**効果**:
- ModalOverlayと同じz-index（50）を使用
- フェードインアニメーション有効

#### 2.3 ResponsiveModal.tsx
**パス**: `frontend/src/components/Modal/ResponsiveModal.tsx`

**変更内容**:
1. **import追加**:
   - `FullScreenModal` from `@/components/FullScreenModal`

2. **interface拡張**:
   - `mobileVariant?: 'bottomSheet' | 'fullScreen'` プロパティ追加

3. **コンポーネント本体変更**:
   - デフォルト値: `mobileVariant = 'bottomSheet'`（後方互換性）
   - 条件分岐: デスクトップ → Modal、モバイル＆fullScreen → FullScreenModal、モバイル＆bottomSheet → BottomSheet

**効果**:
- 後方互換性を保ちながら新機能を追加
- 既存のBottomSheetを使用するコンポーネントに影響なし

#### 2.4 Modal/index.ts
**パス**: `frontend/src/components/Modal/index.ts`

**追加内容**:
```typescript
export { FullScreenModal } from '@/components/FullScreenModal';
export { FullScreenModalHeader } from '@/components/FullScreenModal';
```

**効果**:
- 他のコンポーネントから直接FullScreenModalをimportできるように

#### 2.5 DayEventsModal.tsx
**パス**: `frontend/src/features/calendar/components/modals/DayEventsModal.tsx`
**変更箇所**: 32行目

**変更内容**:
```typescript
<ResponsiveModal
  isOpen={isOpen}
  onClose={onClose}
  title={`${date.toLocaleDateString('ja-JP')}のイベント`}
  className={shouldUseDesktopLayout ? "space-y-2 sm:space-y-3 max-h-[85vh] sm:max-h-[90vh] overflow-y-auto" : ""}
  mobileVariant="fullScreen"  // 追加
>
```

**効果**:
- モバイルでフルスクリーン表示
- デスクトップは従来通り中央モーダル表示

#### 2.6 EventDetailModal.tsx
**パス**: `frontend/src/features/calendar/components/modals/EventDetailModal.tsx`
**変更箇所**: 31行目

**変更内容**:
```typescript
<ResponsiveModal
  isOpen={isOpen}
  onClose={onClose}
  title={"イベント詳細"}
  backButton={fromDayModal && onBackToDayModal ? {
    show: true,
    onClick: onBackToDayModal
  } : undefined}
  mobileVariant="fullScreen"  // 追加
>
```

**効果**:
- モバイルでフルスクリーン表示
- 戻るボタンでDayEventsModalに戻れる
- デスクトップは従来通り中央モーダル表示

---

## 実装完了タスク

### ✅ フェーズ1: 基礎コンポーネント作成
1. ✅ FullScreenModal.tsx作成
2. ✅ FullScreenModalHeader.tsx作成
3. ✅ index.ts作成
4. ✅ globals.cssにアニメーション追加
5. ✅ Overlay.tsxにFullScreenModalOverlay追加

### ✅ フェーズ2: ResponsiveModal拡張
6. ✅ ResponsiveModal.tsxを拡張
7. ✅ Modal/index.tsにエクスポート追加

### ✅ フェーズ3: モーダルコンポーネント更新
8. ✅ DayEventsModal.tsxを更新
9. ✅ EventDetailModal.tsxを更新

---

## 技術的特徴

### 1. iOS Safari対応
- `useViewportHeight`フックで動的高さ計算
- アドレスバーの表示/非表示に対応
- `--viewport-height` CSS変数を使用

### 2. アニメーション最適化
- GPU加速（`transform`と`opacity`のみ）
- `cubic-bezier(0.16, 1, 0.3, 1)`で滑らかな動き
- アニメーション時間: 350ms（入り）、250ms（出）

### 3. 後方互換性
- デフォルト値`'bottomSheet'`で既存動作を維持
- SongDetailModalなど他のモーダルに影響なし
- TypeScript型定義で安全性を確保

### 4. アクセシビリティ
- `aria-label`でスクリーンリーダー対応
- キーボード操作（Escキーで閉じる）
- 背景スクロール制御

---

## 期待される効果

### 1. 視認性の向上
✅ イベント情報が画面全体で表示され、一覧性が向上
✅ スクロール可能な領域が広がり、コンテンツの全体像を把握しやすい
✅ 画像や説明文が大きく表示され、詳細情報が読みやすい

### 2. ナビゲーションの明確化
✅ フルスクリーン表示により、モーダル階層が明確に
✅ 戻るボタンの視認性が向上し、操作フローが理解しやすい
✅ DayEventsModal ⇄ EventDetailModalの遷移が自然

### 3. UX改善
✅ BottomSheetの「引き上げる」操作が不要
✅ イベント一覧やイベント詳細を集中して閲覧できる
✅ モバイル操作のストレスが軽減

### 4. 柔軟性の確保
✅ 各モーダルで最適な表示方法を選択可能
✅ 将来的に他のモーダルも簡単にフルスクリーン化できる
✅ `mobileVariant`プロパティで拡張性を確保

---

## テスト状況

### 実施したテスト
- ✅ コンポーネントの作成と統合
- ✅ TypeScript型チェック
- ✅ ビルド確認
- ✅ 開発サーバーでの動作確認（一部）

### 未実施のテスト（推奨）
- ⏸️ E2Eテスト: DayEventsModalフルスクリーン表示
- ⏸️ E2Eテスト: EventDetailModal遷移と戻る動作
- ⏸️ E2Eテスト: SongDetailModal現状維持確認（BottomSheet）
- ⏸️ E2Eテスト: デスクトップ表示の回帰テスト
- ⏸️ iOS Safari実機テスト
- ⏸️ Android Chrome実機テスト

**注**: Playwright MCPツールでE2Eテストを実施しようとしましたが、ツールの技術的問題により一部完了できませんでした。手動テストまたは後日の再実施を推奨します。

---

## ファイル変更サマリー

### 新規作成（3ファイル）
1. `frontend/src/components/FullScreenModal/FullScreenModal.tsx`
2. `frontend/src/components/FullScreenModal/FullScreenModalHeader.tsx`
3. `frontend/src/components/FullScreenModal/index.ts`

### 修正（6ファイル）
1. `frontend/src/app/globals.css` - アニメーション追加
2. `frontend/src/components/Overlay/Overlay.tsx` - FullScreenModalOverlay追加
3. `frontend/src/components/Modal/ResponsiveModal.tsx` - mobileVariant追加
4. `frontend/src/components/Modal/index.ts` - エクスポート追加
5. `frontend/src/features/calendar/components/modals/DayEventsModal.tsx` - mobileVariant指定
6. `frontend/src/features/calendar/components/modals/EventDetailModal.tsx` - mobileVariant指定

---

## 次のステップ

### 1. テスト実施
- [ ] Playwright MCPツールまたは手動でE2Eテストを実施
- [ ] iOS Safari実機テスト
- [ ] Android Chrome実機テスト

### 2. パフォーマンス確認
- [ ] アニメーション性能チェック
- [ ] レンダリング性能チェック
- [ ] メモリリーク確認

### 3. SongDetailModalの判断
- [ ] BottomSheetでの動作確認
- [ ] 必要に応じて`mobileVariant="fullScreen"`を追加

---

## 実装完了ステータス

**ステータス**: ✅ SUCCESS
**次フェーズ**: TEST
**詳細**: 実装完了。implement_20251014_173343.mdに詳細記録。テストフェーズへ移行推奨。
