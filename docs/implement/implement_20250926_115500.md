# オーバーレイコンポーネント共通化実装詳細

## 実装概要

**実装日時**: 2025-09-26 11:55:00
**対象ブランチ**: feature/responsive-modal-component
**実装方針**: 段階的リファクタリングによる共通化

## 実装内容

### Phase 1: 基盤構築

#### 1.1 z-index定数管理ファイル作成
- **ファイル**: `/frontend/src/constants/zIndex.ts`
- **内容**:
  - z-index値の一元管理
  - Tailwindクラス用の定数
  - 型定義の追加
- **構成**:
  - 基本レイヤー (0-10)
  - オーバーレイレイヤー (40-49)
  - コンテンツレイヤー (50-59)

#### 1.2 共通Overlayコンポーネント作成
- **ファイル**: `/frontend/src/components/ui/Overlay.tsx`
- **機能**:
  - 表示/非表示制御
  - ESCキーハンドリング
  - スクロール制御
  - クリックハンドリング
  - アニメーション制御
  - Portal対応
- **プリセット**:
  - `NavigationOverlay`: ナビゲーション用
  - `ModalOverlay`: モーダル用
  - `BottomSheetOverlay`: BottomSheet用

### Phase 2: 段階的移行

#### 2.1 ヘッダーのOverlay共通化
- **対象ファイル**: `/frontend/src/components/header/internals/Navigation.tsx`
- **変更内容**:
  - 独自Overlayコンポーネント削除
  - `NavigationOverlay`を使用するよう修正
  - createPortalの必要がなくなり簡素化
  - ESCキーハンドリングをOverlayに委譲
- **削除ファイル**: `/frontend/src/components/header/internals/Overlay.tsx`
- **修正**: `/frontend/src/components/index.ts`からエクスポート削除

#### 2.2 BottomSheetのオーバーレイ共通化
- **対象ファイル**: `/frontend/src/components/common/BottomSheet/BottomSheet.tsx`
- **変更内容**:
  - 内部オーバーレイ実装を`BottomSheetOverlay`に置換
  - ESCキーハンドリングを共通Overlayに移譲
  - スクロール制御を共通Overlayに移譲
  - pointer-eventsの制御は残存（BottomSheet固有の仕様）

#### 2.3 Modalのオーバーレイ共通化
- **対象ファイル**: `/frontend/src/components/ui/Modal.tsx`
- **変更内容**:
  - 背景オーバーレイを`ModalOverlay`に置換
  - ESCキーハンドリングを共通Overlayに移譲
  - スクロール制御を共通Overlayに移譲
  - アニメーション制御は維持
  - backdrop click処理を共通Overlayに移譲

### Phase 3: E2Eテスト実行

#### 3.1 テスト結果
- **ナビゲーションメニュー**: ✅ 正常動作
  - ハンバーガーメニューの開閉
  - ESCキーでの閉じる操作
  - オーバーレイクリックでの閉じる操作

- **BottomSheet**: ✅ 正常動作
  - 検索・絞り込みメニューの表示
  - ESCキーでの閉じる操作
  - オーバーレイの適切な表示

- **全体**: ✅ 正常動作
  - ページロード正常
  - レスポンシブデザイン維持
  - アニメーション維持

## ファイル変更詳細

### 新規作成ファイル
1. `/frontend/src/constants/zIndex.ts`
2. `/frontend/src/components/ui/Overlay.tsx`

### 修正ファイル
1. `/frontend/src/components/header/internals/Navigation.tsx`
2. `/frontend/src/components/common/BottomSheet/BottomSheet.tsx`
3. `/frontend/src/components/ui/Modal.tsx`
4. `/frontend/src/components/index.ts`

### 削除ファイル
1. `/frontend/src/components/header/internals/Overlay.tsx`

## 技術的成果

### コード削減
- 重複するオーバーレイ実装を3箇所から1箇所に統合
- 合計約60行のコード削減

### 保守性向上
- z-index管理の一元化
- 統一されたオーバーレイ動作
- 型安全性の向上

### 機能統一
- ESCキーハンドリングの統一
- スクロール制御の統一
- アニメーション制御の標準化

## 課題と解決

### 課題1: 既存機能の互換性維持
**解決**: プリセット関数による段階的移行で既存APIを維持

### 課題2: z-index競合の回避
**解決**: 定数による一元管理とレイヤー設計

### 課題3: アニメーション設定の維持
**解決**: animate propによる柔軟な制御

## 今後の改善点

### 短期
- ResponsiveModalでの共通Overlay活用
- 他のモーダル系コンポーネントの移行

### 長期
- オーバーレイコンポーネントのドキュメント作成
- パフォーマンス監視の設定
- ユーザビリティテストの実施

## 結論

オーバーレイコンポーネントの共通化により、以下を達成：

1. **コード品質向上**: 重複排除とメンテナンス性向上
2. **一貫性確保**: 統一されたUX提供
3. **開発効率向上**: 新規オーバーレイ機能の迅速な実装が可能

全ての既存機能を維持しつつ、保守しやすい設計に成功した。E2Eテストでも全機能の正常動作を確認済み。