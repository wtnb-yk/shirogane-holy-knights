# 実装計画書 - CalendarBottomSheetContent SelectableList リファクタリング

## プロジェクト概要
- **作成日**: 2025-09-24 23:36:54
- **更新日**: 2025-09-24 23:40:00
- **ブランチ**: feature/calendar-selectable-list
- **対象**: `frontend/src/features/calendar/components/CalendarBottomSheetContent.tsx`のSelectableListリファクタリング
- **参考調査**: `docs/investigate/investigate_20250924_233119.md`

## 実装方針（更新版）

### 1. EventTypePresetsSectionコンポーネントの新規作成
- YearPresetsSectionと同様の設計パターンを採用
- `frontend/src/components/common/EventTypePresetsSection.tsx`として作成
- SelectableList<EventType>を内部で使用

### 2. CalendarBottomSheetContentの簡略化
- EventTypePresetsSectionコンポーネントを呼び出すだけの実装に変更
- SongsBottomSheetContentでYearPresetsSectionを使用するパターンと同様

### 3. 状態管理の変換実装
- EventTypePresetsSection内部で実装
- **内部状態**: `selectedEventTypeObjects: EventType[]`
- **外部インターフェース維持**: `selectedEventTypes: number[]`（後方互換性のため）
- number[] ↔ EventType[]の相互変換ロジック実装

### 4. 単一選択ロジックの実装
```typescript
const handleEventTypeToggle = (eventType: EventType) => {
  if (selectedEventTypeObjects.some(selected => selected.id === eventType.id)) {
    // 選択解除: 空配列に設定
    onEventTypeChange([]);
  } else {
    // 単一選択: そのタイプのみ選択
    onEventTypeChange([eventType.id]);
  }
};
```

## 詳細実装タスク

### 優先度：高（Phase 1）
1. **EventTypePresetsSection.tsxの新規作成**
   - SelectableListコンポーネントを使用した実装
   - getEventTypeLabel関数の実装
   - 内部状態変換ロジック（number[] ↔ EventType[]）
   - 単一選択handleEventTypeToggleの実装

2. **CalendarBottomSheetContent.tsxのリファクタリング**
   - EventTypePresetsSectionのインポート追加
   - 既存のUI実装を削除
   - EventTypePresetsSectionコンポーネント呼び出しに置き換え
   - UIの簡略化（84行 → 約15行への削減予定）

### 優先度：中（Phase 2）
2. **動作確認とテスト**
   - TypeScript型チェック実行
   - lint・build確認
   - Playwrightでの動作確認（E2Eテスト）

## ファイル変更計画

### 新規作成ファイル
- `frontend/src/components/common/EventTypePresetsSection.tsx` - **新規作成**

### 修正対象ファイル
- `frontend/src/features/calendar/components/CalendarBottomSheetContent.tsx` - **修正**

### 依存関係（変更なし）
- `frontend/src/components/common/SelectableList.tsx` - 既存利用
- `frontend/src/components/common/SelectableListHeader.tsx` - 既存利用
- `frontend/src/components/common/SelectableListItem.tsx` - 既存利用
- `frontend/src/features/calendar/types.ts` - EventType型定義（既存利用）

## テスト戦略

### E2Eテスト（Playwright）
1. **イベントタイプフィルタ動作確認**
   - 各イベントタイプの選択・選択解除動作
   - 「全て」ボタンの選択解除動作
   - 単一選択ロジックの確認（同時に複数選択されないこと）

2. **UI/UX確認**
   - デザインの一貫性（SelectableListの統一スタイル）
   - アクセシビリティ（role, aria-selected属性の確認）
   - アニメーション・ホバー効果の確認

3. **回帰テスト**
   - 既存のカレンダーフィルタリング機能の正常動作
   - 外部コンポーネント（親コンポーネント）との連携確認

### 型チェック・静的解析
- TypeScriptコンパイル確認
- ESLintチェック
- Next.jsビルド確認

## リスク分析と対策

### 低リスク
- **SelectableList安定性**: 既存実装が安定しており問題なし
- **型安全性**: TypeScriptによる型チェックで保証
- **デザイン一貫性**: SelectableListの統一デザインシステム

### 中リスク - 対策済み
- **データ型変換エラー**: TypeScript型チェック + 段階的実装で対策
- **選択動作の変化**: Playwrightでの動作確認で対策

## 期待される効果

### 1. コード品質向上
- **行数削減**: 84行 → 約15行（82%削減）
- **重複実装排除**: 独自UIからSelectableListへ統一
- **型安全性強化**: EventType型の一貫使用
- **コンポーネント分離**: 責務の明確な分離

### 2. 保守性向上
- **共通改善適用**: SelectableListの改善が自動適用
- **デザインシステム統一**: 一貫したUI/UX
- **コードレビュー効率**: シンプルで理解しやすい実装

### 3. アクセシビリティ向上
- **WAI-ARIA準拠**: 自動的に適用
- **キーボードナビゲーション**: SelectableListで対応済み

## 実装スケジュール

### Phase 1: コアリファクタリング（優先度：高）
1. EventTypePresetsSection.tsxの新規作成
2. CalendarBottomSheetContent.tsxの実装変更
3. TypeScript型チェック・lint確認
4. 基本動作確認

### Phase 2: テスト・検証（優先度：中）
1. Playwrightでの動作確認
2. 回帰テストの実行
3. UI/UX確認

## 完了条件

### 必須条件
- [ ] CalendarBottomSheetContent.tsxがSelectableListを使用している
- [ ] 既存の選択ロジック（単一選択）が正常動作する
- [ ] 外部インターフェース（selectedEventTypes: number[]）が維持されている
- [ ] TypeScriptエラーなし
- [ ] Next.jsビルド成功

### 推奨条件
- [ ] Playwrightでの動作確認完了
- [ ] コード行数削減達成（84行→約15行）
- [ ] デザインの一貫性確認
- [ ] アクセシビリティ確認

## 技術的詳細

### SelectableList使用パターン
```typescript
<SelectableList<EventType>
  title="タイプ"
  items={eventTypes}
  selectedItems={selectedEventTypeObjects}
  onItemToggle={handleEventTypeToggle}
  onClearAll={handleClearAll}
  getDisplayName={getEventTypeLabel}
  getItemKey={(eventType) => eventType.id}
  allOptionLabel="全て"
/>
```

### 状態変換ユーティリティ
```typescript
// number[] → EventType[]
const selectedEventTypeObjects = useMemo(() =>
  eventTypes.filter(eventType => selectedEventTypes.includes(eventType.id)),
  [eventTypes, selectedEventTypes]
);

// EventType → number[]（handleEventTypeToggleで使用）
const handleEventTypeToggle = (eventType: EventType) => {
  // 実装詳細は上記参照
};
```

## 結論

**実装推奨**: 技術的リスクが低く、大幅なコード品質向上が期待できる。既存機能を完全に維持しながら、統一されたデザインシステムへの移行が可能。Phase 1の実装完了後、すぐにPhase 2のテスト・検証を実施し、安全な本番展開を行う。