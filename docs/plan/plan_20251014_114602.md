# 実装計画: event_typesテーブルへのCOLLABORATIONレコード追加

## プラン概要

### 策定日時
2025-10-14 11:46:02

### 実装目的
event_typesテーブルに新しいレコード「collaboration」を追加し、フロントエンド・ツールを対応させる

### 調査結果サマリー
- **news_categoriesテーブル**: 既にCOLLABORATIONが存在 → 実装不要
- **event_typesテーブル**: collaborationが存在しない → 実装が必要
- 既存の実装パターン（campaign, othersの追加例）を踏襲可能

### 実装難易度
- **難易度**: 低
- **推定所要時間**: 1-2時間
- **影響範囲**: データベース、フロントエンド、ツール

## 実装方針

### 基本方針
既存の実装パターン（campaign, othersの追加例）に従い、以下の3層で同期的に実装を行う：

1. **データベース層**: マイグレーションファイルでレコード追加
2. **フロントエンド層**: ユーティリティとスタイル定義を更新
3. **ツール層**: インポータのマッピングを更新

### 設計上の決定事項

#### 1. バッジカラーの選定
- **選定色**: `purple` (紫)
- **理由**:
  - 既存の色（blue, orange, green, gray）との重複を避ける
  - campaignの緑色と差別化が必要
  - ニュースカテゴリのCOLLABORATIONも緑色のため、視覚的な区別が重要

#### 2. 日本語ラベル
- **ラベル**: `コラボ`
- **理由**: ニュースカテゴリとの統一性を保つ

#### 3. データベースIDの扱い
- **ID**: 自動採番（SERIAL）に依存 → 予想では5
- **対策**: ツールのget_event_type_mapping関数でデータベースから動的に取得するため、ID固定の懸念なし

## 詳細実装タスク

### 優先度1（最優先）: データベースマイグレーション

#### タスク1.1: マイグレーションファイル作成
- **ファイルパス**: `backend/src/main/resources/db/changelog/changes/032-add-collaboration-event-type.sql`
- **作業内容**: event_typesテーブルに'collaboration'レコードを追加
- **理由**: データベース層が基盤となるため最優先

#### タスク1.2: マイグレーション実行確認
- **作業内容**: Docker環境でマイグレーションを実行し、レコード追加を確認
- **確認方法**:
  ```sql
  SELECT * FROM event_types WHERE type = 'collaboration';
  ```

### 優先度2（高）: フロントエンド実装

#### タスク2.1: イベントタイプユーティリティの更新
- **ファイルパス**: `frontend/src/features/calendar/utils/eventTypeUtils.ts`
- **作業内容**: getEventTypeLabel関数に'collaboration'ケースを追加
- **期待される動作**: 'collaboration'タイプが「コラボ」として表示される

#### タスク2.2: バッジスタイルの更新
- **ファイルパス**: `frontend/src/features/calendar/utils/eventBadgeStyles.ts`
- **作業内容**: EVENT_TYPE_COLOR_MAPに'collaboration': 'purple'を追加
- **期待される動作**: collaborationイベントのバッジが紫色で表示される

### 優先度3（中）: ツール実装

#### タスク3.1: カレンダーインポータの更新
- **ファイルパス**: `tools/scripts/calendar_importer.py`
- **作業内容**: EVENT_TYPE_MAPPINGに'collaboration': 5を追加
- **注意点**: IDはプレースホルダーとして5を設定するが、実際の取得はget_event_type_mapping関数で行われる

### 優先度4（必須）: E2Eテスト実施

#### タスク4.1: Playwright MCPツールでの動作確認
- **確認項目**:
  1. カレンダーページの表示
  2. collaborationイベントのバッジ表示
  3. バッジの色が紫色であることを確認
  4. フィルタリング機能の動作確認

## ファイル変更計画

### 新規作成ファイル

#### 1. データベースマイグレーション
- **ファイルパス**: `backend/src/main/resources/db/changelog/changes/032-add-collaboration-event-type.sql`
- **ファイルタイプ**: SQL
- **サイズ見込み**: 約10行
- **内容**:
```sql
--liquibase formatted sql

--changeset shirogane:032-add-collaboration-event-type
--comment: Add collaboration event type to event_types table

-- コラボレーションタイプを追加
INSERT INTO event_types (type) VALUES ('collaboration');
```

### 修正ファイル

#### 1. フロントエンド - イベントタイプユーティリティ
- **ファイルパス**: `frontend/src/features/calendar/utils/eventTypeUtils.ts`
- **変更内容**: getEventTypeLabel関数に'collaboration'ケースを追加
- **変更箇所**: switch文内（約3行追加）
- **修正後のコード**:
```typescript
export const getEventTypeLabel = (type: string): string => {
  switch (type) {
    case 'event':
      return 'イベント';
    case 'goods':
      return 'グッズ';
    case 'campaign':
      return 'キャンペーン';
    case 'collaboration':  // 追加
      return 'コラボ';
    case 'others':
      return 'その他';
    default:
      return type;
  }
};
```

#### 2. フロントエンド - バッジスタイル
- **ファイルパス**: `frontend/src/features/calendar/utils/eventBadgeStyles.ts`
- **変更内容**: EVENT_TYPE_COLOR_MAPに'collaboration'を追加
- **変更箇所**: オブジェクト定義内（1行追加）
- **修正後のコード**:
```typescript
const EVENT_TYPE_COLOR_MAP: Record<string, BadgeColor> = {
  event: 'blue',
  goods: 'orange',
  campaign: 'green',
  collaboration: 'purple',  // 追加
  others: 'gray'
};
```

#### 3. ツール - カレンダーインポータ
- **ファイルパス**: `tools/scripts/calendar_importer.py`
- **変更内容**: EVENT_TYPE_MAPPINGに'collaboration'を追加
- **変更箇所**: 辞書定義内（1行追加）
- **修正後のコード**:
```python
EVENT_TYPE_MAPPING = {
    'event': 1,
    'goods': 2,
    'campaign': 3,
    'others': 4,
    'collaboration': 5,  # 新規追加
}
```

### 変更なしファイル（参考）
以下のファイルは変更不要：
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/CalendarEntities.kt`（エンティティ定義は汎用的）
- `frontend/src/features/calendar/types.ts`（型定義は汎用的）
- `tools/scripts/news_importer.py`（news_categoriesは既に対応済み）

## テスト戦略

### 1. データベース層のテスト

#### テスト1.1: マイグレーション実行確認
- **テスト種別**: 統合テスト
- **テスト方法**:
  1. Docker環境でバックエンドを起動
  2. マイグレーションが自動実行されることを確認
  3. データベースクエリでレコードを確認
- **期待結果**:
  - event_typesテーブルに'collaboration'レコードが存在
  - IDが正しく採番されている（予想: 5）

#### テスト1.2: データ整合性確認
- **テスト種別**: 統合テスト
- **テスト方法**: 既存のイベントタイプ（event, goods, campaign, others）が影響を受けていないことを確認
- **期待結果**: 既存レコードに変更がない

### 2. ツール層のテスト

#### テスト2.1: カレンダーインポータの動作確認
- **テスト種別**: 統合テスト
- **テスト方法**:
  1. テスト用CSVファイルを作成（collaborationタイプのイベントを含む）
  2. calendar_importer.pyを実行
  3. データベースにイベントが正しくインポートされることを確認
- **期待結果**:
  - collaborationタイプのイベントがevent_typesとの関連付けで正しくインポートされる
  - event_event_types中間テーブルに正しいレコードが作成される

### 3. フロントエンド層のテスト

#### テスト3.1: E2Eテスト（Playwright MCP）
- **テスト種別**: E2Eテスト
- **テスト方法**:
  1. http://localhost:3001 にアクセス
  2. カレンダーページに遷移
  3. collaborationタイプのイベントを確認
- **確認項目**:
  - バッジが紫色で表示されること
  - ラベルが「コラボ」と表示されること
  - バッジのスタイルが適切に適用されていること
  - マウスホバー時の動作が正常であること

#### テスト3.2: フィルタリング機能の確認
- **テスト種別**: E2Eテスト
- **テスト方法**:
  1. カレンダーページでフィルタ機能を使用
  2. 'collaboration'タイプでフィルタリング
  3. 適切にイベントが絞り込まれることを確認
- **期待結果**: collaborationタイプのイベントのみが表示される

#### テスト3.3: 視覚的回帰テスト
- **テスト種別**: ビジュアルテスト
- **テスト方法**: Playwrightのスクリーンショット機能を使用して、バッジの表示を確認
- **期待結果**: 紫色のバッジが既存のバッジと調和して表示される

### 4. 統合テスト

#### テスト4.1: エンドツーエンドフロー確認
- **テスト種別**: 統合テスト
- **テスト方法**:
  1. CSVでcollaborationイベントをインポート
  2. バックエンドAPIでイベント取得
  3. フロントエンドで表示確認
- **期待結果**: データがバックエンドからフロントエンドまで一貫して正しく処理される

## リスク分析と対策

### リスク1: データベースID自動採番の不確実性

#### リスク内容
- **レベル**: 低
- **説明**: collaborationのIDが必ず5になる保証はない（他のマイグレーションが先に実行される可能性）
- **影響範囲**: ツールのマッピング

#### 対策
1. **主要対策**: get_event_type_mapping関数がデータベースから動的に取得するため、実質的な問題なし
2. **補助対策**: マイグレーション実行後、ログでIDを確認
3. **確認方法**: データベースクエリでIDを直接確認

### リスク2: バッジ色の視認性

#### リスク内容
- **レベル**: 低-中
- **説明**: 紫色が他の色と区別しにくい可能性
- **影響範囲**: UI/UX

#### 対策
1. **主要対策**: E2Eテストで視覚的に確認
2. **補助対策**: 必要に応じて色を調整（pink, indigoなど）
3. **確認方法**: Playwrightでスクリーンショット取得し、視認性を確認

### リスク3: フロントエンドのスタイル競合

#### リスク内容
- **レベル**: 低
- **説明**: 既存のバッジスタイルとの競合によりレイアウトが崩れる可能性
- **影響範囲**: UI表示

#### 対策
1. **主要対策**: E2Eテストで複数のイベントタイプを同時に表示し、レイアウトを確認
2. **補助対策**: 既存のbadge-purpleクラスが正しく定義されていることを確認
3. **確認方法**: Playwrightで実際のページを確認

### リスク4: ツールの後方互換性

#### リスク内容
- **レベル**: 極低
- **説明**: 既存のCSVファイルや処理に影響を与える可能性
- **影響範囲**: データインポート

#### 対策
1. **主要対策**: 新規タイプの追加は既存のマッピングに影響を与えないため、後方互換性は保たれる
2. **補助対策**: テスト用CSVで既存タイプのインポートも同時にテスト
3. **確認方法**: 既存のcalendar_events.csvを使用してインポートテスト

### リスク5: マイグレーション実行タイミング

#### リスク内容
- **レベル**: 低
- **説明**: 他の開発者が同時に別のマイグレーションを追加している可能性
- **影響範囲**: ファイル番号の衝突

#### 対策
1. **主要対策**: 最新のマイグレーションファイルを確認し、適切な番号を割り当てる
2. **補助対策**: PRを早期に作成し、他の開発者に通知
3. **確認方法**: git statusとchangelogディレクトリの確認

## 実装スケジュール

### フェーズ1: データベース実装（30分）
1. マイグレーションファイル作成（10分）
2. Docker環境でマイグレーション実行（10分）
3. データベース確認（10分）

### フェーズ2: フロントエンド実装（30分）
1. eventTypeUtils.ts修正（10分）
2. eventBadgeStyles.ts修正（10分）
3. ローカルビルド確認（10分）

### フェーズ3: ツール実装（10分）
1. calendar_importer.py修正（5分）
2. コード確認（5分）

### フェーズ4: E2Eテスト（30分）
1. Playwright MCPツールでのテスト実行（20分）
2. 問題があれば修正（10分）

### フェーズ5: 最終確認とコミット（20分）
1. 全体的な動作確認（10分）
2. コミットメッセージ作成（5分）
3. プッシュとPR作成（5分）

**合計推定時間**: 約2時間

## 実装順序

実装は以下の順序で進める：

1. **データベース層（最優先）**
   - マイグレーションファイル作成
   - マイグレーション実行確認

2. **フロントエンド層**
   - eventTypeUtils.ts修正
   - eventBadgeStyles.ts修正

3. **ツール層**
   - calendar_importer.py修正

4. **テスト層**
   - E2Eテスト実施
   - 問題があれば前のステップに戻る

5. **最終確認**
   - 全体的な動作確認
   - コミット・プッシュ

## 成功基準

以下の条件をすべて満たすこと：

### データベース層
- [ ] event_typesテーブルに'collaboration'レコードが存在する
- [ ] IDが正しく採番されている
- [ ] 既存のレコードに影響がない

### フロントエンド層
- [ ] カレンダーページでcollaborationバッジが表示される
- [ ] バッジの色が紫色である
- [ ] ラベルが「コラボ」と表示される
- [ ] 既存のイベントタイプの表示に影響がない

### ツール層
- [ ] collaborationタイプのイベントをCSVからインポートできる
- [ ] event_event_typesテーブルに正しい関連付けが作成される

### E2Eテスト
- [ ] Playwright MCPツールで動作確認が完了している
- [ ] フィルタリング機能が正常に動作する
- [ ] 視覚的な不具合がない

### 全体
- [ ] ビルドエラーがない
- [ ] 既存の機能に影響がない
- [ ] コードレビューで問題が指摘されない

## 参考資料

### 調査ドキュメント
- `docs/investigate/investigate_20251014_114122.md` - 詳細な調査結果

### 既存の実装例
- `backend/src/main/resources/db/changelog/changes/022-add-campaign-event-type.sql` - campaign追加の参考例
- `backend/src/main/resources/db/changelog/changes/030-add-others-event-type.sql` - others追加の参考例

### 関連ファイル
- `frontend/src/features/calendar/utils/eventTypeUtils.ts` - イベントタイプユーティリティ
- `frontend/src/features/calendar/utils/eventBadgeStyles.ts` - バッジスタイル定義
- `tools/scripts/calendar_importer.py` - カレンダーインポータ

## 次のアクション

実装フェーズ（IMPLEMENT）に移行し、上記の計画に従って実装を開始する。

### 最初のステップ
1. マイグレーションファイルの作成
2. Docker環境での動作確認
3. フロントエンド実装

### 注意事項
- 各ステップで動作確認を行う
- 問題があれば早期に対処する
- E2Eテストを必ず実施する
- コミット前に全体的な動作確認を行う

## まとめ

この実装計画は、event_typesテーブルへのcollaborationレコード追加を、既存の実装パターンに従って安全かつ効率的に実行するためのものである。

- **実装難易度**: 低
- **推定所要時間**: 1-2時間
- **リスクレベル**: 低
- **既存システムへの影響**: 最小限

計画に従って実装を進めることで、高品質な実装を短時間で完了できる見込みである。