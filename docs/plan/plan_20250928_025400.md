# BottomSheetスクロール高さ問題 - 実装計画書

**作成日時**: 2025-09-28 02:54:00
**担当者**: Claude Code
**対象ブランチ**: main
**前提調査**: docs/investigate/investigate_20250928_021253.md

## 実装概要

### 問題の要約
SongsページのBottomSheetで、スクロール発生時にBottomSheet自体が画面下端まで表示されず、下の画面が見えてしまう問題を解決する。

### 根本原因
BottomSheet.tsx:37行目で、フォールバック値 `calc(100vh - 64px)` と実際の値 `getMaxHeight(64)` の計算基準に不整合がある。

## 実装方針

### 選択した解決方法
**方法1**: フォールバック値をCSS変数ベースに変更

**変更内容:**
```tsx
// 修正前
const maxHeight = isLoaded ? getMaxHeight(64) : 'calc(100vh - 64px)';

// 修正後
const maxHeight = isLoaded ? getMaxHeight(64) : 'calc(var(--viewport-height) - 64px)';
```

### 選択理由
1. **最小限の変更**: 1ファイル1行の修正のみ
2. **一貫性の確保**: CSS変数は既にuseViewportHeightで設定済み
3. **影響範囲の限定**: 他コンポーネントへの予期しない影響を回避
4. **既存資産の活用**: CSS変数を有効活用

## ファイル変更計画

### 修正対象ファイル
| ファイルパス | 変更内容 | 変更箇所 |
|-------------|----------|----------|
| `frontend/src/components/common/BottomSheet/BottomSheet.tsx` | フォールバック値修正 | 37行目 |

### 変更しないファイル
- `frontend/src/hooks/useViewportHeight.ts` - CSS変数設定は維持
- `frontend/src/app/globals.css` - CSS変数定義は維持
- その他のBottomSheet使用箇所 - 影響なし

## 実装タスク詳細

### Phase 1: 実装
1. **BottomSheet.tsx修正**
   - 37行目の修正: `'calc(100vh - 64px)'` → `'calc(var(--viewport-height) - 64px)'`

### Phase 2: テスト
2. **Playwright MCPでのE2Eテスト**
   - ローカルサーバー起動 (`npm run dev`)
   - `http://localhost:3001` でテスト実行

3. **テストシナリオ**
   - **基本動作**: Songsページでのフィルタ・検索BottomSheetの表示確認
   - **高さ確認**: BottomSheetが画面下端まで正しく表示されることの確認
   - **スクロール**: スクロール時の高さ維持確認
   - **レスポンシブ**: モバイル/デスクトップでの表示確認
   - **エッジケース**: ページリロード、複数回開閉の確認
   - **他ページ影響**: Calendarページでの動作確認

## リスク分析

### 特定されたリスク
1. **CSS変数の互換性**: 低リスク - useViewportHeightで確実に設定
2. **初期レンダリング**: 低リスク - 素早い初期化により影響最小限
3. **他コンポーネント影響**: なし - 既存CSS変数の活用
4. **ブラウザ互換性**: なし - モダンブラウザ対応

### 総合リスク評価: **極めて低**

## 成功基準

### 機能要件
- [ ] SongsページのBottomSheetが画面下端まで正しく表示される
- [ ] スクロール時にBottomSheetの高さが適切に維持される
- [ ] 初期表示とロード完了後の表示に一貫性がある

### 非機能要件
- [ ] 他のBottomSheet使用箇所に悪影響がない
- [ ] デスクトップビューのModal表示は正常動作
- [ ] パフォーマンスに悪影響がない

### テスト要件
- [ ] モバイル/デスクトップビューで正常動作
- [ ] 複数ブラウザで表示確認
- [ ] エッジケースでの安定動作

## 実装後の確認事項

### 必須確認項目
1. **視覚的確認**: スクリーンショットによる修正前後の比較
2. **機能確認**: フィルタ・検索機能の正常動作
3. **レスポンシブ確認**: デバイス切り替え時の表示
4. **パフォーマンス確認**: 表示速度に問題がないこと

### 推奨確認項目
1. **他ページ確認**: Calendar、Streamなど他ページでのBottomSheet
2. **ブラウザ互換性**: Chrome、Safari、Firefox での表示
3. **アクセシビリティ**: スクリーンリーダーでの正常動作

## 実装スケジュール

### 推定工数
- **実装**: 5分（1行修正）
- **テスト**: 30分（Playwright MCP使用）
- **確認**: 15分（追加確認）
- **合計**: 約50分

### 実装優先度
**高**: ユーザビリティに直接影響し、特にSongsページで顕著な問題

## 次フェーズへの引き継ぎ

### IMPLEMENTフェーズで実行すべき内容
1. BottomSheet.tsx の37行目修正
2. Playwright MCPでの動作確認
3. 成功基準に基づく最終確認

### 注意事項
- CLAUDE.mdの指示に従い、必ずPlaywright MCPでの動作確認を実施すること
- 修正は非常にシンプルだが、テストは十分に行うこと
- 問題が解決していない場合は「解決していない」と正直に報告すること

## まとめ

この実装は最小限の変更で最大の効果を得られる効率的な解決策です。既存のCSS変数を活用することで、安全かつ確実に問題を解決できます。