# 実装計画書: ページング設定リファクタリング

## 計画日時
2025-10-04 22:06:37

## 関連ドキュメント
- 調査報告書: `docs/investigate/investigate_20251004_214427.md`
- ブランチ: `feature/refactor-pagination-config`

## 実装目的
ページング設定を一元管理し、メンテナンス性と一貫性を向上させる。

## 実装方針

### 基本方針
1. **フロントエンド**: 各機能ごとに`config/pagination.ts`を作成し、設定を一元管理
2. **バックエンド**: デフォルト値をフロントエンドに合わせ、パラメータ名を統一
3. **段階的実装**: バックエンド → フロントエンド設定 → フロントエンド既存コード → テスト の順

### 確定ページサイズ

| 機能 | ページサイズ | 理由 |
|------|-------------|------|
| Songs | 20 | グリッドレイアウトとの親和性 |
| News | 12 | カード表示に最適 |
| Discography | 12 | アルバムアート表示に適切 |
| Archives | 20 | 動画サムネイル表示量 |

### アーキテクチャ設計

**設定ファイル構造:**
```typescript
// features/{feature}/config/pagination.ts
export const PAGINATION_CONFIG = {
  PAGE_SIZE: XX,
  INITIAL_PAGE: 1,
} as const;
```

**使用パターン:**
```typescript
import { PAGINATION_CONFIG } from '../config/pagination';

// Hook内
const { pageSize = PAGINATION_CONFIG.PAGE_SIZE, ...} = options;

// ページコンポーネント内
useXxx({ pageSize: PAGINATION_CONFIG.PAGE_SIZE })
```

## 実装タスク詳細

### 【優先度：高】フェーズ1: バックエンド修正

#### タスク1-1: SongDto.kt修正（パラメータ名統一）
**ファイル:** `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SongDto.kt`

**修正内容:**
1. SongSearchParamsDto
   - `val size: Int = 20` → `val pageSize: Int = 20`
   - `fun toPageRequest() = PageRequest(page, size)` → `PageRequest(page, pageSize)`

2. StreamSongSearchParamsDto
   - `val size: Int = 20` → `val pageSize: Int = 20`
   - `fun toPageRequest() = PageRequest(page, size)` → `PageRequest(page, pageSize)`

**影響範囲:** フロントエンドのAPIクライアントも同時修正が必要

**テスト:** ビルド成功確認

#### タスク1-2: AlbumDto.kt修正（デフォルト値変更）
**ファイル:** `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/AlbumDto.kt`

**修正内容:**
- AlbumSearchParamsDto (131行目)
  - `val pageSize: Int = 20` → `val pageSize: Int = 12`

**理由:** フロントエンドの推奨値に合わせる

**テスト:** ビルド成功確認

#### タスク1-3: NewsDto.kt修正（デフォルト値変更）
**ファイル:** `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/NewsDto.kt`

**修正内容:**
- NewsSearchParamsDto (83行目)
  - `val pageSize: Int = 20` → `val pageSize: Int = 12`

**理由:** フロントエンドの推奨値に合わせる

**テスト:** ビルド成功確認

### 【優先度：高】フェーズ2: フロントエンド設定ファイル作成

#### タスク2-1: Songs設定ファイル作成
**ファイル:** `frontend/src/features/songs/config/pagination.ts`

**内容:**
```typescript
export const PAGINATION_CONFIG = {
  PAGE_SIZE: 20,
  INITIAL_PAGE: 1,
} as const;
```

#### タスク2-2: News設定ファイル作成
**ファイル:** `frontend/src/features/news/config/pagination.ts`

**内容:**
```typescript
export const PAGINATION_CONFIG = {
  PAGE_SIZE: 12,
  INITIAL_PAGE: 1,
} as const;
```

#### タスク2-3: Discography設定ファイル作成
**ファイル:** `frontend/src/features/discography/config/pagination.ts`

**内容:**
```typescript
export const PAGINATION_CONFIG = {
  PAGE_SIZE: 12,
  INITIAL_PAGE: 1,
} as const;
```

#### タスク2-4: Archives設定ファイル作成
**ファイル:** `frontend/src/features/archives/config/pagination.ts`

**内容:**
```typescript
export const PAGINATION_CONFIG = {
  PAGE_SIZE: 20,
  INITIAL_PAGE: 1,
} as const;
```

### 【優先度：中】フェーズ3: フロントエンドAPIクライアント修正

#### タスク3-1: Songs APIクライアント修正
**対象ファイル:** Songs関連のAPIクライアント（調査必要）

**修正内容:**
- パラメータ名を `size` → `pageSize` に変更
- バックエンドのパラメータ名変更に対応

**検索方法:**
```bash
grep -r "size" frontend/src/features/songs/api/
```

### 【優先度：中】フェーズ4: フロントエンドHook修正

#### タスク4-1: useStreamSongs.ts修正
**ファイル:** `frontend/src/features/songs/hooks/useStreamSongs.ts`

**修正箇所:**
- 40行目: `const { pageSize = 12, initialPage = 1 } = options;`
  →  `const { pageSize = PAGINATION_CONFIG.PAGE_SIZE, initialPage = PAGINATION_CONFIG.INITIAL_PAGE } = options;`

**インポート追加:**
```typescript
import { PAGINATION_CONFIG } from '../config/pagination';
```

#### タスク4-2: useConcertSongs.ts修正
**ファイル:** `frontend/src/features/songs/hooks/useConcertSongs.ts`

**修正箇所:**
- 40行目: `const { pageSize = 12, initialPage = 1 } = options;`
  →  `const { pageSize = PAGINATION_CONFIG.PAGE_SIZE, initialPage = PAGINATION_CONFIG.INITIAL_PAGE } = options;`

**インポート追加:**
```typescript
import { PAGINATION_CONFIG } from '../config/pagination';
```

#### タスク4-3: useNews.ts修正
**ファイル:** `frontend/src/features/news/hooks/useNews.ts`

**修正箇所:**
- 37行目: `const { pageSize = 20, initialPage = 1 } = options;`
  →  `const { pageSize = PAGINATION_CONFIG.PAGE_SIZE, initialPage = PAGINATION_CONFIG.INITIAL_PAGE } = options;`

**インポート追加:**
```typescript
import { PAGINATION_CONFIG } from '../config/pagination';
```

#### タスク4-4: useDiscography.ts修正
**ファイル:** `frontend/src/features/discography/hooks/useDiscography.ts`

**修正箇所:**
- 38行目: `const { pageSize = 20, initialPage = 1 } = options;`
  →  `const { pageSize = PAGINATION_CONFIG.PAGE_SIZE, initialPage = PAGINATION_CONFIG.INITIAL_PAGE } = options;`

**インポート追加:**
```typescript
import { PAGINATION_CONFIG } from '../config/pagination';
```

#### タスク4-5: useVideos.ts修正
**ファイル:** `frontend/src/features/archives/hooks/useVideos.ts`

**修正箇所:**
- 42行目: `const {pageSize = 20, initialPage = 1} = options;`
  →  `const {pageSize = PAGINATION_CONFIG.PAGE_SIZE, initialPage = PAGINATION_CONFIG.INITIAL_PAGE} = options;`

**インポート追加:**
```typescript
import { PAGINATION_CONFIG } from '../config/pagination';
```

#### タスク4-6: useStreams.ts修正
**ファイル:** `frontend/src/features/archives/hooks/useStreams.ts`

**修正箇所:**
- 42行目: `const {pageSize = 20, initialPage = 1} = options;`
  →  `const {pageSize = PAGINATION_CONFIG.PAGE_SIZE, initialPage = PAGINATION_CONFIG.INITIAL_PAGE} = options;`

**インポート追加:**
```typescript
import { PAGINATION_CONFIG } from '../config/pagination';
```

### 【優先度：中】フェーズ5: フロントエンドページコンポーネント修正

#### タスク5-1: app/songs/page.tsx修正
**ファイル:** `frontend/src/app/songs/page.tsx`

**修正箇所:**
1. インポート追加:
```typescript
import { PAGINATION_CONFIG } from '@/features/songs/config/pagination';
```

2. 29-33行目: Hook呼び出し
```typescript
const streamSongsData = useStreamSongs({
  pageSize: PAGINATION_CONFIG.PAGE_SIZE
});

const concertSongsData = useConcertSongs({
  pageSize: PAGINATION_CONFIG.PAGE_SIZE
});
```

3. 176行目: Paginationコンポーネント
```typescript
<Pagination
  currentPage={currentData.currentPage}
  totalPages={currentData.totalPages}
  hasMore={currentData.hasMore}
  onPageChange={currentData.setCurrentPage}
  totalCount={currentData.totalCount}
  pageSize={PAGINATION_CONFIG.PAGE_SIZE}
  loading={currentData.loading}
/>
```

#### タスク5-2: app/news/page.tsx修正
**ファイル:** `frontend/src/app/news/page.tsx`

**修正箇所:**
1. インポート追加:
```typescript
import { PAGINATION_CONFIG } from '@/features/news/config/pagination';
```

2. 31行目: useNews呼び出し
```typescript
} = useNews({ pageSize: PAGINATION_CONFIG.PAGE_SIZE });
```

3. 102行目: Paginationコンポーネント
```typescript
pageSize={PAGINATION_CONFIG.PAGE_SIZE}
```

#### タスク5-3: app/discography/page.tsx修正
**ファイル:** `frontend/src/app/discography/page.tsx`

**修正箇所:**
1. 15行目: 既存のPAGE_SIZE定数削除
```typescript
const PAGE_SIZE = 12;  // この行を削除
```

2. インポート追加:
```typescript
import { PAGINATION_CONFIG } from '@/features/discography/config/pagination';
```

3. 37, 119行目: PAGE_SIZE参照を変更
```typescript
// 37行目
} = useDiscography({ pageSize: PAGINATION_CONFIG.PAGE_SIZE });

// 119行目
pageSize={PAGINATION_CONFIG.PAGE_SIZE}
```

#### タスク5-4: app/archives/page.tsx修正
**ファイル:** `frontend/src/app/archives/page.tsx`

**修正箇所:**
1. インポート追加:
```typescript
import { PAGINATION_CONFIG } from '@/features/archives/config/pagination';
```

2. 23-24行目: Hook呼び出し
```typescript
const videosData = useVideos({pageSize: PAGINATION_CONFIG.PAGE_SIZE});
const streamsData = useStreams({pageSize: PAGINATION_CONFIG.PAGE_SIZE});
```

3. 145行目: Paginationコンポーネント
```typescript
pageSize={PAGINATION_CONFIG.PAGE_SIZE}
```

### 【優先度：高】フェーズ6: 動作確認

#### タスク6-1: バックエンドビルド確認
**コマンド:**
```bash
cd backend
./gradlew build
```

**成功基準:** ビルドエラーなし

#### タスク6-2: フロントエンドビルド確認
**コマンド:**
```bash
cd frontend
pnpm build
```

**成功基準:** ビルドエラー、型エラーなし

#### タスク6-3: Playwright E2Eテスト
**テスト対象:**
1. Songs機能
   - ページング表示確認
   - ページサイズ20確認
   - ページ遷移確認

2. News機能
   - ページング表示確認
   - ページサイズ12確認
   - ページ遷移確認

3. Discography機能
   - ページング表示確認
   - ページサイズ12確認
   - ページ遷移確認

4. Archives機能
   - ページング表示確認
   - ページサイズ20確認
   - ページ遷移確認

**実行方法:**
CLAUDE.mdの指示に従い、Playwrightを使用してブラウザで動作確認

## ファイル変更計画

### 新規作成（4ファイル）
1. `frontend/src/features/songs/config/pagination.ts`
2. `frontend/src/features/news/config/pagination.ts`
3. `frontend/src/features/discography/config/pagination.ts`
4. `frontend/src/features/archives/config/pagination.ts`

### 修正（14ファイル）

**バックエンド（3ファイル）:**
1. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SongDto.kt`
   - パラメータ名統一: size → pageSize

2. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/AlbumDto.kt`
   - デフォルト値変更: 20 → 12

3. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/NewsDto.kt`
   - デフォルト値変更: 20 → 12

**フロントエンド（11ファイル）:**

Hook（6ファイル）:
4. `frontend/src/features/songs/hooks/useStreamSongs.ts`
5. `frontend/src/features/songs/hooks/useConcertSongs.ts`
6. `frontend/src/features/news/hooks/useNews.ts`
7. `frontend/src/features/discography/hooks/useDiscography.ts`
8. `frontend/src/features/archives/hooks/useVideos.ts`
9. `frontend/src/features/archives/hooks/useStreams.ts`

ページコンポーネント（4ファイル）:
10. `frontend/src/app/songs/page.tsx`
11. `frontend/src/app/news/page.tsx`
12. `frontend/src/app/discography/page.tsx`
13. `frontend/src/app/archives/page.tsx`

APIクライアント（1ファイル）:
14. Songs APIクライアント（調査後確定）

### 削除
なし

## テスト戦略

### 1. ビルドテスト
**目的:** 型エラー、コンパイルエラーの検出

**手順:**
1. バックエンドビルド: `cd backend && ./gradlew build`
2. フロントエンドビルド: `cd frontend && pnpm build`

**成功基準:** エラーなくビルド完了

### 2. E2Eテスト（Playwright使用）
**目的:** 実際の動作確認

**テスト項目:**

#### Songs機能
- [ ] ページング表示が正常
- [ ] ページサイズが20
- [ ] 総件数が正確
- [ ] ページ遷移が正常

#### News機能
- [ ] ページング表示が正常
- [ ] ページサイズが12
- [ ] 総件数が正確
- [ ] ページ遷移が正常

#### Discography機能
- [ ] ページング表示が正常
- [ ] ページサイズが12
- [ ] 総件数が正確
- [ ] ページ遷移が正常

#### Archives機能（Videos & Streams）
- [ ] ページング表示が正常
- [ ] ページサイズが20
- [ ] 総件数が正確
- [ ] ページ遷移が正常

**実行環境:**
- ブラウザ: PlaywrightのMCPツール使用
- URL: http://localhost:3001

### 3. 統合テスト
**目的:** フロント・バックエンド連携確認

**確認項目:**
- APIリクエストのパラメータ名が正しい（pageSize）
- APIレスポンスが正常
- ページサイズがフロント・バックエンドで一致

## リスク分析と対策

### リスク1: パラメータ名変更の影響
**レベル:** 中

**内容:**
- size → pageSize変更がAPIに影響
- フロントエンドのAPIクライアントとの不整合

**対策:**
1. バックエンド・フロントエンドを同時に修正
2. E2Eテストで動作確認
3. APIリクエストをブラウザのネットワークタブで確認

**検証方法:**
- Playwrightでネットワークリクエストを監視
- パラメータ名が`pageSize`であることを確認

### リスク2: ページサイズ変更によるUI崩れ
**レベル:** 低

**内容:**
- ページサイズ変更でグリッドレイアウトが崩れる可能性
- 特にNewsとDiscographyで12に変更

**対策:**
1. Playwrightでスクリーンショット取得
2. 各ページのレイアウト確認
3. レスポンシブデザインの確認

**検証方法:**
- 各機能のページを目視確認
- グリッド表示が正常であることを確認

### リスク3: 修正漏れ
**レベル:** 低

**内容:**
- 設定ファイルへの参照漏れ
- ハードコードされた値の残存

**対策:**
1. 修正対象ファイルリストを作成
2. チェックリスト形式で確認
3. grepで数値の残存確認

**検証方法:**
```bash
# ハードコードされたページサイズを検索
grep -rn "pageSize.*=.*[0-9]" frontend/src/features/*/hooks/
grep -rn "pageSize.*[0-9]" frontend/src/app/*/page.tsx
```

### リスク4: ビルド失敗
**レベル:** 低

**内容:**
- インポートパスの誤り
- 型エラー

**対策:**
1. 段階的にビルド確認
2. 各ファイル修正後に型チェック
3. エディタのLintエラー確認

**検証方法:**
- `pnpm build`コマンドでビルド確認
- TypeScriptの型エラーがないこと確認

## 実装順序

### ステップ1: バックエンド修正
1. SongDto.kt修正（パラメータ名統一）
2. AlbumDto.kt修正（デフォルト値変更）
3. NewsDto.kt修正（デフォルト値変更）
4. バックエンドビルド確認

### ステップ2: フロントエンド設定ファイル作成
5. Songs設定ファイル作成
6. News設定ファイル作成
7. Discography設定ファイル作成
8. Archives設定ファイル作成

### ステップ3: フロントエンドAPIクライアント修正
9. Songs APIクライアント調査
10. パラメータ名修正（size → pageSize）

### ステップ4: フロントエンドHook修正
11. useStreamSongs.ts修正
12. useConcertSongs.ts修正
13. useNews.ts修正
14. useDiscography.ts修正
15. useVideos.ts修正
16. useStreams.ts修正

### ステップ5: フロントエンドページコンポーネント修正
17. app/songs/page.tsx修正
18. app/news/page.tsx修正
19. app/discography/page.tsx修正
20. app/archives/page.tsx修正

### ステップ6: 動作確認
21. フロントエンドビルド確認
22. Playwright E2Eテスト実施
23. 問題があれば修正、なければ完了

## 成功基準

### 必須条件
- [ ] バックエンドビルドが成功
- [ ] フロントエンドビルドが成功
- [ ] 型エラーがない
- [ ] E2Eテストが全て合格

### 確認事項
- [ ] 各機能のページサイズが設定通り（Songs:20, News:12, Discography:12, Archives:20）
- [ ] 設定ファイルから一元管理できている
- [ ] ハードコードされた値がない
- [ ] パラメータ名が統一されている（pageSize）

### 品質基準
- [ ] コードの可読性が向上
- [ ] 設定変更が1箇所で完結
- [ ] フロント・バックエンド間で設定値が一致

## ロールバック計画

### 問題発生時の対応
1. E2Eテストで問題検出
2. 問題の特定と原因分析
3. 修正可能であれば修正、不可能であれば以下を実施

### ロールバック手順
```bash
# ブランチを削除してmainに戻る
git checkout main
git branch -D feature/refactor-pagination-config
```

### 再実施の判断基準
- E2Eテストが全て失敗
- ビルドが成功しない
- UI崩れが複数機能で発生

## 次フェーズ

実装フェーズに移行し、上記の実装順序に従って作業を進める。

---
作成日時: 2025-10-04 22:06:37
作成者: Claude Code (plan phase)
ブランチ: feature/refactor-pagination-config
関連調査: docs/investigate/investigate_20251004_214427.md
