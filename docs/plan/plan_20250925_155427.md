# PageLayout責務整理 実装計画

## 計画概要
- **計画日時**: 2025年9月25日 15:54:27
- **対象**: PageLayoutとResponsiveSidebarの責務整理
- **ブランチ**: feature/sidebar-responsibilities
- **前段階**: 調査フェーズ完了（investigate_20250925_152440.md）

## 実装方針

### 問題の再確認
1. **責務の重複**: PageLayoutの`sidebar`/`mobileActions`とResponsiveSidebarの`desktopContent`/`mobileContent`で画面幅対応が二重管理
2. **API一貫性不足**: `sidebar`プロパティが何を指すか不明確
3. **関連性の不可視化**: デスクトップサイドバーとそのモーダル（SongSearchOptionsModal等）の関係が見えない

### 解決アプローチ
PageLayoutが画面幅対応を一元管理し、ResponsiveSidebarの責務を吸収する設計に変更

### 新しいPageLayoutインターフェース
```typescript
interface PageLayoutProps {
  // 基本プロパティ（変更なし）
  title: string;
  description: React.ReactNode;
  children: React.ReactNode;
  primaryTabs?: React.ReactNode;

  // 新しい統合プロパティ（オプショナル）
  desktopSidebar?: {
    content: React.ReactNode;
    // サイドバーに関連するモーダル
    modal?: {
      isOpen: boolean;
      onClose: () => void;
      content: React.ReactNode;
    };
  };

  mobileBottomSheet?: {
    trigger: React.ReactNode;  // FilterToggleButton
    isOpen: boolean;
    onClose: () => void;
    title?: string;
    content: React.ReactNode;
  };
}
```

## 詳細実装タスク

### フェーズ1: コア実装（優先度: 最高）

#### タスク1.1: PageLayout.tsxの拡張
**ファイル**: `/frontend/src/components/common/PageLayout.tsx`

**実装内容**:
- 新しいプロパティ（`desktopSidebar`、`mobileBottomSheet`）の追加
- 既存プロパティ（`sidebar`、`mobileActions`）との後方互換性維持
- GenericSidebarとBottomSheetの直接インポートと使用
- 画面幅に応じた表示制御（`hidden lg:block`、`lg:hidden`）

**成功基準**:
- 新旧両方のAPIが動作する
- TypeScriptエラーがない
- 既存ページが壊れない

### フェーズ2: 段階的移行（優先度: 高）

#### タスク2.1: songs/page.tsxの移行
**変更内容**:
- ResponsiveSidebarの削除
- SongSearchOptionsModalを`desktopSidebar.modal`に移動
- FilterToggleButtonを`mobileBottomSheet.trigger`に移動
- 状態管理の簡略化（`isSidebarOpen`を`mobileBottomSheet.isOpen`に統一）

**テストポイント**:
- デスクトップ: サイドバー表示、検索オプションモーダルの開閉
- モバイル: ボトムシート開閉、検索・フィルター機能

#### タスク2.2: calendar/page.tsxの移行
**変更内容**:
- ResponsiveSidebarの削除
- DayEventsModalの扱い検討（サイドバー関連モーダルか独立モーダルか）
- FilterToggleButtonの移行

**注意点**:
- DayEventsModalとEventDetailModalの連携を維持
- モバイルのDayEventsBottomSheetとの整合性

#### タスク2.3: news/page.tsxの移行
**変更内容**:
- シンプルな移行（モーダルなし）
- ResponsiveSidebarの削除
- 新APIへの置き換え

#### タスク2.4: discography/page.tsxの移行
**変更内容**:
- ResponsiveSidebarの削除
- 新APIへの置き換え

#### タスク2.5: archives/page.tsxの移行
**変更内容**:
- ResponsiveSidebarの削除
- 新APIへの置き換え

### フェーズ3: クリーンアップ（優先度: 中）

#### タスク3.1: ResponsiveSidebarの廃止
**条件**: 全5ページの移行完了後
**作業**:
- `/frontend/src/components/common/Sidebar/ResponsiveSidebar.tsx`の削除
- 不要なインポートの削除
- エクスポート文の更新

#### タスク3.2: 旧APIの削除
**条件**: 全ページが新APIに移行後
**作業**:
- PageLayoutから`sidebar`、`mobileActions`プロパティを削除
- TypeScript型定義の更新

## ファイル変更計画

### 新規作成
- なし（既存ファイルの修正のみ）

### 修正対象
1. `/frontend/src/components/common/PageLayout.tsx` - コア機能拡張
2. `/frontend/src/app/songs/page.tsx` - 新API対応
3. `/frontend/src/app/calendar/page.tsx` - 新API対応
4. `/frontend/src/app/news/page.tsx` - 新API対応
5. `/frontend/src/app/discography/page.tsx` - 新API対応
6. `/frontend/src/app/archives/page.tsx` - 新API対応

### 削除対象（最終フェーズ）
1. `/frontend/src/components/common/Sidebar/ResponsiveSidebar.tsx`

## テスト戦略

### 単体テスト
- 各コンポーネントの props 変更に対するテスト
- 後方互換性の確認

### 統合テスト
- ページレベルでの動作確認
- データフローの検証

### E2Eテスト（Playwright MCP使用）

#### デスクトップビュー（1920x1080）
1. 各ページでサイドバーが表示されることを確認
2. songs: SongSearchOptionsModalの開閉
3. calendar: DayEventsModalの開閉
4. フィルター・検索機能の動作確認

#### モバイルビュー（375x667）
1. FilterToggleButtonの表示と動作
2. BottomSheetの開閉アニメーション
3. コンテンツのスクロール
4. 背景のスクロール防止

#### レスポンシブテスト
1. ウィンドウリサイズ時の表示切り替え
2. ブレークポイント（lg: 1024px）での適切な切り替え

## リスク分析と対策

### リスク1: 既存機能の破損
**影響度**: 高
**発生確率**: 中
**対策**:
- 後方互換性を維持した段階的移行
- 各ページごとにE2Eテスト実施
- ロールバック計画の準備

### リスク2: TypeScript型エラー
**影響度**: 中
**発生確率**: 高
**対策**:
- オプショナルプロパティとして新APIを追加
- 段階的な型定義の更新
- ビルドチェックの頻繁な実行

### リスク3: パフォーマンス劣化
**影響度**: 低
**発生確率**: 低
**対策**:
- React.memoの適切な使用
- 不要な再レンダリングの防止
- DevToolsでのパフォーマンス計測

### リスク4: モーダル状態管理の複雑化
**影響度**: 中
**発生確率**: 中
**対策**:
- calendarページは慎重に実装
- 状態管理ロジックの文書化
- 段階的なテスト実施

## 実装スケジュール

### Day 1（2-3時間）
- [ ] PageLayout.tsxの拡張
- [ ] songs/page.tsxの移行
- [ ] 基本的なE2Eテスト

### Day 2（1-2時間）
- [ ] calendar/page.tsxの移行（慎重に）
- [ ] news/page.tsxの移行
- [ ] 中間テスト実施

### Day 3（1時間）
- [ ] discography/page.tsxの移行
- [ ] archives/page.tsxの移行
- [ ] ResponsiveSidebar削除
- [ ] 最終テスト実施

## 成功指標

### 定量的指標
- [ ] 5/5ページの移行完了
- [ ] TypeScriptエラー: 0
- [ ] E2Eテスト成功率: 100%
- [ ] コード行数削減: 約100行（ResponsiveSidebar削除による）

### 定性的指標
- [ ] APIの一貫性向上
- [ ] 責務の明確化
- [ ] コードの可読性向上
- [ ] 保守性の向上

## 次のアクション

1. **実装開始前の確認**
   - 現在のテストスイートの実行
   - ブランチの最新化
   - 依存関係の確認

2. **実装開始**
   - PageLayout.tsxから着手
   - 小さなコミット単位で進行
   - 各段階でのテスト実施

3. **完了後の作業**
   - ドキュメント更新
   - プルリクエスト作成
   - コードレビュー依頼

## 結論

**status: SUCCESS**
**next: IMPLEMENT**
**details**: 実装プラン策定完了。plan_20250925_155427.mdに詳細記録。実装フェーズに移行。