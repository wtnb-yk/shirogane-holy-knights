# 実装計画: SPECIALS イベントタイプ機能追加

## 策定日時
2025-10-17 17:41:11

## 実装対象
SPECIALSにイベントタイプ機能を追加し、Messages用の詳細画面を実装する

## 実装方針

### 基本方針
1. **既存パターンの踏襲**: カレンダー機能のevent_typesパターンを参考にspecial_event_typesを実装
2. **段階的実装**: データベース → バックエンド → フロントエンド の順で実装
3. **ドメイン駆動設計の維持**: 既存のレイヤー構成を維持し、統一されたアーキテクチャを保つ
4. **動作確認重視**: 各フェーズで動作確認を行い、問題を早期に発見・修正
5. **E2Eテスト必須**: Playwright MCPツールでユーザー視点の動作確認を実施

### 設計上の重要決定事項
1. **マスタテーブルのID型**: SERIAL（カレンダーパターン踏襲）
2. **イベントID型**: UUID（既存special_events踏襲）
3. **リレーションテーブル**: 複合主キー（special_event_id, special_event_type_id）
4. **初期タイプ**: "messages" のみ実装（将来的に拡張可能）
5. **詳細画面**: 専用ページ（/specials/[id]）で実装（モーダルではなく）

## 詳細実装タスク

### フェーズ1: データベース設計・実装（優先度：高）

#### タスク1-1: マイグレーションファイル作成
- **ファイル**: `backend/src/main/resources/db/changelog/changes/036-create-special-event-types-tables.sql`
- **内容**:
  1. special_event_typesマスタテーブル作成
  2. special_event_special_event_typesリレーションテーブル作成
  3. messagesテーブル作成
  4. 外部キー制約設定
  5. インデックス作成
  6. 初期データ投入（"messages"タイプ）
- **推定時間**: 1時間

#### タスク1-2: マイグレーション登録
- **ファイル**: `backend/src/main/resources/db/changelog/db.changelog-master.xml`
- **内容**: 036番マイグレーションを追加
- **推定時間**: 10分

#### タスク1-3: 既存データへのデフォルトタイプ割り当てスクリプト作成
- **目的**: 既存のspecial_eventsにデフォルトタイプを割り当てる
- **方法**: マイグレーション内にINSERT文を含める、または別スクリプト作成
- **推定時間**: 30分

#### タスク1-4: マイグレーション実行・確認
- **内容**:
  1. ローカル環境でマイグレーション実行
  2. テーブル作成確認
  3. 外部キー制約確認
  4. インデックス確認
- **推定時間**: 30分

**フェーズ1合計推定時間**: 2時間10分

---

### フェーズ2: バックエンド実装（優先度：高）

#### タスク2-1: Entity追加
- **新規ファイル**:
  1. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventTypeEntity.kt`
     - special_event_typesテーブルのマッピング
  2. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/MessageEntity.kt`
     - messagesテーブルのマッピング
- **修正ファイル**:
  - `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventEntities.kt`
    - eventTypesプロパティ追加
- **推定時間**: 1時間

#### タスク2-2: Mapper追加・拡張
- **新規ファイル**:
  1. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/MessageRowMapper.kt`
     - messagesテーブルのRowMapper
- **修正ファイル**:
  - `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/SpecialEventRowMapper.kt`
    - JOINしたタイプ情報を含める
- **推定時間**: 1時間

#### タスク2-3: QueryBuilder追加・拡張
- **新規ファイル**:
  1. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/MessageQueryBuilder.kt`
     - special_event_idによるメッセージ取得クエリ
- **修正ファイル**:
  - `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/SpecialEventQueryBuilder.kt`
    - タイプを含むJOIN処理追加
- **推定時間**: 1時間

#### タスク2-4: Repository拡張
- **新規ファイル**:
  1. `backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/MessageRepository.kt`
     - メッセージリポジトリインターフェース
  2. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/MessageRepositoryImpl.kt`
     - メッセージリポジトリ実装
- **修正ファイル**:
  - `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/SpecialEventRepositoryImpl.kt`
    - 詳細取得時にタイプを含める
- **推定時間**: 1時間

#### タスク2-5: ドメインモデル追加
- **新規ファイル**:
  1. `backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/Message.kt`
     - メッセージドメインモデル
- **修正ファイル**:
  - `backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEvent.kt`
    - eventTypesプロパティ追加（必要に応じて）
- **推定時間**: 30分

#### タスク2-6: DTO追加・拡張
- **新規ファイル**:
  1. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/MessageDto.kt`
     - メッセージDTO
  2. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDetailDto.kt`
     - イベント詳細DTO（イベント + メッセージリスト）
- **修正ファイル**:
  - `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDto.kt`
    - eventTypesプロパティ追加
- **推定時間**: 30分

#### タスク2-7: UseCase拡張
- **修正ファイル**:
  - `backend/src/main/kotlin/com/shirogane/holy/knights/application/usecase/SpecialsUseCaseImpl.kt`
    - getSpecialEventDetailsメソッド拡張
    - メッセージ取得処理追加
- **推定時間**: 1時間

#### タスク2-8: Controller拡張
- **修正ファイル**:
  - `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/SpecialsController.kt`
    - getSpecialEventDetailsレスポンスをSpecialEventDetailDtoに変更
- **推定時間**: 30分

#### タスク2-9: バックエンド動作確認
- **内容**:
  1. ビルド確認
  2. API動作確認（/specials/{id}）
  3. レスポンス形式確認
- **推定時間**: 30分

**フェーズ2合計推定時間**: 6時間

---

### フェーズ3: フロントエンド実装（優先度：中）

#### タスク3-1: 型定義拡張
- **修正ファイル**:
  - `frontend/src/features/specials/types/types.ts`
    - MessageDto追加
    - SpecialEventDetailDto追加
    - SpecialEventDtoにeventTypes追加
- **推定時間**: 20分

#### タスク3-2: API Client拡張
- **修正ファイル**:
  - `frontend/src/features/specials/api/specialClient.ts`
    - getSpecialEventDetailsメソッド追加
- **推定時間**: 20分

#### タスク3-3: 詳細ページ作成
- **新規ファイル**:
  - `frontend/src/app/specials/[id]/page.tsx`
    - 動的ルーティングページ
    - イベント詳細取得
    - メタデータ設定
- **推定時間**: 1時間

#### タスク3-4: イベント詳細コンポーネント作成
- **新規ファイル**:
  - `frontend/src/features/specials/components/details/SpecialEventDetail.tsx`
    - イベント基本情報表示
    - メッセージリスト表示
    - レイアウト・スタイリング
- **推定時間**: 1時間

#### タスク3-5: メッセージ表示コンポーネント作成
- **新規ファイル**:
  1. `frontend/src/features/specials/components/messages/MessagesList.tsx`
     - メッセージリスト表示
     - 空状態ハンドリング
  2. `frontend/src/features/specials/components/messages/MessageCard.tsx`
     - 個別メッセージカード
     - 名前、メッセージ、日時表示
- **推定時間**: 1時間30分

#### タスク3-6: ルーティング修正
- **修正ファイル**:
  - `frontend/src/app/specials/page.tsx`
    - handleEventClickでページ遷移実装
    - useRouterフック使用
- **推定時間**: 20分

#### タスク3-7: フロントエンド動作確認
- **内容**:
  1. ビルド確認
  2. 一覧ページ表示確認
  3. カードクリック動作確認
  4. 詳細ページ表示確認
  5. メッセージ表示確認
- **推定時間**: 30分

**フェーズ3合計推定時間**: 4時間20分

---

### フェーズ4: テスト・検証（優先度：高）

#### タスク4-1: E2Eテスト（Playwright MCP）
- **テストシナリオ**:
  1. イベント一覧ページ表示
  2. イベントカードクリック
  3. 詳細ページ遷移確認
  4. イベント基本情報表示確認
  5. メッセージリスト表示確認
  6. 戻るボタン動作確認
  7. レスポンシブデザイン確認
- **推定時間**: 1時間

#### タスク4-2: 統合テスト
- **テスト内容**:
  1. API エンドポイントテスト（/specials/{id}）
  2. レスポンス形式確認
  3. エラーハンドリング確認
- **推定時間**: 30分

#### タスク4-3: デバッグ・修正
- **内容**: テストで発見された問題の修正
- **推定時間**: 1時間

#### タスク4-4: ロールバックテスト
- **内容**: マイグレーションのロールバック動作確認
- **推定時間**: 30分

**フェーズ4合計推定時間**: 3時間

---

## ファイル変更計画

### 新規作成ファイル（14ファイル）

#### バックエンド（9ファイル）
1. `backend/src/main/resources/db/changelog/changes/036-create-special-event-types-tables.sql`
2. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventTypeEntity.kt`
3. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/MessageEntity.kt`
4. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/MessageRowMapper.kt`
5. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/MessageQueryBuilder.kt`
6. `backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/Message.kt`
7. `backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/MessageRepository.kt`
8. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/MessageRepositoryImpl.kt`
9. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/MessageDto.kt`
10. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDetailDto.kt`

#### フロントエンド（4ファイル）
11. `frontend/src/app/specials/[id]/page.tsx`
12. `frontend/src/features/specials/components/details/SpecialEventDetail.tsx`
13. `frontend/src/features/specials/components/messages/MessagesList.tsx`
14. `frontend/src/features/specials/components/messages/MessageCard.tsx`

### 修正ファイル（12ファイル）

#### バックエンド（9ファイル）
1. `backend/src/main/resources/db/changelog/db.changelog-master.xml`
   - 036番マイグレーション追加
2. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventEntities.kt`
   - eventTypesプロパティ追加
3. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/SpecialEventRowMapper.kt`
   - タイプJOIN対応
4. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/SpecialEventQueryBuilder.kt`
   - タイプJOIN対応
5. `backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEvent.kt`
   - eventTypesプロパティ追加（必要に応じて）
6. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/SpecialEventRepositoryImpl.kt`
   - タイプを含めるように修正
7. `backend/src/main/kotlin/com/shirogane/holy/knights/application/usecase/SpecialsUseCaseImpl.kt`
   - 詳細取得時にメッセージ含める
8. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/SpecialsController.kt`
   - 詳細API拡張
9. `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDto.kt`
   - eventTypesプロパティ追加

#### フロントエンド（3ファイル）
10. `frontend/src/features/specials/types/types.ts`
    - MessageDto、SpecialEventDetailDto追加
11. `frontend/src/features/specials/api/specialClient.ts`
    - getSpecialEventDetails追加
12. `frontend/src/app/specials/page.tsx`
    - handleEventClick修正

### 削除ファイル
なし

---

## テスト戦略

### 1. 単体テスト（Unit Tests）
**優先度**: 低（時間があれば実施）

#### テスト対象
- Entity/Mapper のテスト
- QueryBuilder のテスト
- Repository のテスト（モック使用）
- UseCase のテスト（モック使用）
- Controller のテスト（モック使用）

#### テストフレームワーク
- バックエンド: JUnit5 + MockK
- フロントエンド: Jest + React Testing Library

### 2. 統合テスト（Integration Tests）
**優先度**: 中

#### テスト対象
- Repository の実際のDB接続テスト
- API エンドポイントテスト（/specials/{id}）
- エラーハンドリングテスト

#### テストケース
1. 正常系: 存在するイベントIDでの詳細取得
2. 異常系: 存在しないイベントIDでの詳細取得
3. 正常系: メッセージが0件の場合
4. 正常系: メッセージが複数件の場合

### 3. E2Eテスト（End-to-End Tests with Playwright MCP）
**優先度**: 高（最重要）

#### テストシナリオ
1. **イベント一覧ページ表示テスト**
   - ページアクセス
   - イベントカード表示確認
   - ローディング状態確認

2. **イベントカードクリック→詳細ページ遷移テスト**
   - カードクリック
   - URL遷移確認（/specials/[id]）
   - 詳細ページ表示確認

3. **イベント詳細ページ表示テスト**
   - イベントタイトル表示確認
   - イベント説明表示確認
   - 開始日・終了日表示確認
   - ステータス表示確認

4. **メッセージリスト表示テスト**
   - メッセージカード表示確認
   - 名前表示確認
   - メッセージ本文表示確認
   - 日時表示確認

5. **空状態テスト**
   - メッセージが0件の場合の表示確認
   - 適切なメッセージ表示確認

6. **ナビゲーションテスト**
   - 戻るボタン動作確認
   - ブラウザバック動作確認

7. **レスポンシブデザインテスト**
   - モバイル表示確認
   - タブレット表示確認
   - デスクトップ表示確認

#### テストツール
- Playwright MCP（必須）

### 4. ロールバックテスト
**優先度**: 中

#### テスト内容
- マイグレーション実行
- データ確認
- ロールバック実行
- データ復元確認

---

## リスク分析と対策

### 高リスク
なし

### 中リスク

#### リスク1: 既存データとの整合性
- **内容**: 既存のspecial_eventsデータにタイプが紐づいていない
- **影響**: マイグレーション後、既存データが正しく表示されない可能性
- **対策**:
  1. マイグレーション実行後、既存データにデフォルトタイプ（"messages"）を自動割り当て
  2. マイグレーション内にINSERT文を含める
  3. テスト環境で十分に確認してから本番適用
- **対策優先度**: 高

#### リスク2: R2DBC JOIN処理の複雑化
- **内容**: タイプとメッセージを含むJOIN処理が複雑になる可能性
- **影響**: パフォーマンス低下、バグ混入の可能性
- **対策**:
  1. カレンダー機能の実装パターンを参考にする
  2. 適切なインデックスを設定
  3. 必要に応じて複数回のクエリに分割
  4. 十分なテストを実施
- **対策優先度**: 中

### 低リスク

#### リスク3: パフォーマンス
- **内容**: JOIN処理の増加によるパフォーマンス低下
- **影響**: レスポンス速度の低下
- **対策**:
  1. 適切なインデックス設定済み
  2. キャッシュ機能の検討（今後の課題）
  3. パフォーマンステストの実施
- **対策優先度**: 低

#### リスク4: フロントエンドのルーティング
- **内容**: Next.js App Routerの動的ルーティングの設定ミス
- **影響**: 詳細ページが正しく表示されない
- **対策**:
  1. 既存の実装パターンを参考にする
  2. E2Eテストで動作確認
- **対策優先度**: 低

#### リスク5: マイグレーションの失敗
- **内容**: マイグレーション実行時のエラー
- **影響**: データベース構造の不整合
- **対策**:
  1. ロールバックスクリプトを用意
  2. 開発環境で十分にテストしてから本番環境に適用
  3. バックアップの取得
- **対策優先度**: 中

#### リスク6: レスポンス型の不一致
- **内容**: バックエンドとフロントエンドの型定義の不一致
- **影響**: 実行時エラー、表示不具合
- **対策**:
  1. DTOと型定義を同時に実装し、型の整合性を確認
  2. E2Eテストで実際のレスポンスを確認
  3. TypeScriptの型チェックを活用
- **対策優先度**: 低

---

## 技術仕様

### データベーススキーマ

#### special_event_typesテーブル
```sql
CREATE TABLE special_event_types (
    id SERIAL PRIMARY KEY,
    type VARCHAR(30) NOT NULL UNIQUE
);
```

#### special_event_special_event_typesテーブル
```sql
CREATE TABLE special_event_special_event_types (
    special_event_id UUID NOT NULL,
    special_event_type_id INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (special_event_id, special_event_type_id),
    FOREIGN KEY (special_event_id) REFERENCES special_events(id) ON DELETE CASCADE,
    FOREIGN KEY (special_event_type_id) REFERENCES special_event_types(id) ON DELETE RESTRICT
);
```

#### messagesテーブル
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    special_event_id UUID NOT NULL,
    name VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (special_event_id) REFERENCES special_events(id) ON DELETE CASCADE
);
```

### API仕様

#### GET /specials/{id}
**リクエスト**:
- Path Parameter: `id` (UUID)

**レスポンス**:
```json
{
  "event": {
    "id": "uuid",
    "title": "string",
    "description": "string",
    "startDate": "YYYY-MM-DD",
    "endDate": "YYYY-MM-DD",
    "status": "upcoming | active | ended",
    "eventTypes": ["messages"]
  },
  "messages": [
    {
      "id": "uuid",
      "name": "string",
      "message": "string",
      "createdAt": "ISO8601 datetime"
    }
  ]
}
```

**ステータスコード**:
- 200: 成功
- 404: イベントが見つからない
- 500: サーバーエラー

### フロントエンド型定義

```typescript
export interface MessageDto {
  id: string;
  name: string;
  message: string;
  createdAt: string;
}

export interface SpecialEventDto {
  id: string;
  title: string;
  description: string;
  startDate: string;
  endDate: string;
  status: 'upcoming' | 'active' | 'ended';
  eventTypes: string[];
}

export interface SpecialEventDetailDto {
  event: SpecialEventDto;
  messages: MessageDto[];
}
```

---

## 推定工数

| フェーズ | 推定時間 | 備考 |
|---------|---------|------|
| フェーズ1: データベース設計・実装 | 2時間10分 | マイグレーション、初期データ投入 |
| フェーズ2: バックエンド実装 | 6時間 | Entity〜Controller実装 |
| フェーズ3: フロントエンド実装 | 4時間20分 | ページ、コンポーネント実装 |
| フェーズ4: テスト・検証 | 3時間 | E2E、統合テスト、デバッグ |
| **合計** | **約15時間30分** | バッファ含む |

---

## 実装順序

### 推奨実装順序
1. **フェーズ1**: データベース設計・実装
2. **フェーズ2**: バックエンド実装
3. **フェーズ3**: フロントエンド実装
4. **フェーズ4**: テスト・検証

### 各フェーズ内の順序
#### フェーズ2（バックエンド）
1. Entity → Mapper → QueryBuilder → Repository → UseCase → Controller の順
2. 各レイヤーごとに動作確認を推奨

#### フェーズ3（フロントエンド）
1. 型定義 → API Client → コンポーネント → ページ の順
2. 各ステップで動作確認を推奨

---

## 動作確認チェックリスト

### データベース
- [ ] マイグレーション成功
- [ ] テーブル作成確認
- [ ] 外部キー制約確認
- [ ] インデックス作成確認
- [ ] 初期データ投入確認

### バックエンド
- [ ] ビルド成功
- [ ] API動作確認（/specials/{id}）
- [ ] レスポンス形式確認
- [ ] エラーハンドリング確認

### フロントエンド
- [ ] ビルド成功
- [ ] 一覧ページ表示確認
- [ ] カードクリック動作確認
- [ ] 詳細ページ表示確認
- [ ] メッセージ表示確認
- [ ] ローディング状態確認
- [ ] エラー状態確認

### E2Eテスト（Playwright MCP）
- [ ] イベント一覧ページ表示
- [ ] イベントカードクリック
- [ ] 詳細ページ遷移
- [ ] イベント基本情報表示
- [ ] メッセージリスト表示
- [ ] 空状態表示
- [ ] 戻るボタン動作
- [ ] レスポンシブデザイン確認

---

## 参考資料

### 参照ファイル
- `docs/investigate/investigate_20251017_173519.md` - 調査結果
- `backend/src/main/resources/db/changelog/changes/021-create-calendar-tables.sql` - カレンダー機能のevent_typesパターン
- `backend/src/main/resources/db/changelog/changes/035-create-special-events-table.sql` - 既存special_eventsテーブル
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/CalendarEntities.kt` - カレンダーEntity参考
- `frontend/src/features/calendar/components/modals/internals/EventDetailContent.tsx` - カレンダー詳細表示参考

### 関連ドキュメント
- Spring Boot R2DBC Documentation
- Liquibase Documentation
- Next.js App Router Documentation
- Playwright Documentation

---

## 次のステップ

### 完了条件
- [ ] 全タスク完了
- [ ] 全動作確認チェックリスト完了
- [ ] E2Eテスト成功
- [ ] コードレビュー完了（必要に応じて）

### 実装フェーズへ
プラン策定完了。次のフェーズ（IMPLEMENT）に移行し、実装を開始します。

---

## 承認

### プラン策定者
Claude Code

### 策定日
2025-10-17 17:41:11

### ステータス
**策定完了 - 実装フェーズへ移行準備完了**
