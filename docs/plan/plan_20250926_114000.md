# オーバーレイコンポーネント共通化実装プラン

## プラン概要

**作成日時**: 2025-09-26 11:40:00
**対象ブランチ**: feature/overlay-refactoring
**実装方針**: 段階的リファクタリングによる共通化
**推定工数**: 2-3日

## 1. 実装方針の決定

### 1.1 基本方針
- **安全な段階的移行**: 一度に全コンポーネントを変更せず、1つずつ段階的にリファクタリング
- **既存APIの維持**: 各コンポーネントの外部インターフェースは可能な限り維持
- **テスト駆動開発**: 実装前にテストケースを作成し、動作を保証

### 1.2 アーキテクチャ設計

#### 共通Overlayコンポーネントの設計
```typescript
// /frontend/src/components/ui/Overlay.tsx
interface OverlayProps {
  isOpen: boolean;
  onClose: () => void;
  zIndex?: 'navigation' | 'modal' | 'bottomSheet';
  variant?: 'default' | 'dark' | 'light';
  animate?: boolean;
  disableScroll?: boolean;
  closeOnEsc?: boolean;
  closeOnClick?: boolean;
  portal?: boolean;
  className?: string;
}
```

#### z-index管理システム
```typescript
// /frontend/src/constants/zIndex.ts
export const Z_INDEX = {
  OVERLAY: {
    NAVIGATION: 40,
    MODAL: 50,
    BOTTOM_SHEET: 50,
  },
  CONTENT: {
    MODAL: 50,
    BOTTOM_SHEET: 51,
    DROPDOWN: 52,
  }
} as const;
```

## 2. 詳細実装タスク分解

### Phase 1: 基盤構築（優先度: 高）

#### Task 1.1: z-index定数管理ファイル作成
- **ファイル**: `/frontend/src/constants/zIndex.ts`
- **内容**: 全てのz-indexを一元管理
- **影響範囲**: 新規ファイル作成

#### Task 1.2: 共通Overlayコンポーネント作成
- **ファイル**: `/frontend/src/components/ui/Overlay.tsx`
- **機能**:
  - 表示/非表示制御
  - ESCキーハンドリング
  - スクロール制御
  - クリックハンドリング
  - アニメーション制御
  - Portal対応
- **影響範囲**: 新規ファイル作成

#### Task 1.3: 共通Overlayのテストケース作成
- **ファイル**: `/frontend/src/components/ui/__tests__/Overlay.test.tsx`
- **テスト項目**:
  - 表示/非表示
  - ESCキー処理
  - クリック処理
  - スクロール制御
  - アニメーション
- **影響範囲**: 新規ファイル作成

### Phase 2: 段階的移行（優先度: 高）

#### Task 2.1: ヘッダーのOverlayを共通化
- **対象ファイル**:
  - `/frontend/src/components/header/internals/Overlay.tsx`（削除）
  - `/frontend/src/components/header/internals/Navigation.tsx`（修正）
- **変更内容**:
  - 独自Overlayコンポーネントを削除
  - 共通Overlayを使用するよう修正
- **理由**: 最もシンプルな実装のため、移行リスクが最小

#### Task 2.2: BottomSheetのオーバーレイを共通化
- **対象ファイル**:
  - `/frontend/src/components/common/BottomSheet/BottomSheet.tsx`
- **変更内容**:
  - 内部オーバーレイ実装を削除
  - 共通Overlayコンポーネントを使用
- **注意点**: z-index階層の調整が必要

#### Task 2.3: Modalのオーバーレイを共通化
- **対象ファイル**:
  - `/frontend/src/components/ui/Modal.tsx`
- **変更内容**:
  - 内部オーバーレイ実装を削除
  - 共通Overlayコンポーネントを使用
- **注意点**: アニメーション設定の調整が必要

### Phase 3: 最適化・統一化（優先度: 中）

#### Task 3.1: アニメーション設定統一
- **対象ファイル**: `/frontend/src/app/globals.css`
- **内容**: オーバーレイ用アニメーションクラスの統一
- **影響範囲**: 既存アニメーション定義の調整

#### Task 3.2: ResponsiveModalの最適化
- **対象ファイル**: `/frontend/src/components/ui/ResponsiveModal.tsx`
- **内容**: 共通化されたコンポーネントを活用した最適化

## 3. ファイル変更計画

### 新規作成ファイル
1. `/frontend/src/constants/zIndex.ts`
2. `/frontend/src/components/ui/Overlay.tsx`
3. `/frontend/src/components/ui/__tests__/Overlay.test.tsx`

### 修正対象ファイル
1. `/frontend/src/components/header/internals/Navigation.tsx`
2. `/frontend/src/components/common/BottomSheet/BottomSheet.tsx`
3. `/frontend/src/components/ui/Modal.tsx`
4. `/frontend/src/components/ui/ResponsiveModal.tsx`
5. `/frontend/src/app/globals.css`（必要に応じて）

### 削除対象ファイル
1. `/frontend/src/components/header/internals/Overlay.tsx`

## 4. テスト戦略

### 4.1 単体テスト
- 共通Overlayコンポーネントの機能テスト
- z-index定数の使用テスト
- 各種プロパティの動作テスト

### 4.2 統合テスト
- 各コンポーネントとOverlayの統合動作テスト
- レスポンシブ動作テスト
- アクセシビリティテスト

### 4.3 E2Eテスト（MCPツール使用）
- モーダル表示・非表示の動作確認
- BottomSheet表示・非表示の動作確認
- ヘッダーメニュー表示・非表示の動作確認
- レスポンシブ動作の確認（デスクトップ・モバイル）
- キーボード操作の確認
- スクロール制御の確認

### 4.4 テスト環境
- **デスクトップブラウザ**: Chrome、Firefox、Safari
- **モバイル**: responsive design mode での確認
- **アクセシビリティ**: スクリーンリーダー対応確認

## 5. リスク分析と対策

### 5.1 高リスク項目

#### リスク1: z-index変更による表示順序の乱れ
- **対策**: 段階的移行と各段階でのブラウザ確認
- **検証方法**: 複数モーダル同時表示テスト

#### リスク2: アニメーション タイミングの変化
- **対策**: 既存アニメーション設定の詳細分析と保持
- **検証方法**: 視覚的なアニメーション確認

### 5.2 中リスク項目

#### リスク3: レスポンシブ動作の変化
- **対策**: useViewportフックとの統合テスト
- **検証方法**: 各デバイスサイズでの動作確認

#### リスク4: パフォーマンスへの影響
- **対策**: React.memoを使用した最適化
- **検証方法**: パフォーマンス測定ツールでの確認

### 5.3 低リスク項目

#### リスク5: 外部インターフェースの変更
- **対策**: 既存プロパティの維持
- **検証方法**: TypeScriptコンパイルエラーのチェック

## 6. 実装スケジュール

### Day 1: 基盤構築
- [ ] z-index定数ファイル作成
- [ ] 共通Overlayコンポーネント作成
- [ ] 単体テスト作成・実行

### Day 2: 段階的移行
- [ ] ヘッダーOverlay移行・テスト
- [ ] BottomSheetオーバーレイ移行・テスト
- [ ] Modalオーバーレイ移行・テスト

### Day 3: 最適化・検証
- [ ] アニメーション統一
- [ ] ResponsiveModal最適化
- [ ] E2Eテスト実行
- [ ] 不要ファイル削除
- [ ] コード品質チェック

## 7. 成功判定基準

### 7.1 機能要件
- [ ] 全てのオーバーレイが共通コンポーネントを使用
- [ ] 既存の表示・操作が全て保持されている
- [ ] レスポンシブ動作が正常

### 7.2 品質要件
- [ ] TypeScriptエラーなし
- [ ] 単体テスト全パス
- [ ] E2Eテスト全パス
- [ ] パフォーマンスの劣化なし

### 7.3 保守性要件
- [ ] コード重複の排除
- [ ] z-index管理の一元化
- [ ] 統一されたアニメーション

## 8. ロールバック計画

各Phaseごとにコミットを分け、問題発生時は前のコミットに戻れるよう管理。

### ロールバック判定基準
- E2Eテストで1つでも失敗
- パフォーマンスが20%以上劣化
- 重大なレスポンシブ動作の問題発生

## 9. 後続タスク

### 実装完了後の改善項目
- [ ] オーバーレイコンポーネントのドキュメント作成
- [ ] 他の類似コンポーネントでの活用検討
- [ ] パフォーマンス監視の設定
- [ ] ユーザビリティテストの実施

## 10. 参考資料

- 調査結果: `docs/investigate/investigate_20250926_112955.md`
- 既存コンポーネント実装
- Tailwind CSS ドキュメント
- React Portal ドキュメント