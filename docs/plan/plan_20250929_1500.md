# 本番環境 CSS エラー修正実装計画

## 📋 問題概要
- **日時**: 2025年9月29日 15:00
- **症状**: 本番環境でCSS SyntaxError (f2e89ef87fdc1daf.css:1)
- **根本原因**: Next.js 15 + Tailwind CSS v4の依存関係配置問題
- **制約**: Tailwind CSS v4を維持したまま修正

## 🔍 調査結果サマリー
### 技術スタック
- **Next.js**: 15.5.2
- **Tailwind CSS**: 4.1.13
- **PostCSS**: 8.5.6
- **@tailwindcss/postcss**: 4.1.13
- **デプロイ**: AWS Amplify

### 根本原因分析
1. **主要原因**: Next.js 15 + Tailwind CSS v4の本番ビルド互換性問題
2. **副次的要因**:
   - tailwindcss関連パッケージがdevDependenciesに配置
   - 本番ビルド時の依存関係アクセス制限
   - AWS Amplify ビルド環境での静的ファイル配信問題

## 🎯 実装方針 (段階的・低リスクアプローチ)

### Phase 1: 即座実行 (高優先・低リスク)
1. **package.json依存関係修正**
   - `tailwindcss: 4.1.13` をdependenciesに移動
   - `@tailwindcss/postcss: 4.1.13` をdependenciesに移動
   - `postcss: 8.5.6` をdependenciesに移動

2. **ローカル検証とE2Eテスト**
   - `pnpm run build` 実行確認
   - `pnpm run dev` 実行確認
   - playwright MCP E2Eテスト実施

3. **AWS Amplify設定最適化**
   - amplify.ymlビルド手順詳細化
   - 明示的な依存関係インストール確認

### Phase 2: 段階的実装 (中優先・中リスク)
4. **Next.js設定調整**
   - next.config.jsでCSS処理最適化
   - webpack設定での明示的CSS処理

5. **PostCSS設定微調整**
   - より明示的なPostCSS設定

6. **本番デプロイ検証**
   - AWS Amplify自動ビルド確認
   - 本番環境CSS エラー確認

## 📁 ファイル変更計画

### 確実に変更するファイル
1. **frontend/package.json**
   ```json
   "dependencies": {
     "tailwindcss": "4.1.13",
     "@tailwindcss/postcss": "4.1.13",
     "postcss": "8.5.6",
     // ... 既存dependencies
   },
   "devDependencies": {
     // tailwindcss関連を除去
     // ... その他のdevDependencies
   }
   ```

2. **frontend/amplify.yml** (必要に応じて)
   - preBuild フェーズでの明示的依存関係確認
   - ビルドログ詳細化

### 段階的に検討するファイル
3. **frontend/next.config.js** (Phase 2)
   - webpack CSS処理設定強化
   - 既存の高度な設定を保持

4. **frontend/postcss.config.js** (Phase 2)
   - より明示的な設定追加

## 🧪 テスト戦略

### 各Phase後の必須テスト
1. **ローカルビルド確認**
   ```bash
   cd frontend
   pnpm run build
   ```

2. **開発環境確認**
   ```bash
   cd frontend
   pnpm run dev
   # http://localhost:3001 で動作確認
   ```

3. **Playwright MCP E2Eテスト**
   - ユーザー目線での動作確認
   - CSS読み込み・スタイル適用確認
   - 主要ページの表示確認

### 本番環境確認
1. **AWS Amplify自動ビルド結果確認**
2. **ブラウザコンソールでCSS エラー確認**
3. **実際のページ表示・機能確認**

## ⚠️ リスク管理

### 高リスク要因と対策
1. **依存関係変更によるビルド破綻**
   - **対策**: 段階的変更、各段階での徹底的テスト

2. **本番環境でのビルド失敗継続**
   - **対策**: ローカル完全検証後のデプロイ

### 中リスク要因と対策
1. **Next.js webpack設定変更の副作用**
   - **対策**: 既存の高度な設定を維持、最小限の追加のみ

2. **AWS Amplify配信設定問題**
   - **対策**: 保守的なamplify.yml変更

### 制約遵守確認
- ✅ Tailwind CSS v4維持
- ✅ 既存機能影響最小化
- ✅ AWS Amplify環境維持

## 📈 成功基準

### 必須成功基準
1. **本番環境でCSS SyntaxErrorが完全解消**
2. **全既存機能の正常動作維持**
3. **ビルド時間・パフォーマンス劣化なし**
4. **E2Eテスト完全パス**

### 追加成功基準
1. **長期安定性の確保**
2. **将来のTailwind/Next.js更新への対応性向上**

## 🚀 実装スケジュール

### Phase 1 (即座実行): 約30分
1. package.json修正: 5分
2. ローカル検証: 15分
3. E2Eテスト: 10分

### Phase 2 (段階的): 約60分
4. Next.js設定調整: 20分
5. PostCSS設定: 10分
6. 本番デプロイ検証: 30分

## 📝 実装後の継続監視
1. **本番環境での長期安定性監視**
2. **パフォーマンス指標の継続確認**
3. **将来のライブラリ更新対応準備**

---
**策定者**: Claude Code
**策定日時**: 2025年9月29日 15:00
**基づく調査**: docs/investigate/investigate_20250929_1500.md