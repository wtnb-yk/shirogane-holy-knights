# z-index管理標準化実装計画

## 計画策定日時
2025-09-28 00:10:50

## 概要
17ファイルで発生しているz-index直接指定を中央管理システムに統一し、z-50重複による競合リスクを解消する包括的な実装計画。

## 実装方針

### 基本戦略
- **段階的移行戦略**: 既存システムの動作を維持しながら、リスクの高いコンポーネントから優先的に対応
- **中央集権化**: zIndex.tsシステムを拡張し、全コンポーネントで統一的に使用
- **型安全性の確保**: TypeScriptの型システムを活用した誤用防止

### アプローチの詳細
1. **zIndex.ts設計の改良**: より明確で競合を避ける階層構造への再設計
2. **高リスクコンポーネント優先**: z-50重複の8コンポーネントから開始
3. **段階的ロールアウト**: 各修正後に動作確認を実施

## フェーズ構成

### フェーズ1: 高優先度（z-50重複解消）

#### タスク1.1: zIndex.ts設計改良
- **優先度**: 最高
- **作業内容**:
  - 現在のzIndex.tsを分析し、競合を避ける新しい階層構造を設計
  - Header(55), Toast(56), Modal(57), Tooltip(60)等の個別値を割り当て
  - TAILWIND_Z_INDEXの対応するクラス文字列を更新

#### タスク1.2: 重要UIコンポーネントの修正
- **優先度**: 最高
- **対象ファイル** (z-50重複8ファイル):
  1. `/components/header/Header.tsx` → z-[55]使用
  2. `/components/header/internals/MobileMenu.tsx` → z-[55]使用
  3. `/components/common/Toast.tsx` → z-[56]使用
  4. `/components/common/OfflineIndicator.tsx` → z-[54]使用
  5. `/components/common/FloatingYouTubeLink.tsx` → z-[53]使用
  6. `/components/ui/Modal.tsx` → z-[57]使用
  7. `/components/ui/tooltip.tsx` → z-[60]使用
  8. `/app/globals.css` → tooltip-baseクラスの統合

### フェーズ2: 中優先度（任意値の統一）

#### タスク2.1: カスタム値コンポーネントの修正
- **対象ファイル**:
  1. `/components/common/BottomSheet/BottomSheet.tsx` (z-[51] → z-[58])
  2. `/components/ui/MultiSelect.tsx` (z-52 → z-[59])

### フェーズ3: 低優先度（基本レイヤー統一）

#### タスク3.1: 基本レイヤーコンポーネントの修正
- **対象ファイル**:
  1. `/features/calendar/components/calender/internals/EventBand.tsx`
  2. `/features/home/components/ProfileSection.tsx`
  3. `/features/home/components/YouTubeLinkSection.tsx`
  4. `/features/home/components/HeroSection.tsx`

## ファイル変更計画

### 修正対象ファイル (合計16ファイル)

#### 1. 中央管理システム改良 (1ファイル)
- **`/frontend/src/constants/zIndex.ts`**
  - **変更種類**: 修正
  - **変更内容**: 競合回避のための階層再設計、新しい定数追加
  - **新階層構造**:
    - FLOATING_LINK: z-[53]
    - OFFLINE_INDICATOR: z-[54]
    - HEADER: z-[55]
    - TOAST: z-[56]
    - MODAL: z-[57]
    - BOTTOM_SHEET: z-[58]
    - DROPDOWN: z-[59]
    - TOOLTIP: z-[60]

#### 2. 高優先度修正ファイル (8ファイル)
- **`/frontend/src/components/header/Header.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-50` → `TAILWIND_Z_INDEX.CONTENT.HEADER`使用
  - **import追加**: `import { TAILWIND_Z_INDEX } from '@/constants/zIndex';`

- **`/frontend/src/components/header/internals/MobileMenu.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-50` → `TAILWIND_Z_INDEX.CONTENT.HEADER`使用
  - **import追加**: `import { TAILWIND_Z_INDEX } from '@/constants/zIndex';`

- **`/frontend/src/components/common/Toast.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-50` → `TAILWIND_Z_INDEX.CONTENT.TOAST`使用
  - **import追加**: `import { TAILWIND_Z_INDEX } from '@/constants/zIndex';`

- **`/frontend/src/components/common/OfflineIndicator.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-50` → `TAILWIND_Z_INDEX.CONTENT.OFFLINE_INDICATOR`使用
  - **import追加**: `import { TAILWIND_Z_INDEX } from '@/constants/zIndex';`

- **`/frontend/src/components/common/FloatingYouTubeLink.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-50` → `TAILWIND_Z_INDEX.CONTENT.FLOATING_LINK`使用
  - **import追加**: `import { TAILWIND_Z_INDEX } from '@/constants/zIndex';`

- **`/frontend/src/components/ui/Modal.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-50` → `TAILWIND_Z_INDEX.CONTENT.MODAL`使用
  - **import追加**: `import { TAILWIND_Z_INDEX } from '@/constants/zIndex';`

- **`/frontend/src/components/ui/tooltip.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-50` → `TAILWIND_Z_INDEX.CONTENT.TOOLTIP`使用
  - **import追加**: `import { TAILWIND_Z_INDEX } from '@/constants/zIndex';`

- **`/frontend/src/app/globals.css`**
  - **変更種類**: 修正
  - **変更内容**: CSS内のz-50定義をzIndex.tsの値に統合

#### 3. 中優先度修正ファイル (2ファイル)
- **`/frontend/src/components/common/BottomSheet/BottomSheet.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-[51]` → `TAILWIND_Z_INDEX.CONTENT.BOTTOM_SHEET`使用

- **`/frontend/src/components/ui/MultiSelect.tsx`**
  - **変更種類**: 修正
  - **変更内容**: `z-52` → `TAILWIND_Z_INDEX.CONTENT.DROPDOWN`使用

#### 4. 低優先度修正ファイル (4ファイル)
- **`/frontend/src/features/calendar/components/calender/internals/EventBand.tsx`**
- **`/frontend/src/features/home/components/ProfileSection.tsx`**
- **`/frontend/src/features/home/components/YouTubeLinkSection.tsx`**
- **`/frontend/src/features/home/components/HeroSection.tsx`**
  - **変更種類**: 修正
  - **変更内容**: 直接指定 → `TAILWIND_Z_INDEX`の適切な定数使用

## テスト戦略

### 1. E2Eテスト (Playwright MCP使用)
**CLAUDE.mdの指示に従い、PlaywrightのMCPツールを使用した動作確認を実施**

#### 高優先度テストシナリオ
1. **モーダル系統の重なり順確認**
   - Modal + Toast の同時表示
   - Modal + Tooltip の同時表示
   - BottomSheet + Toast の同時表示

2. **ヘッダー関連の表示確認**
   - Header + MobileMenu の表示
   - Header + Modal の重なり順
   - Header + Toast の重なり順

3. **ドロップダウン・セレクト系確認**
   - MultiSelect + Modal の重なり順
   - Tooltip + MultiSelect の表示

#### 基本機能テストシナリオ
1. **各コンポーネントの個別動作確認**
   - 全てのモーダル・オーバーレイの開閉
   - ツールチップの表示・非表示
   - ドロップダウンの展開・収束

### 2. 視覚的回帰テスト
1. **スクリーンショット比較**
   - 修正前後での表示比較
   - 異なる画面サイズでの確認

### 3. 手動確認項目
1. **レスポンシブ対応確認**
   - モバイル・タブレット・デスクトップでの表示
2. **アクセシビリティ確認**
   - キーボードナビゲーション
   - スクリーンリーダー対応

## リスク分析と対策

### 高リスク事項
1. **表示順序の競合による機能不全**
   - **リスク**: Modal、Toast、Headerの重要UIで表示順序が意図しない順番になる
   - **対策**:
     - 段階的修正（1コンポーネントずつ）
     - 各修正後に即座にPlaywright MCPでテスト実施
     - 問題発生時の即座ロールバック体制

2. **複数オーバーレイ同時表示時の問題**
   - **リスク**: Modal + Toast + Tooltip等の複合表示で予期しない動作
   - **対策**: 重複表示テストシナリオの徹底実施

### 中リスク事項
1. **既存動作への副作用**
   - **リスク**: z-index変更により他の表示ロジックに影響
   - **対策**: 全ページでのE2E動作確認、視覚的回帰テスト

2. **レスポンシブ対応での予期しない表示**
   - **リスク**: モバイル・タブレットでの表示崩れ
   - **対策**: 各画面サイズでのテスト実施

### 低リスク事項
1. **開発者体験の一時的な混乱**
   - **リスク**: チーム内でのz-index使用方法の理解不足
   - **対策**: 実装完了後のドキュメント整備

### リスク軽減戦略
1. **段階的ロールアウト**: フェーズ1→フェーズ2→フェーズ3の順序遵守
2. **即座テスト**: 各修正直後のPlaywright MCP動作確認
3. **ロールバック準備**: Git履歴での簡単復元体制

## 実装順序

### 実行順序 (各ステップ後にテスト実施)
1. **zIndex.ts設計改良**
2. **Header関連修正** (Header.tsx, MobileMenu.tsx)
3. **通知系修正** (Toast.tsx, OfflineIndicator.tsx, FloatingYouTubeLink.tsx)
4. **モーダル系修正** (Modal.tsx, tooltip.tsx)
5. **CSS統合** (globals.css)
6. **フェーズ1包括テスト** (Playwright MCP)
7. **フェーズ2実装** (BottomSheet, MultiSelect)
8. **フェーズ3実装** (基本レイヤーコンポーネント)
9. **最終統合テスト**

## 期待される効果

### 短期効果
- z-index競合の解消
- 表示順序の安定化
- 保守性の向上

### 長期効果
- 新機能開発時の階層管理の簡素化
- バグ発生率の低下
- 開発効率の向上

## 完了基準
1. 全17ファイルでzIndex.tsシステムの使用
2. z-50重複の完全解消
3. 全E2Eテストシナリオの通過
4. 視覚的回帰テストの通過
5. レスポンシブ対応の確認完了

## 備考
- 各フェーズ完了時にコミットを作成
- 問題発生時は即座に前のフェーズに戻れる体制を維持
- Playwright MCPツールによる動作確認を必須とする