# SPECIALS機能廃止 実装計画

計画日時: 2025-10-27 14:46:26
計画者: Claude Code
調査結果: docs/investigate/investigate_20251027_134733.md

## 1. 実装方針

### 1.1 基本方針
SPECIALS機能を完全廃止し、関連するすべてのコード、データベーステーブル、ツールを安全に削除する。

### 1.2 実装アプローチ
段階的削除アプローチを採用し、各レイヤーで削除後に必ずビルド確認を実施する。
削除順序: データベース → バックエンド → フロントエンド → ツール

### 1.3 安全性の担保
- 各フェーズでビルド＆コンパイル確認
- 削除前に影響範囲を再確認
- E2Eテストで全体動作確認
- feature ブランチで作業し、レビュー後にマージ

## 2. 詳細タスク分解と優先度

### フェーズ0: 準備（優先度: 最高）
- [P0-1] feature/remove-specials ブランチ作成
- [P0-2] 現在のmainブランチから最新の状態を取得

### フェーズ1: データベース削除（優先度: 高）
- [P1-1] 新規マイグレーションファイル作成（037-drop-special-events-tables.sql）
- [P1-2] 外部キー制約に従った順序でDROP TABLE文を記述
  - Step 1: DROP TABLE messages;
  - Step 2: DROP TABLE special_event_special_event_types;
  - Step 3: DROP TABLE special_event_types;
  - Step 4: DROP TABLE special_events;
- [P1-3] ロールバック用のコメント追加（既存テーブル再作成は不要）

### フェーズ2: バックエンド削除（優先度: 高）
- [P2-1] ApiGatewayRouter.kt を修正
  - import文削除（12行目）
  - 依存注入削除（26行目）
  - ルート定義削除（99-101行目）
  - パスパラメータ処理削除（131-136行目）
- [P2-2] コントローラー層削除（2ファイル）
- [P2-3] ユースケース層削除（1ファイル）
- [P2-4] ドメイン層削除（3ファイル）
- [P2-5] リポジトリ層削除（4ファイル）
- [P2-6] クエリビルダー層削除（2ファイル）
- [P2-7] マッパー層削除（2ファイル）
- [P2-8] エンティティ層削除（3ファイル）
- [P2-9] DTO層削除（3ファイル）
- [P2-10] その他削除（1ファイル）
- [P2-11] テスト削除（1ファイル）
- [P2-12] バックエンドビルド確認（./gradlew build）

### フェーズ3: フロントエンド削除（優先度: 高）
- [P3-1] frontend/src/app/specials/ ディレクトリ削除
- [P3-2] frontend/src/features/specials/ ディレクトリ削除
- [P3-3] frontend/src/types/index.ts から型エクスポート削除（68-73行目）
- [P3-4] フロントエンドビルド確認（pnpm build）

### フェーズ4: ツール削除（優先度: 中）
- [P4-1] tools/scripts/special_events_importer.py 削除
- [P4-2] tools/data/special_events.csv 削除

### フェーズ5: 動作確認（優先度: 最高）
- [P5-1] バックエンドテスト実行（./gradlew test）
- [P5-2] フロントエンドビルド最終確認（pnpm build）
- [P5-3] Playwright E2Eテスト実行（主要機能の動作確認）
  - トップページ表示確認
  - アーカイブページ表示確認
  - カレンダーページ表示確認
  - ニュースページ表示確認
  - ソングページ表示確認
- [P5-4] /specials へのアクセスが404になることを確認

## 3. ファイル変更計画

### 3.1 新規作成（1ファイル）

#### backend/src/main/resources/db/changelog/changes/037-drop-special-events-tables.sql
```sql
--liquibase formatted sql

--changeset shirogane:037-drop-special-events-tables
--comment: Drop all special events related tables

-- Drop tables in reverse order of creation due to foreign key constraints
DROP TABLE IF EXISTS messages;
DROP TABLE IF EXISTS special_event_special_event_types;
DROP TABLE IF EXISTS special_event_types;
DROP TABLE IF EXISTS special_events;

--rollback CREATE TABLE special_events (...);
--rollback CREATE TABLE special_event_types (...);
--rollback CREATE TABLE special_event_special_event_types (...);
--rollback CREATE TABLE messages (...);
```

### 3.2 修正（2ファイル）

#### backend/src/main/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouter.kt
修正箇所:
1. 12行目: `import com.shirogane.holy.knights.adapter.controller.SpecialsController` を削除
2. 26行目: `private val specialsController: SpecialsController,` を削除
3. 99-101行目: 以下を削除
```kotlin
RouteKey("GET", "/specials") to { _ ->
    specialsController.getSpecialEvents()
},
```
4. 131-136行目: 以下を削除
```kotlin
if (httpMethod == "GET" && path.startsWith("/specials/") && path != "/specials/") {
    val eventId = path.removePrefix("/specials/")
    if (eventId.isNotBlank()) {
        return { _ -> specialsController.getSpecialEventDetails(eventId) }
    }
}
```

#### frontend/src/types/index.ts
修正箇所:
- 68-73行目: 以下を削除
```typescript
export type {
  SpecialEventDto,
  MessageDto,
  SpecialEventDetailDto,
  SpecialEventSearchResultDto
} from '@/features/specials/types/types';
```

### 3.3 削除（35ファイル）

#### フロントエンド（12ファイル）
1. frontend/src/app/specials/page.tsx
2. frontend/src/app/specials/[id]/page.tsx
3. frontend/src/app/specials/layout.tsx
4. frontend/src/features/specials/hooks/useSpecials.ts
5. frontend/src/features/specials/hooks/useSpecialEventDetail.ts
6. frontend/src/features/specials/api/specialClient.ts
7. frontend/src/features/specials/types/types.ts
8. frontend/src/features/specials/components/grids/SpecialsGrid.tsx
9. frontend/src/features/specials/components/cards/SpecialEventCard.tsx
10. frontend/src/features/specials/components/cards/SkeletonSpecialEventCard.tsx
11. frontend/src/features/specials/components/details/SpecialEventDetail.tsx
12. frontend/src/features/specials/components/messages/MessagesGrid.tsx
13. frontend/src/features/specials/components/messages/MessageCard.tsx
14. frontend/src/features/specials/components/cards/internals/SpecialEventCardDescription.tsx
15. frontend/src/features/specials/config/gridConfig.ts

注: ディレクトリごと削除するため、実質2コマンドで完了
- rm -rf frontend/src/app/specials/
- rm -rf frontend/src/features/specials/

#### バックエンド（21ファイル）
1. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/SpecialsController.kt
2. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/port/SpecialsUseCasePort.kt
3. backend/src/main/kotlin/com/shirogane/holy/knights/application/usecase/SpecialsUseCaseImpl.kt
4. backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEvent.kt
5. backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEventType.kt
6. backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/Message.kt
7. backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/SpecialEventRepository.kt
8. backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/MessageRepository.kt
9. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/SpecialEventRepositoryImpl.kt
10. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/MessageRepositoryImpl.kt
11. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/SpecialEventQueryBuilder.kt
12. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/MessageQueryBuilder.kt
13. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/SpecialEventRowMapper.kt
14. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/MessageRowMapper.kt
15. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventEntities.kt
16. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventTypeEntity.kt
17. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/MessageEntity.kt
18. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDto.kt
19. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDetailDto.kt
20. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/MessageDto.kt
21. backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/model/SpecialEventSearchCriteria.kt
22. backend/src/test/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouterSpecialsTest.kt

#### ツール（2ファイル）
1. tools/scripts/special_events_importer.py
2. tools/data/special_events.csv

## 4. テスト戦略

### 4.1 単体テスト
- バックエンド: ./gradlew test を実行
- 期待結果: SPECIALS関連テストが削除され、他のテストが全てパスすること
- 削除されるテスト: ApiGatewayRouterSpecialsTest.kt

### 4.2 ビルドテスト
- バックエンド: ./gradlew build
  - 期待結果: Kotlinコンパイルエラーがないこと
  - 確認ポイント: ApiGatewayRouter.kt の依存注入エラーがないこと
- フロントエンド: pnpm build
  - 期待結果: TypeScriptコンパイルエラーがないこと
  - 確認ポイント: 型定義エラーがないこと

### 4.3 E2Eテスト（Playwright）
以下のページが正常に動作することを確認:

1. トップページ（/）
   - ページが正常に表示されること
   - ナビゲーションメニューが機能すること

2. アーカイブページ（/archives）
   - 動画・配信一覧が表示されること
   - フィルタリングが機能すること

3. カレンダーページ（/calendar）
   - カレンダーが表示されること
   - イベントが表示されること

4. ニュースページ（/news）
   - ニュース一覧が表示されること

5. ソングページ（/songs）
   - 楽曲一覧が表示されること

6. SPECIALS削除確認
   - /specials へのアクセスが404エラーになること
   - /specials/{id} へのアクセスが404エラーになること

### 4.4 テスト実行タイミング
1. フェーズ2完了後: バックエンドビルド＆テスト
2. フェーズ3完了後: フロントエンドビルド
3. フェーズ5: 全体E2Eテスト

## 5. リスク分析と対策

### 5.1 高リスク項目

#### リスク1: データベーステーブル削除の不可逆性
- 発生確率: 低
- 影響度: 高
- 対策:
  - 本番環境実行前にデータバックアップを取得
  - ステージング環境で事前に検証
  - マイグレーションファイルにロールバック用コメントを記述（参考用）

#### リスク2: 他機能への意図しない影響
- 発生確率: 極低
- 影響度: 中
- 対策:
  - E2Eテストで主要機能の動作確認
  - 調査フェーズで他機能からの参照がないことを確認済み

### 5.2 中リスク項目

#### リスク3: ビルドエラー
- 発生確率: 中
- 影響度: 低
- 対策:
  - 各フェーズでビルド確認を実施
  - ApiGatewayRouter.kt の修正を慎重に実施

#### リスク4: 型定義エラー
- 発生確率: 低
- 影響度: 低
- 対策:
  - frontend/src/types/index.ts の修正を慎重に実施
  - TypeScriptコンパイルでエラーチェック

### 5.3 低リスク項目

#### リスク5: ユーザー影響
- 発生確率: 極低
- 影響度: 低
- 理由:
  - ナビゲーションメニューに /specials のリンクが存在しない
  - 調査フェーズで確認済み

## 6. 実装手順詳細

### Step 1: ブランチ作成
```bash
git checkout main
git pull origin main
git checkout -b feature/remove-specials
```

### Step 2: データベースマイグレーション作成
1. 新規ファイル作成: backend/src/main/resources/db/changelog/changes/037-drop-special-events-tables.sql
2. DROP TABLE文を記述（外部キー制約の逆順）
3. ファイル保存

### Step 3: バックエンド修正
1. ApiGatewayRouter.kt を編集
   - import文削除
   - 依存注入削除
   - ルート定義削除
   - パスパラメータ処理削除
2. ファイル保存

### Step 4: バックエンド削除
1. 21ファイルを削除
   ```bash
   # コントローラー層
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/SpecialsController.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/port/SpecialsUseCasePort.kt

   # ユースケース層
   rm backend/src/main/kotlin/com/shirogane/holy/knights/application/usecase/SpecialsUseCaseImpl.kt

   # ドメイン層
   rm backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEvent.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/SpecialEventType.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/domain/model/Message.kt

   # リポジトリ層
   rm backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/SpecialEventRepository.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/domain/repository/MessageRepository.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/SpecialEventRepositoryImpl.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/MessageRepositoryImpl.kt

   # クエリビルダー層
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/SpecialEventQueryBuilder.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/MessageQueryBuilder.kt

   # マッパー層
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/SpecialEventRowMapper.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/mapper/MessageRowMapper.kt

   # エンティティ層
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventEntities.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/SpecialEventTypeEntity.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/MessageEntity.kt

   # DTO層
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDto.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/SpecialEventDetailDto.kt
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/MessageDto.kt

   # その他
   rm backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/model/SpecialEventSearchCriteria.kt

   # テスト
   rm backend/src/test/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouterSpecialsTest.kt
   ```

### Step 5: バックエンドビルド確認
```bash
cd backend
./gradlew clean build
./gradlew test
cd ..
```

### Step 6: フロントエンド削除
1. ディレクトリ削除
   ```bash
   rm -rf frontend/src/app/specials/
   rm -rf frontend/src/features/specials/
   ```

### Step 7: フロントエンド型定義修正
1. frontend/src/types/index.ts を編集
2. 68-73行目を削除
3. ファイル保存

### Step 8: フロントエンドビルド確認
```bash
cd frontend
pnpm build
cd ..
```

### Step 9: ツール削除
```bash
rm tools/scripts/special_events_importer.py
rm tools/data/special_events.csv
```

### Step 10: E2Eテスト実行
Playwright MCPツールを使用して以下のページを確認:
1. http://localhost:3001/ - トップページ表示確認
2. http://localhost:3001/archives - アーカイブページ表示確認
3. http://localhost:3001/calendar - カレンダーページ表示確認
4. http://localhost:3001/news - ニュースページ表示確認
5. http://localhost:3001/songs - ソングページ表示確認
6. http://localhost:3001/specials - 404エラー確認

### Step 11: コミット
```bash
git add .
git commit -m "feat: remove SPECIALS feature

- Remove SPECIALS related frontend components and pages
- Remove SPECIALS related backend controllers, use cases, and repositories
- Add database migration to drop special_events related tables
- Remove SPECIALS data import tools
- Update ApiGatewayRouter to remove SPECIALS routes
- Update type definitions to remove SPECIALS types

Ref: docs/investigate/investigate_20251027_134733.md
Ref: docs/plan/plan_20251027_144626.md

Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
```

### Step 12: プッシュ＆プルリクエスト作成
```bash
git push -u origin feature/remove-specials
gh pr create --title "feat: SPECIALS機能廃止" --body "$(cat <<'EOF'
## Summary
SPECIALS機能を完全廃止しました。

## Changes
- フロントエンド: 12ファイル削除、1ファイル修正
- バックエンド: 21ファイル削除、1ファイル修正
- データベース: 4テーブル削除マイグレーション追加
- ツール: 2ファイル削除

## Test plan
- [x] バックエンドビルド成功
- [x] バックエンドテスト成功
- [x] フロントエンドビルド成功
- [x] E2Eテスト成功（主要ページ表示確認）
- [x] /specials が404になることを確認

## References
- 調査結果: docs/investigate/investigate_20251027_134733.md
- 実装計画: docs/plan/plan_20251027_144626.md

Generated with Claude Code
EOF
)"
```

## 7. 成功基準

### 7.1 技術的成功基準
- [ ] バックエンドビルドがエラーなく完了すること
- [ ] バックエンドテストが全てパスすること
- [ ] フロントエンドビルドがエラーなく完了すること
- [ ] E2Eテストで主要機能が正常動作すること
- [ ] /specials へのアクセスが404エラーになること

### 7.2 品質基準
- [ ] コンパイルエラーが0件
- [ ] テスト失敗が0件
- [ ] 型定義エラーが0件
- [ ] リンター警告が新規に発生していないこと

### 7.3 ドキュメント基準
- [ ] 調査結果ドキュメントが存在すること
- [ ] 実装計画ドキュメントが存在すること
- [ ] コミットメッセージに適切な説明が含まれていること
- [ ] PRに変更内容とテスト結果が記載されていること

## 8. ロールバック計画

万が一、実装後に問題が発生した場合のロールバック手順:

### 8.1 コードロールバック
```bash
# feature ブランチを削除
git checkout main
git branch -D feature/remove-specials

# リモートブランチも削除
git push origin --delete feature/remove-specials
```

### 8.2 データベースロールバック
注意: データベースロールバックは困難です。事前バックアップが必須です。

マイグレーションのロールバック:
```bash
# Liquibase でロールバック
liquibase rollback --count=1
```

ただし、データの復元は別途バックアップから行う必要があります。

## 9. 次ステップ

実装計画策定完了。次フェーズ（IMPLEMENT）に移行し、この計画に従って実装を実施します。

実装時の注意事項:
1. 必ず feature/remove-specials ブランチで作業すること
2. 各フェーズでビルド確認を行うこと
3. 最後にE2Eテストを実施すること
4. 問題が発生した場合は計画を見直すこと