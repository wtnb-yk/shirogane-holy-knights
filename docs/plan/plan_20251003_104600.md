# 実装計画書: SONGSページのGrid表示化

## 計画日時
2025-10-03 10:46:00

## 実装対象
SONGSページのカード配列をリスト形式（1列）からGrid形式（複数列）に変更

## 調査結果の参照
- 調査報告書: `docs/investigate/investigate_20251003_104232.md`

## 実装方針

### 設計方針
VideosGrid実装パターンを踏襲し、以下の方針で実装する：
1. **gridConfigの分離**: Grid設定を独立したconfigファイルで管理
2. **パフォーマンス最適化**: useMemo/useCallbackでメモ化
3. **再利用性**: 既存の共通コンポーネント（InteractiveCard, StaggeredItem）を最大限活用
4. **レスポンシブ対応**: Tailwind CSSのブレークポイントを使用
5. **一貫性**: 他のGrid実装（VideosGrid, DiscographyGrid）との整合性を保つ

### アーキテクチャ決定

#### Grid列設定
```typescript
const SONG_GRID_COLUMNS: GridColumnConfig = {
  sm: 2,    // モバイル: 2列
  md: 3,    // タブレット: 3列
  lg: 4,    // デスクトップ小: 4列
  xl: 4     // デスクトップ大: 4列
};
```

**決定理由:**
- VideosGridと同様のパターンで統一
- モバイルでは2列で視認性を確保
- デスクトップでは4列で情報密度を高める

#### カードデザイン
```
+-----------------------------+
|                             |
|   [YouTubeサムネイル]       |
|   (aspect-video 16:9)       |
|                             |
| 楽曲タイトル (2行まで)      |
| アーティスト名              |
| [歌唱回数] [最新歌唱日]     |
+-----------------------------+
```

**デザイン要素:**
- サムネイル: aspect-video (16:9)、YouTubeサムネイル画像
- 楽曲タイトル: font-bold, line-clamp-2（2行で切り捨て）
- アーティスト名: text-secondary, text-sm
- 統計情報: 歌唱回数アイコン + 数値、最新歌唱日アイコン + 日付
- ボーダー: カード全体を囲むのみ
- ホバーエフェクト: scale-105, border-accent-gold/50

## 詳細実装タスク

### 優先度: P0（必須）

#### タスク1: gridConfig.ts の作成
**ファイル:** `frontend/src/features/songs/config/gridConfig.ts`
**タイプ:** 新規作成
**優先度:** P0

**実装内容:**
1. GridColumnConfigの定義
   ```typescript
   const SONG_GRID_COLUMNS: GridColumnConfig = {
     sm: 2,
     md: 3,
     lg: 4,
     xl: 4
   };
   ```

2. 設定取得関数
   ```typescript
   export function getSongGridColumns(): GridColumnConfig {
     return SONG_GRID_COLUMNS;
   }
   ```

3. デフォルトメッセージ
   ```typescript
   export const DEFAULT_EMPTY_MESSAGE = {
     title: '楽曲が見つかりませんでした',
     subtitle: '検索条件を変更してお試しください'
   };
   ```

4. スケルトン表示数
   ```typescript
   export const DEFAULT_SKELETON_COUNT = 8;
   ```

**参考ファイル:**
- `frontend/src/features/archives/config/gridConfig.ts`

**完了条件:**
- gridConfig.tsが作成され、型エラーがない
- getSongGridColumns()が正しいGridColumnConfigを返す

---

#### タスク2: StreamSongGridCard.tsx の作成
**ファイル:** `frontend/src/features/songs/components/cards/StreamSongGridCard.tsx`
**タイプ:** 新規作成
**優先度:** P0

**実装内容:**
1. コンポーネント構造
   ```typescript
   'use client';

   import React from 'react';
   import { StreamSong } from '@/features/songs/types/types';
   import { InteractiveCard } from '@/components/Card/InteractiveCard';
   import { StaggeredItem } from '@/components/Card/StaggeredItem';
   import { SongCardThumbnail } from './internals/SongCardThumbnail';
   import { formatDate } from '@/utils/dateFormat';
   import { Music, Calendar } from 'lucide-react';

   interface StreamSongGridCardProps {
     song: StreamSong;
     index: number;
     onClick: (song: StreamSong) => void;
   }
   ```

2. レイアウト実装
   - StaggeredItemでラップ（アニメーション用）
   - InteractiveCardまたはdivでクリック可能に
   - aspect-videoのサムネイル
   - 楽曲タイトル（line-clamp-2）
   - アーティスト名
   - 歌唱回数と最新歌唱日の表示

3. スタイリング
   - ホバー時: border-accent-gold/50, scale-105
   - カード全体にボーダー
   - 内部は区切り線なし

**参考ファイル:**
- `frontend/src/features/archives/components/cards/VideoCard.tsx`
- `frontend/src/features/songs/components/cards/StreamSongListCard.tsx`

**完了条件:**
- StreamSongGridCard.tsxが作成され、型エラーがない
- 縦型レイアウトでカードが表示される
- ホバーエフェクトが動作する

---

#### タスク3: StreamSongsList.tsx の修正
**ファイル:** `frontend/src/features/songs/components/lists/StreamSongsList.tsx`
**タイプ:** 修正
**優先度:** P0

**実装内容:**
1. import文の追加
   ```typescript
   import { useMemo, useCallback } from 'react';
   import { StreamSongGridCard } from '../cards/StreamSongGridCard';
   import { getSongGridColumns, DEFAULT_EMPTY_MESSAGE } from '../../config/gridConfig';
   import { generateGridClassName } from '@/features/archives/utils/gridLayoutCalculator';
   ```

2. gridConfigのメモ化
   ```typescript
   const gridConfig = useMemo(() => {
     const gridColumns = getSongGridColumns();
     const gridClassName = generateGridClassName(gridColumns);
     return {
       columns: gridColumns,
       className: gridClassName.replace('grid ', '')
     };
   }, []);
   ```

3. renderItem/renderSkeletonのメモ化
   ```typescript
   const renderItem = useCallback((song: StreamSong, index: number) => (
     <StreamSongGridCard
       key={song.id}
       song={song}
       index={index}
       onClick={onSongClick}
     />
   ), [onSongClick]);

   const renderSkeleton = useCallback((index: number) => (
     <SkeletonSongCard key={index} />
   ), []);
   ```

4. emptyMessageのメモ化
   ```typescript
   const emptyMessage = useMemo(() => DEFAULT_EMPTY_MESSAGE, []);
   ```

5. BaseGridのprops更新
   - gridClassName: `gridConfig.className`に変更
   - renderItem: メモ化版に変更
   - renderSkeleton: メモ化版に変更
   - emptyMessage: メモ化版に変更

**参考ファイル:**
- `frontend/src/features/archives/components/grids/VideosGrid.tsx`

**完了条件:**
- StreamSongsList.tsxが修正され、型エラーがない
- gridConfigがメモ化されている
- Grid表示が正しく動作する

---

#### タスク4: SkeletonSongCard.tsx の修正
**ファイル:** `frontend/src/features/songs/components/cards/SkeletonSongCard.tsx`
**タイプ:** 修正
**優先度:** P0

**実装内容:**
1. レイアウト変更（横長 → 縦型）
   - aspect-videoのサムネイル部分
   - タイトル部分（2行）
   - アーティスト名部分
   - 統計情報部分（歌唱回数、最新歌唱日）

2. 構造例
   ```typescript
   <Card className="rounded-lg overflow-hidden animate-pulse">
     <CardContent className="p-0">
       {/* サムネイル */}
       <Skeleton className="aspect-video w-full" />

       {/* テキスト情報 */}
       <div className="p-4 space-y-2">
         {/* タイトル */}
         <Skeleton className="h-4 w-full" />
         <Skeleton className="h-4 w-3/4" />

         {/* アーティスト */}
         <Skeleton className="h-3 w-1/2" />

         {/* 統計情報 */}
         <div className="flex items-center justify-between pt-2">
           <Skeleton className="h-3 w-16" />
           <Skeleton className="h-3 w-20" />
         </div>
       </div>
     </CardContent>
   </Card>
   ```

**完了条件:**
- SkeletonSongCard.tsxが修正され、縦型レイアウトになる
- Grid表示時に違和感がない

---

### 優先度: P1（推奨）

#### タスク5: Playwright E2Eテスト
**タイプ:** テスト・検証
**優先度:** P1

**テスト内容:**
1. ブラウザ起動とページ遷移
   - `http://localhost:3001/songs`にアクセス
   - ページが正常に表示されることを確認

2. Grid表示の確認
   - カードがGrid形式で表示されている
   - モバイル（sm）で2列表示
   - タブレット（md）で3列表示
   - デスクトップ（lg, xl）で4列表示

3. カード要素の確認
   - サムネイル画像が表示されている
   - 楽曲タイトルが表示されている（2行まで）
   - アーティスト名が表示されている
   - 歌唱回数が表示されている
   - 最新歌唱日が表示されている

4. インタラクション確認
   - カードホバー時のエフェクト（scale-105, border変化）
   - カードクリック時の動作

5. レスポンシブ動作確認
   - ブラウザサイズ変更時のGrid列数変化
   - 各ブレークポイントでのレイアウト確認

**完了条件:**
- 全てのテスト項目がPASSする
- レスポンシブ動作が正常
- ホバーエフェクトが正常

---

## ファイル変更計画

### 新規作成ファイル（2ファイル）
1. `frontend/src/features/songs/config/gridConfig.ts`
   - 役割: Grid設定の管理
   - サイズ見積もり: 約50行

2. `frontend/src/features/songs/components/cards/StreamSongGridCard.tsx`
   - 役割: Grid用の縦型カードコンポーネント
   - サイズ見積もり: 約80-100行

### 修正ファイル（2ファイル）
1. `frontend/src/features/songs/components/lists/StreamSongsList.tsx`
   - 変更内容: gridConfig導入、メモ化、Grid表示対応
   - 変更規模: 中（20-30行の追加・変更）

2. `frontend/src/features/songs/components/cards/SkeletonSongCard.tsx`
   - 変更内容: 縦型レイアウトへの変更
   - 変更規模: 中（全体的な構造変更）

### 削除ファイル
なし

### 影響範囲分析
- **直接影響:** StreamSongsList.tsxを使用している画面
  - `/songs`ページ（Stream Songs）
  - `/concert-songs`ページ（Concert Songs）※同じコンポーネントを使用している場合

- **間接影響:** なし
  - StreamSongListCard.tsxは残すため、既存機能への影響なし

---

## テスト戦略

### 単体テスト（スコープ外）
現時点では単体テストは実装しない。将来的に以下をカバーする：
- StreamSongGridCardのレンダリング
- gridConfig関数の戻り値

### 統合テスト（スコープ外）
現時点では統合テストは実装しない。

### E2Eテスト（必須）
**ツール:** Playwright（MCPツール）

**テストシナリオ:**

#### シナリオ1: 基本表示確認
1. `/songs`ページにアクセス
2. Grid形式でカードが表示されることを確認
3. 各カードに以下の要素が表示されることを確認
   - サムネイル
   - 楽曲タイトル
   - アーティスト名
   - 歌唱回数
   - 最新歌唱日

#### シナリオ2: レスポンシブ確認
1. ブラウザサイズをモバイルサイズに変更（例: 375x667）
2. 2列表示になることを確認
3. ブラウザサイズをタブレットサイズに変更（例: 768x1024）
4. 3列表示になることを確認
5. ブラウザサイズをデスクトップサイズに変更（例: 1920x1080）
6. 4列表示になることを確認

#### シナリオ3: インタラクション確認
1. カードにホバー
2. scale-105のホバーエフェクトを確認
3. ボーダー色が変化することを確認
4. カードをクリック
5. 詳細モーダルまたは詳細ページが表示されることを確認

#### シナリオ4: ローディング状態確認
1. ページロード中の状態を確認
2. SkeletonSongCardが表示されることを確認
3. Grid形式で表示されることを確認

#### シナリオ5: 空状態確認
1. 検索条件で結果が0件になるよう設定
2. 空状態メッセージが表示されることを確認
3. メッセージ内容が正しいことを確認

---

## リスク分析と対策

### リスク1: 既存の横長カードへの依存
**リスク内容:**
他の画面がStreamSongListCard（横長カード）に依存している可能性

**影響度:** 低
**発生確率:** 低

**対策:**
- StreamSongListCard.tsxは削除せず、そのまま残す
- 新しくStreamSongGridCard.tsxを作成
- 既存の機能には影響なし

**回避策:**
- 既存のStreamSongListCardを使用している箇所を検索
- 必要に応じて段階的に移行

---

### リスク2: レスポンシブレイアウトの崩れ
**リスク内容:**
異なる画面サイズでレイアウトが崩れる可能性

**影響度:** 中
**発生確率:** 中

**対策:**
- Playwrightで複数の画面サイズをテスト
- 実際のデバイスでも確認
- Tailwind CSSのブレークポイントを正しく使用

**回避策:**
- gridConfig.tsで設定を一元管理
- 既存のVideosGrid実装パターンを踏襲

---

### リスク3: パフォーマンス劣化
**リスク内容:**
Grid表示により多くのカードが同時にレンダリングされ、パフォーマンスが低下する可能性

**影響度:** 低
**発生確率:** 低

**対策:**
- useMemo/useCallbackでメモ化
- React.memoでコンポーネントをメモ化
- StaggeredItemで段階的なアニメーション

**回避策:**
- 必要に応じて仮想スクロール（react-window等）を検討
- 現時点では対応不要（将来的な最適化課題）

---

### リスク4: サムネイル画像の読み込み遅延
**リスク内容:**
複数のYouTubeサムネイル画像が同時に読み込まれ、表示が遅い

**影響度:** 低
**発生確率:** 中

**対策:**
- SongCardThumbnailでlazyLoadingを使用
- 既存の実装を踏襲

**回避策:**
- 必要に応じてプレースホルダー画像を表示
- 現時点では既存の実装で対応

---

## 実装順序（推奨）

### フェーズ1: 基礎実装（必須）
1. **gridConfig.ts作成**（タスク1）
   - 所要時間: 15分
   - 依存関係: なし

2. **StreamSongGridCard.tsx作成**（タスク2）
   - 所要時間: 30-45分
   - 依存関係: gridConfig.ts

3. **StreamSongsList.tsx修正**（タスク3）
   - 所要時間: 20-30分
   - 依存関係: gridConfig.ts, StreamSongGridCard.tsx

4. **SkeletonSongCard.tsx修正**（タスク4）
   - 所要時間: 15-20分
   - 依存関係: なし

**フェーズ1合計見積もり時間:** 約1.5-2時間

---

### フェーズ2: テスト・検証（推奨）
5. **Playwright E2Eテスト**（タスク5）
   - 所要時間: 30-45分
   - 依存関係: フェーズ1完了

**フェーズ2合計見積もり時間:** 約30-45分

---

### フェーズ3: 最終確認・コミット
6. **動作確認**
   - ブラウザで実際の動作確認
   - レスポンシブ動作確認
   - 所要時間: 15分

7. **git commit & push**
   - 変更内容のコミット
   - feature/songs-grid-layoutブランチにpush
   - 所要時間: 5分

**フェーズ3合計見積もり時間:** 約20分

---

**全体見積もり時間:** 約2.5-3時間

---

## 技術的詳細

### 使用する技術・ライブラリ
- **React**: コンポーネント実装
- **TypeScript**: 型安全性
- **Tailwind CSS**: スタイリング、レスポンシブ対応
- **lucide-react**: アイコン（Music, Calendar）
- **BaseGrid**: 既存の共通Gridコンポーネント
- **InteractiveCard**: 既存の共通カードコンポーネント
- **StaggeredItem**: 既存のアニメーションコンポーネント

### 依存関係
```
gridConfig.ts
    ↓
StreamSongGridCard.tsx ← StreamSongsList.tsx
    ↓
SkeletonSongCard.tsx
```

---

## 参考リソース

### 参考ファイル
1. **Grid実装パターン**
   - `frontend/src/features/archives/components/grids/VideosGrid.tsx`
   - `frontend/src/features/archives/config/gridConfig.ts`
   - `frontend/src/features/archives/utils/gridLayoutCalculator.ts`

2. **カード実装パターン**
   - `frontend/src/features/archives/components/cards/VideoCard.tsx`
   - `frontend/src/features/songs/components/cards/StreamSongListCard.tsx`

3. **共通コンポーネント**
   - `frontend/src/components/Layout/BaseGrid.tsx`
   - `frontend/src/components/Card/InteractiveCard.tsx`
   - `frontend/src/components/Card/StaggeredItem.tsx`

4. **型定義**
   - `frontend/src/features/songs/types/types.ts`
   - `frontend/src/features/archives/types/specialGridTypes.ts`

---

## 承認基準

### 実装完了条件
- [ ] gridConfig.tsが作成され、型エラーがない
- [ ] StreamSongGridCard.tsxが作成され、正しく表示される
- [ ] StreamSongsList.tsxが修正され、Grid表示になる
- [ ] SkeletonSongCard.tsxが修正され、縦型レイアウトになる
- [ ] 型エラーが全て解消されている
- [ ] コンパイルエラーがない

### テスト完了条件
- [ ] Playwright E2Eテストが全てPASSする
- [ ] 複数の画面サイズでGrid表示が正しい
- [ ] ホバーエフェクトが動作する
- [ ] カードクリック時の動作が正常
- [ ] ローディング状態が正しく表示される
- [ ] 空状態が正しく表示される

### コミット条件
- [ ] 実装完了条件を満たす
- [ ] テスト完了条件を満たす
- [ ] コードレビューが完了（該当する場合）
- [ ] CLAUDE.mdの動作確認ルールに準拠

---

## 次フェーズ（Implement）への推奨事項

### 実装推奨
調査・計画の結果、実装を推奨する。

**理由:**
1. 技術的に実現可能
2. 既存パターン（VideosGrid）を流用できる
3. リスクが低い
4. ユーザビリティの向上が期待できる
5. 既存システムとの整合性が取れている

### 実装開始前のチェックリスト
- [ ] ブランチ `feature/songs-grid-layout` が作成されている
- [ ] 最新のmainブランチからブランチが作成されている
- [ ] 開発環境が起動している（`http://localhost:3001`）
- [ ] 依存関係が最新（`pnpm install`実行済み）

### 実装時の注意事項
1. **段階的な実装**
   - 1ファイルずつ実装・確認を行う
   - 各ファイル作成後、型エラーを即座に解消する

2. **既存コードの尊重**
   - StreamSongListCard.tsxは削除しない
   - 既存のインポートパスを崩さない

3. **テスト駆動**
   - 各実装後、Playwrightで動作確認を行う
   - 問題があれば即座に修正する

4. **CLAUDE.mdの遵守**
   - 実装後は必ずPlaywrightで動作確認
   - 確認できていないことは報告しない
   - 問題が解決していない場合は明確に報告する

---

## 完了報告フォーマット

実装完了時には以下の形式で報告する：

```
status: SUCCESS
next: IMPLEMENT
details: "実装プラン策定完了。plan_20251003_104600.mdに詳細記録。実装フェーズに移行可能。"
```