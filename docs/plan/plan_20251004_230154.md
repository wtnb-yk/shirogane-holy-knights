# 実装プラン: event_typesに「その他（others）」追加

**作成日時**: 2025-10-04 23:01:54
**ベースブランチ**: main
**推奨ブランチ名**: feature/add-others-event-type

---

## 1. 実装方針

### 基本方針
- event_typesテーブルに新しいタイプ「others」を追加
- バックエンドはDB駆動のため修正不要
- フロントエンドのUI表示部分（ラベル・色）のみ修正
- ツールのマッピングを更新

### アーキテクチャ特性の活用
- **バックエンド**: `findAllEventTypes()`がDBから動的取得するため自動対応
- **フロントエンド**: ハードコードされたラベル・色定義のみ更新が必要
- **APIレスポンス**: 後方互換性は保たれる

---

## 2. タスク分解と優先度

### Phase 1: データベース（優先度: 高）

#### Task 1.1: マイグレーションファイル作成
- **ファイル**: `backend/src/main/resources/db/changelog/changes/030-add-others-event-type.sql`
- **内容**:
  ```sql
  --liquibase formatted sql

  --changeset shirogane:030-add-others-event-type
  --comment: Add others event type to event_types table

  -- その他タイプを追加
  INSERT INTO event_types (type) VALUES ('others');
  ```
- **参考**: `022-add-campaign-event-type.sql`

### Phase 2: フロントエンド（優先度: 高）

#### Task 2.1: イベントタイプラベル修正（その1）
- **ファイル**: `frontend/src/features/calendar/utils/eventTypeUtils.ts:1-12`
- **修正内容**:
  ```typescript
  case 'others':
    return 'その他';
  ```

#### Task 2.2: イベントタイプラベル修正（その2）
- **ファイル**: `frontend/src/components/Section/EventTypePresetsSection.tsx:19-30`
- **修正内容**:
  ```typescript
  case 'others':
    return 'その他';
  ```
- **注意**: 将来的には`eventTypeUtils.ts`に統一推奨（DRY原則）

#### Task 2.3: バッジスタイル修正
- **ファイル**: `frontend/src/features/calendar/utils/eventBadgeStyles.ts:5-9`
- **修正内容**:
  ```typescript
  others: 'purple'
  ```
- **理由**: 既存色（blue, orange, green）と区別可能な色を選択

### Phase 3: ツール（優先度: 中）

#### Task 3.1: CSVインポータ修正
- **ファイル**: `tools/scripts/calendar_importer.py:66-70`
- **修正内容**:
  ```python
  EVENT_TYPE_MAPPING = {
      'event': 1,
      'goods': 2,
      'campaign': 3,
      'others': 4,  # 追加
  }
  ```
- **注意**: `get_event_type_mapping()`関数がDBから動的取得するため必須ではないが、明示的な定義を推奨

### Phase 4: 動作確認（優先度: 高）

#### Task 4.1: Playwright E2Eテスト
1. DBマイグレーション実行確認
2. API動作確認（`GET /api/calendar/event-types`で'others'取得）
3. UI表示確認（「その他」ラベル、purpleバッジ）
4. フィルタリング動作確認
5. CSVインポート動作確認（'others'タイプのイベント登録）

---

## 3. ファイル変更計画

### 新規作成（1ファイル）
```
backend/src/main/resources/db/changelog/changes/
  └── 030-add-others-event-type.sql（新規）
```

### 修正（4ファイル）
```
frontend/src/
  ├── features/calendar/utils/
  │   ├── eventTypeUtils.ts（修正: switch文に1 case追加）
  │   └── eventBadgeStyles.ts（修正: COLOR_MAPに1エントリ追加）
  └── components/Section/
      └── EventTypePresetsSection.tsx（修正: switch文に1 case追加）

tools/scripts/
  └── calendar_importer.py（修正: MAPPINGに1エントリ追加）
```

---

## 4. テスト戦略

### 4.1 DBマイグレーションテスト
- ✅ マイグレーション実行成功確認
- ✅ event_typesテーブルに'others'（id=4）が追加されたことを確認
- ✅ UNIQUE制約により重複登録不可を確認

### 4.2 APIテスト
- **エンドポイント**: `GET http://localhost:3001/api/calendar/event-types`
- **期待値**: レスポンスに`{"id": 4, "type": "others"}`が含まれる

### 4.3 フロントエンドE2Eテスト（Playwright）
1. カレンダーページ（`http://localhost:3001/calendar`）にアクセス
2. イベントタイプフィルタで「その他」が表示されることを確認
3. 「その他」を選択してフィルタリング動作確認
4. バッジがpurple色で表示されることを確認

### 4.4 ツールテスト
- calendar_events.csvに'others'タイプのテストデータ追加
- `python tools/scripts/calendar_importer.py`実行
- DBに正常にインポートされることを確認

---

## 5. リスク分析と対策

### 低リスク

#### R1: DBマイグレーション失敗
- **対策**: liquibase rollback機能を利用
- **影響範囲**: event_typesテーブルのみ（事前バックアップ不要）
- **回復手順**: `DELETE FROM event_types WHERE type = 'others';`

#### R2: フロントエンド表示崩れ
- **対策**: Playwrightでスクリーンショット確認
- **影響範囲**: バッジ色のみ（既存タイプに影響なし）
- **回復手順**: 修正をrevert

### 極小リスク

#### R3: 既存データへの影響
- **影響**: なし（追加のみ、既存レコード変更なし）

#### R4: APIレスポンス変更
- **影響**: なし（配列に1要素追加のみ、後方互換性あり）

---

## 6. 実装順序（推奨）

```
1. DBマイグレーションファイル作成
   ↓
2. マイグレーション実行（Docker環境）
   ↓
3. フロントエンド3ファイル修正
   ↓
4. ツール修正
   ↓
5. Playwright E2Eテスト実行
   ↓
6. 全テスト合格確認
   ↓
7. コミット＆プッシュ
```

---

## 7. 完了条件（Definition of Done）

- [ ] 030-add-others-event-type.sql作成完了
- [ ] マイグレーション実行成功
- [ ] フロントエンド3ファイル修正完了
- [ ] ツール修正完了
- [ ] Playwright E2Eテスト全て合格
- [ ] ブラウザで実際に「その他」タイプが表示されることを目視確認
- [ ] フィルタリング動作確認
- [ ] バッジ色（purple）表示確認

---

## 8. 推奨事項

### コードの改善提案（今回のスコープ外）

#### 提案1: getEventTypeLabel関数の重複排除
- **現状**: `EventTypePresetsSection.tsx`内にgetEventTypeLabelが重複定義
- **改善**: `eventTypeUtils.ts`のgetEventTypeLabelを使用するようリファクタリング
- **理由**: DRY原則違反（同じロジックが2箇所に存在）
- **実装方法**:
  ```typescript
  import { getEventTypeLabel } from '@/features/calendar/utils/eventTypeUtils';
  ```

#### 提案2: イベントタイプ色定義の外部化
- **現状**: バッジ色がハードコード
- **改善**: DBまたは設定ファイル化
- **メリット**: UI修正なしでタイプ追加可能
- **影響範囲**: 中〜大（アーキテクチャ変更）

---

## 9. 関連ドキュメント

- **調査結果**: `docs/investigate/investigate_20251004_225327.md`
- **DB定義**: `backend/src/main/resources/db/changelog/changes/021-create-calendar-tables.sql:7-10`
- **関連マイグレーション**: `022-add-campaign-event-type.sql`

---

## 10. 技術的詳細

### データベーススキーマ
```sql
CREATE TABLE event_types (
    id SERIAL PRIMARY KEY,
    type VARCHAR(30) NOT NULL UNIQUE
);
```

### 既存データ
| id | type     |
|----|----------|
| 1  | event    |
| 2  | goods    |
| 3  | campaign |
| 4  | others   | ← 追加

### 制約
- VARCHAR(30): 'others'（6文字）は問題なし
- SERIAL: 自動採番でID=4が割り当てられる見込み
- ON DELETE RESTRICT: 使用中typeは削除不可

---

## 11. 実装チェックリスト

### Phase 1: 準備
- [ ] feature/add-others-event-typeブランチ作成
- [ ] mainブランチから最新をpull

### Phase 2: 実装
- [ ] 030-add-others-event-type.sql作成
- [ ] eventTypeUtils.ts修正
- [ ] EventTypePresetsSection.tsx修正
- [ ] eventBadgeStyles.ts修正
- [ ] calendar_importer.py修正

### Phase 3: テスト
- [ ] Docker環境起動
- [ ] マイグレーション実行確認
- [ ] API動作確認（curl or Postman）
- [ ] Playwrightテスト実行
- [ ] ブラウザ目視確認

### Phase 4: 完了
- [ ] 全ファイル変更をコミット
- [ ] プッシュ＆PR作成
- [ ] レビュー依頼

---

**備考**:
- 本プランは`docs/investigate/investigate_20251004_225327.md`の調査結果に基づいて策定
- 実装中に新たな課題が発見された場合は、本ドキュメントを更新すること
