# CloudFrontパフォーマンス最適化実装計画

## プラン策定日時
2025-09-29

## 実装概要
既存の画像コンポーネントをOptimizedImageコンポーネントに移行し、遅延読み込みとプレースホルダー機能により画像パフォーマンスを改善します。

## 調査結果の要約
- OptimizedImageコンポーネントが存在するが、全13箇所で未使用
- 全て標準のNext.js Imageコンポーネントを直接使用
- CloudFront設定は適切（PriceClass_200で日本対応済み）
- 主要な問題は遅延読み込み機能の未活用

## フェーズ1: 優先度の高いコンポーネントの移行

### 対象コンポーネント（優先順）

1. **NewsCardImage**
   - ファイル: `frontend/src/features/news/components/cards/internals/NewsCardImage.tsx`
   - 理由: ニュース一覧で多数表示されるため効果大
   - 推定作業時間: 1時間

2. **DiscographyCard**
   - 理由: ディスコグラフィーページで複数画像の同時表示
   - 推定作業時間: 1時間

3. **AlbumCoverImage**
   - 理由: アルバム詳細ページの大きめ画像で最適化効果大
   - 推定作業時間: 1時間

### 実装内容
- `next/image`から`OptimizedImage`コンポーネントへの置換
- Intersection Observerによる遅延読み込みの活用
- プレースホルダー表示によるUX向上
- 適切なsizesプロパティの設定

## フェーズ2: 全画像コンポーネントの移行

### 対象コンポーネント（10箇所）
- EventImage
- HeroSection
- ProfileSection
- YouTubeLinkSection
- SongCardThumbnail
- ArchiveCardImage
- その他の画像使用箇所

推定作業時間: 各1時間、計10時間（段階的に実施可能）

## 技術的実装詳細

### コンポーネント移行の具体例

```typescript
// 変更前（NewsCardImage.tsx）
import Image from 'next/image';

<Image
  src={imageUrl}
  alt={alt}
  fill
  className="object-cover transition-transform duration-300 group-hover:scale-105"
  loading="lazy"
  sizes="(max-width: 767px) 100vw, 320px"
  placeholder="blur"
  blurDataURL={IMAGE_STYLES.placeholder}
/>

// 変更後
import { OptimizedImage } from '@/components/Image/OptimizedImage';

<OptimizedImage
  src={imageUrl}
  alt={alt}
  fill
  className="object-cover transition-transform duration-300 group-hover:scale-105"
  sizes="(max-width: 767px) 100vw, 320px"
  priority={false} // 遅延読み込みを有効化
/>
```

### OptimizedImageの主な機能
- **遅延読み込み**: Intersection Observerでビューポートに入った時点で読み込み
- **プレースホルダー**: 画像読み込み中はblurまたはスケルトン表示
- **エラーハンドリング**: 読み込み失敗時の代替表示
- **パフォーマンス最適化**: 不要な画像読み込みを防止

## ファイル変更計画

### 修正対象ファイル（フェーズ1）
1. `/frontend/src/features/news/components/cards/internals/NewsCardImage.tsx`
   - import文の変更
   - ImageコンポーネントをOptimizedImageに置換
   - priorityプロパティの追加

2. DiscographyCardファイル（場所要特定）
   - 同様の変更パターン

3. AlbumCoverImageファイル（場所要特定）
   - 同様の変更パターン

### 修正対象ファイル（フェーズ2）
- 残り10箇所のコンポーネントファイル
- 各ファイルで同様のパターンで変更

### 新規作成ファイル
なし（既存のOptimizedImageコンポーネントを活用）

## テスト戦略

### E2Eテスト（Playwright使用）
1. **画像表示確認**
   - 初期表示でプレースホルダーが表示されること
   - スクロール時に画像が読み込まれること
   - hover効果が正常に動作すること

2. **レスポンシブ対応**
   - モバイル/タブレット/デスクトップでの表示確認
   - 適切なサイズの画像が読み込まれること

3. **エラーケース**
   - 画像URL不正時のフォールバック表示
   - ネットワークエラー時の挙動確認

### テストシナリオ
```typescript
// Playwrightテスト例
test('NewsCardImageの遅延読み込み動作確認', async ({ page }) => {
  await page.goto('/news');

  // プレースホルダーの確認
  await expect(page.locator('.bg-gray-200.animate-pulse')).toBeVisible();

  // スクロールして画像読み込み確認
  await page.scroll({ direction: 'down' });
  await expect(page.locator('img[alt*="ニュース"]')).toBeVisible();
});
```

## リスク分析と対策

### 想定されるリスク
1. **表示崩れ**: CSSクラスの互換性問題
   - 対策: 1コンポーネントずつ段階的に移行

2. **遅延読み込みの遅れ**: スクロール速度に追いつかない
   - 対策: Intersection Observer の threshold 調整

3. **既存機能への影響**: hover効果やクリック動作
   - 対策: Playwrightでの自動テスト実施

### 緊急時対応
- 問題発生時は即座にロールバック
- git revert による変更の取り消し
- 本番環境への影響を最小限に抑制

## 実装スケジュール

### Phase 1（3日間）
- Day 1: NewsCardImageの移行とテスト
- Day 2: DiscographyCardの移行とテスト
- Day 3: AlbumCoverImageの移行とテスト

### Phase 2（継続的に実施）
- 残りのコンポーネントを1日1-2個のペースで移行
- 各移行後にE2Eテストで動作確認

## 期待される効果

1. **初期ページロード高速化**
   - ビューポート外の画像を読み込まないため
   - データ転送量30-40%削減見込み

2. **ユーザー体験向上**
   - プレースホルダーによる視覚的フィードバック
   - スムーズな画像表示遷移

3. **ネットワーク効率改善**
   - 必要な画像のみ読み込み
   - 帯域幅の節約

## 完了条件
- 全13箇所の画像コンポーネントがOptimizedImageに移行完了
- E2Eテストが全て成功
- 本番環境での動作確認完了

## 次のアクション
1. NewsCardImageコンポーネントのOptimizedImage移行から開始
2. 各コンポーネント移行後、必ずPlaywrightでのE2Eテスト実施
3. フェーズ1完了後、効果測定と残りコンポーネントの計画策定