# 実装計画: album_tracksテーブルへのartistカラム追加

## 計画日時
2025-10-16 11:15:00

## 実装対象
album_tracksテーブルにartistカラムを追加し、Discography機能とCSVインポートツールを改修する。

## 前提条件
- 調査レポート: `docs/investigate/investigate_20251016_110545.md` に基づく
- ブランチ: `feature/add-artist-to-album-tracks`
- 既存データは削除可能（開発環境）

## 実装方針

### 基本方針
アルバムトラックごとにアーティスト情報を保持できるよう、album_tracksテーブルにartistカラムを追加する。これにより、コンピレーションアルバムなど、1つのアルバム内で複数のアーティストが混在する場合にも対応可能となる。

### アーキテクチャ上の決定
1. **データ正規化**: songs.artistに依存せず、album_tracks.artistとして独立管理
2. **後方互換性**: ドメインモデル・DTOは既に対応済みのため、破壊的変更なし
3. **データ整合性**: NOT NULL制約でartist情報を必須化

## 詳細タスク分解

### Priority 1: データベースマイグレーション
**Task 1.1: マイグレーションファイル作成**
- ファイル: `backend/src/main/resources/db/changelog/changes/034-add-artist-to-album-tracks.sql`
- 内容:
  - album_tracksテーブルをDROP（CASCADE）
  - 新しいテーブル定義でCREATE
  - カラム順序: id, album_id, song_id, artist, track_number, created_at
  - artistカラム: VARCHAR(255) NOT NULL
  - インデックス・外部キー制約の再作成
- 見積もり: 15分

**Task 1.2: changelog-master.xmlへの登録**
- ファイル: `backend/src/main/resources/db/changelog/changelog-master.xml`
- 034-add-artist-to-album-tracks.sqlをinclude
- 見積もり: 5分

### Priority 2: バックエンド修正
**Task 2.1: クエリビルダー修正**
- ファイル: `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumQueryBuilder.kt`
- 変更内容:
  - Line 30付近: `s.artist` → `atr.artist`
  - Line 80付近: `s.artist` → `atr.artist`
  - CONCAT関数内のartist取得元を変更
- 見積もり: 10分

**Task 2.2: RowMapper確認**
- ファイル: `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumRowMapper.kt`
- 内容: parts[2]でアーティストを取得する部分は変更不要（クエリ結果の順序は同じ）
- 見積もり: 5分（確認のみ）

### Priority 3: インポートツール修正
**Task 3.1: albums_importer.py修正**
- ファイル: `tools/scripts/albums_importer.py`
- 変更内容:
  - Line 224-241付近のINSERT文を修正
  - カラムに`artist`を追加
  - VALUESに`track['artist']`を追加（CSVから取得）
- 見積もり: 10分

### Priority 4: データ投入とテスト
**Task 4.1: データベースリセット**
- Docker Compose環境の再起動またはマイグレーション実行
- albums_importer.pyでCSVデータ投入
- 見積もり: 10分

**Task 4.2: バックエンド動作確認**
- API `/api/albums`へのリクエスト
- レスポンスのtracks[].artistに正しい値が入っているか確認
- 見積もり: 5分

**Task 4.3: フロントエンドE2Eテスト（Playwright）**
- http://localhost:3001/discography へアクセス
- アルバムを選択してモーダル表示
- トラックリストのアーティスト表示確認
- 複数のアルバムで確認（特にコンピレーションアルバム）
- 見積もり: 15分

## ファイル変更計画

### 新規作成
| ファイルパス | 目的 | 優先度 |
|------------|------|--------|
| `backend/src/main/resources/db/changelog/changes/034-add-artist-to-album-tracks.sql` | album_tracksテーブル再作成 | P1 |

### 修正
| ファイルパス | 変更内容 | 優先度 |
|------------|---------|--------|
| `backend/src/main/resources/db/changelog/changelog-master.xml` | 034をinclude | P1 |
| `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumQueryBuilder.kt` | s.artist → atr.artist | P2 |
| `tools/scripts/albums_importer.py` | INSERT文にartistカラム追加 | P3 |

### 削除
なし

### 確認のみ（変更不要）
| ファイルパス | 理由 |
|------------|------|
| `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumRowMapper.kt` | parts[2]で取得する構造は変わらない |
| `backend/src/main/kotlin/com/shirogane/holy/knights/domain/Album.kt` | AlbumTrackに既にartistフィールドあり |
| `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/dto/AlbumDto.kt` | AlbumTrackDtoに既にartistフィールドあり |
| `frontend/src/features/discography/components/AlbumTrackList.tsx` | 既にtrack.artistを表示している |

## テスト戦略

### 単体テスト
今回はスキーマ変更とクエリ修正が主体のため、単体テストの追加は不要。既存のテストが通ることを確認。

### 統合テスト
**データベース統合テスト**
- マイグレーション実行後のテーブル構造確認
- 外部キー制約の動作確認（CASCADE削除など）

**API統合テスト**
- `/api/albums` エンドポイントのレスポンス確認
- tracks配列内のartistフィールドの存在と値を確認

### E2Eテスト（Playwright使用）
**テストケース1: アルバム詳細表示**
1. http://localhost:3001/discography にアクセス
2. アルバムカードをクリック
3. モーダルが表示される
4. トラックリストに各トラックのアーティスト名が表示される
5. アーティスト名が正しい（CSVのデータと一致）

**テストケース2: コンピレーションアルバム**
1. "SPOTLIGHT vol.2" など、Various Artistsのアルバムを選択
2. 各トラックに異なるアーティスト名が表示される（複数アーティストの確認）

**テストケース3: 通常アルバム**
1. "のえさんぽ" など、単一アーティストのアルバムを選択
2. 全トラックで同じアーティスト名（白銀ノエル）が表示される

### テスト実行順序
1. マイグレーション実行
2. データインポート
3. バックエンド起動確認
4. API動作確認（curl等）
5. フロントエンド起動確認
6. Playwright E2Eテスト実行

## リスク分析と対策

### リスク1: マイグレーション失敗
**影響度**: 高
**発生確率**: 低
**対策**:
- マイグレーションファイルの構文を事前に確認
- DROP CASCADE を使用して依存関係を確実に削除
- 開発環境で十分にテスト

**ロールバック方法**:
- Liquibase rollbackコマンド実行
- または、Docker volumeを削除して再構築

### リスク2: 既存データとの不整合
**影響度**: 中
**発生確率**: 低
**対策**:
- CSVデータに全てのartist情報が含まれていることを確認済み
- インポートツールでartist値を必ず設定する（NOT NULL制約）

**ロールバック方法**:
- マイグレーションをロールバック
- 以前のスキーマでデータ再投入

### リスク3: クエリパフォーマンス劣化
**影響度**: 低
**発生確率**: 極低
**理由**:
- songs JOINは維持されるため、クエリ構造は変わらない
- artistカラムはalbum_tracksに追加されるだけ

**対策**:
- 必要に応じてalbum_tracks.artistにインデックスを追加（今回は不要と判断）

### リスク4: フロントエンド表示の不具合
**影響度**: 中
**発生確率**: 極低
**理由**:
- フロントエンドは既にtrack.artistを表示する実装済み
- DTOのフィールド名も変わらない

**対策**:
- Playwright E2Eテストで実際の表示を確認

## 実装手順

### Step 1: マイグレーション準備
1. `034-add-artist-to-album-tracks.sql` を作成
2. `changelog-master.xml` に追加

### Step 2: バックエンド修正
1. `AlbumQueryBuilder.kt` の修正（s.artist → atr.artist）
2. `AlbumRowMapper.kt` の確認

### Step 3: インポートツール修正
1. `albums_importer.py` の修正（INSERT文にartist追加）

### Step 4: 動作確認
1. Docker Compose環境の再起動（マイグレーション実行）
2. albums_importer.pyでデータ投入
3. バックエンドAPIの動作確認
4. Playwright E2Eテスト実行

### Step 5: コミットとPR作成
1. 変更をコミット
2. プッシュ
3. PR作成（必要に応じて）

## 成功基準

### 必須条件
1. ✅ マイグレーションが正常に実行される
2. ✅ album_tracksテーブルにartistカラムが追加される（NOT NULL）
3. ✅ albums_importer.pyでCSVデータが正常にインポートされる
4. ✅ `/api/albums` APIでtracks[].artistに値が入っている
5. ✅ Discographyページでトラックリストのアーティストが表示される
6. ✅ コンピレーションアルバムで複数アーティストが正しく表示される

### オプション条件
- パフォーマンスが劣化していない（体感レベル）
- エラーログが出ていない

## スケジュール見積もり

| フェーズ | 見積もり時間 |
|---------|-----------|
| マイグレーション作成 | 20分 |
| バックエンド修正 | 15分 |
| インポートツール修正 | 10分 |
| 動作確認・テスト | 30分 |
| **合計** | **75分（約1.5時間）** |

## 次フェーズへの引き継ぎ事項

### IMPLEMENTフェーズへ
このプランに基づいて実装を開始してください。

**実装順序の厳守**:
1. マイグレーション（データベース）
2. バックエンド
3. インポートツール
4. テスト・動作確認

**注意事項**:
- マイグレーションファイルのSQL構文を慎重に記述
- インポートツールのINSERT文でカラム順序を間違えない
- E2Eテストは必ず実行（ユーザー目線での確認）

## 添付資料

### 参照ドキュメント
- 調査レポート: `docs/investigate/investigate_20251016_110545.md`
- Liquibaseドキュメント: https://www.liquibase.org/
- Playwright MCPツール: 利用可能

### 関連ファイル一覧
- `backend/src/main/resources/db/changelog/changes/025-restructure-album-tables.sql` - 現在のスキーマ
- `backend/src/main/resources/db/changelog/changelog-master.xml` - マイグレーション管理
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumQueryBuilder.kt` - クエリビルダー
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/query/AlbumRowMapper.kt` - RowMapper
- `tools/scripts/albums_importer.py` - CSVインポートツール
- `tools/data/albums.csv` - ソースデータ

## 結論

album_tracksテーブルへのartistカラム追加は、以下の理由から実装可能と判断します：

1. **技術的実現性**: 既存のドメインモデル・DTO・UIは対応済み
2. **影響範囲の明確性**: 変更が必要なファイルは4つのみ
3. **テスト可能性**: Playwright E2Eテストで動作確認可能
4. **リスク管理**: 開発環境での実施のため、失敗時のロールバックも容易

見積もり時間は約1.5時間。IMPLEMENTフェーズでの実装を推奨します。