# 実装計画書: カレンダーModalコンポーネントのリファクタリング

**日時:** 2025/09/25 01:49:59
**ブランチ:** feature/modal-refactor
**対象コンポーネント:** DayEventsModal, EventDetailModal

## 1. 実装方針

### 1.1 基本方針
- **段階的リファクタリング**: 既存機能を維持しながら段階的に改善
- **責務の分離**: 単一責任原則に基づいたコンポーネント分割
- **共通処理の統合**: 重複コードを共通ユーティリティに集約
- **既存スタイルの維持**: 既存のUIデザインシステムとの整合性を保持

### 1.2 技術方針
- TypeScriptの型安全性を最大限活用
- React Hooksによる状態管理
- 既存のModalコンポーネント（@/components/ui/Modal）の継続利用
- 既存のスタイルシステムとの整合性維持

## 2. 詳細実装タスク

### フェーズ1: 共通ユーティリティ層の構築（優先度: 高）

#### タスク1.1: formatters.tsの作成
```typescript
// frontend/src/features/calendar/utils/formatters.ts
export const formatDate = (date: Date): string => {
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const weekDay = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
  return `${year}年${month}月${day}日（${weekDay}）`;
};

export const formatDateShort = (date: Date): string => {
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const weekDay = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
  return `${month}月${day}日（${weekDay}）`;
};

export const formatTime = (time?: string): string => {
  if (!time) return '';
  return time.slice(0, 5); // HH:MM形式
};
```

#### タスク1.2: eventTypeUtils.tsの作成
```typescript
// frontend/src/features/calendar/utils/eventTypeUtils.ts
export const getEventTypeLabel = (type: string): string => {
  switch (type) {
    case 'event':
      return 'イベント';
    case 'goods':
      return 'グッズ';
    case 'campaign':
      return 'キャンペーン';
    default:
      return type;
  }
};
```

#### タスク1.3: eventSortUtils.tsの作成
```typescript
// frontend/src/features/calendar/utils/eventSortUtils.ts
import { Event } from '../types';

export const sortEventsByTime = (events: Event[]): Event[] => {
  return [...events].sort((a, b) => {
    if (a.eventTime && b.eventTime) {
      return a.eventTime.localeCompare(b.eventTime);
    }
    if (a.eventTime) return -1;
    if (b.eventTime) return 1;
    return 0;
  });
};
```

### フェーズ2: DayEventsModalのリファクタリング（優先度: 高）

#### タスク2.1: ディレクトリ構造の作成
```
frontend/src/features/calendar/components/modals/DayEventsModal/
├── index.tsx
├── DayEventsModal.tsx
├── DayEventsHeader.tsx
├── DayEventsList.tsx
└── EmptyEventsMessage.tsx
```

#### タスク2.2: コンポーネントの分割実装

**DayEventsModal.tsx（メインコンテナ）**
- Modal制御ロジック
- 子コンポーネントの統合

**DayEventsHeader.tsx**
- カレンダーアイコンと日付表示
- formatDateユーティリティの使用

**DayEventsList.tsx**
- イベントリストの表示
- sortEventsByTimeユーティリティの使用
- EventListItemコンポーネントの利用

**EmptyEventsMessage.tsx**
- 予定なしメッセージの表示

### フェーズ3: EventDetailModalのリファクタリング（優先度: 高）

#### タスク3.1: ディレクトリ構造の作成
```
frontend/src/features/calendar/components/modals/EventDetailModal/
├── index.tsx
├── EventDetailModal.tsx
├── EventDetailHeader.tsx
├── EventTitle.tsx
├── EventImage.tsx
├── EventTimeInfo.tsx
└── EventDescription.tsx
```

#### タスク3.2: コンポーネントの分割実装

**EventDetailModal.tsx（メインコンテナ）**
- Modal制御ロジック
- 子コンポーネントの統合

**EventDetailHeader.tsx**
- 戻るボタンとタイトル表示
- ナビゲーション制御

**EventTitle.tsx**
- イベントタイトル表示
- バッジ表示（getEventTypeLabel使用）

**EventImage.tsx**
- 画像表示ロジック
- 画像URLの検証とフォールバック

**EventTimeInfo.tsx**
- 時刻情報の表示
- formatTimeユーティリティの使用

**EventDescription.tsx**
- 説明文と外部リンク表示

### フェーズ4: 関連コンポーネントの更新（優先度: 中）

#### タスク4.1: EventListItemの更新
- formatTimeを共通ユーティリティから使用
- getEventTypeLabelを共通ユーティリティから使用

#### タスク4.2: DayEventsBottomSheetの更新
- formatDateShortを共通ユーティリティから使用
- sortEventsByTimeを共通ユーティリティから使用

#### タスク4.3: インポートパスの更新
- 新しいModalコンポーネントパスへの更新
- 必要に応じてエイリアスの設定

### フェーズ5: テストと検証（優先度: 高）

#### タスク5.1: E2Eテストの実施
- Playwrightによる動作確認
- PC版とモバイル版の両方でテスト

#### タスク5.2: ビルド確認
- TypeScriptのコンパイルエラーがないか確認
- lint/formatチェック

## 3. ファイル変更計画

### 新規作成ファイル（13ファイル）
```
frontend/src/features/calendar/utils/
├── formatters.ts
├── eventTypeUtils.ts
└── eventSortUtils.ts

frontend/src/features/calendar/components/modals/
├── DayEventsModal/
│   ├── index.tsx
│   ├── DayEventsModal.tsx
│   ├── DayEventsHeader.tsx
│   ├── DayEventsList.tsx
│   └── EmptyEventsMessage.tsx
└── EventDetailModal/
    ├── index.tsx
    ├── EventDetailModal.tsx
    ├── EventDetailHeader.tsx
    ├── EventTitle.tsx
    ├── EventImage.tsx
    ├── EventTimeInfo.tsx
    └── EventDescription.tsx
```

### 修正ファイル（4ファイル）
- frontend/src/features/calendar/components/EventListItem.tsx
- frontend/src/features/calendar/components/DayEventsBottomSheet.tsx
- frontend/src/features/calendar/components/Calendar.tsx（インポートパス更新）
- frontend/src/features/calendar/components/MonthView.tsx（インポートパス更新）

### 削除ファイル（2ファイル）
- frontend/src/features/calendar/components/DayEventsModal.tsx
- frontend/src/features/calendar/components/EventDetailModal.tsx

## 4. テスト戦略

### 4.1 ユニットテスト
- 各ユーティリティ関数のテスト
- 分割された各コンポーネントの個別テスト

### 4.2 統合テスト
- Modal間の遷移テスト
- イベントデータの受け渡しテスト

### 4.3 E2Eテスト（Playwright）
1. カレンダーページを開く
2. 日付をクリックしてDayEventsModalを開く
3. イベントをクリックしてEventDetailModalを開く
4. 戻るボタンでDayEventsModalに戻る
5. Modalを閉じる

### 4.4 視覚的確認項目
- レイアウトの崩れがないか
- アニメーションが正常に動作するか
- レスポンシブデザインが機能しているか

## 5. リスク分析と対策

### リスク1: インポートパスの変更による既存コードの破損
**対策:**
- 段階的な移行（旧パスから新パスへのエイリアス設定）
- 全体検索でインポート箇所を特定してから変更

### リスク2: スタイルの崩れ
**対策:**
- 既存のCSSクラスを維持
- 各フェーズでPlaywrightによる視覚的確認
- スクリーンショット比較による差分確認

### リスク3: パフォーマンスの低下
**対策:**
- 過度なコンポーネント分割を避ける
- React.memoの適切な使用
- 不要な再レンダリングの防止

### リスク4: TypeScriptの型エラー
**対策:**
- 段階的な実装とビルド確認
- 型定義の明確化
- anyの使用を避ける

## 6. 実装スケジュール

### Day 1（2-3時間）
- フェーズ1: 共通ユーティリティ層の構築
- 既存コンポーネントでのユーティリティ動作確認

### Day 2（3-4時間）
- フェーズ2: DayEventsModalのリファクタリング
- フェーズ3: EventDetailModalのリファクタリング

### Day 3（2-3時間）
- フェーズ4: 関連コンポーネントの更新
- フェーズ5: テストと検証

## 7. 成功指標

### 定量的指標
- コード重複率: 30%以上削減
- コンポーネントサイズ: 各50行以下
- ビルド時間: 現状維持または改善
- パフォーマンス: First Contentful Paint時間の維持

### 定性的指標
- 責務が明確に分離されている
- 新機能追加が容易になる
- コードの可読性が向上する
- テストが書きやすくなる

## 8. 次のステップ

本実装計画に基づいて、IMPLEMENTフェーズに移行し、フェーズ1から順次実装を開始する。

各フェーズ完了後は必ず以下を実施：
1. TypeScriptビルド確認
2. Playwrightによる動作確認
3. Gitでのコミット（フェーズ単位）

## 9. 結論

本リファクタリングにより、カレンダーModalコンポーネントの保守性、再利用性、テスタビリティが大幅に向上する。段階的な実装により、リスクを最小限に抑えながら確実な改善を実現する。