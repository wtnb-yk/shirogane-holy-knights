# VRChatタグ追加実装プラン

## プロジェクト概要

**作成日時**: 2025-10-14 10:15:00
**ブランチ**: feature/add-vrchat-stream-tag
**目的**: stream_tagsテーブルにVRChatタグを追加し、フロントエンド・バックエンド・ツールで利用可能にする
**調査レポート**: [investigate_20251014_100942.md](../investigate/investigate_20251014_100942.md)

## 実装方針

### アーキテクチャの理解

システムは動的なタグ取得設計を採用しているため、**データベースへのタグ追加のみで全体が連動**します。

```
[データベース] ← [バックエンドAPI] ← [フロントエンド]
     ↓
  [ツール群]
```

### 変更が必要なコンポーネント

1. **データベース（必須）**: マイグレーションファイルでVRChatタグを追加
2. **ツール（推奨）**: stream_tag_extractor.pyにキーワードマッチングロジック追加

### 変更が不要なコンポーネント

- **バックエンド**: データベースから動的にタグ取得
- **フロントエンド**: APIから動的にタグ取得
- **ツール（importer）**: タグ名からIDを自動解決

## 詳細実装タスク

### 優先度1（必須・Phase 1）

#### タスク1-1: マイグレーションファイル作成
- **ファイル**: `backend/src/main/resources/db/changelog/changes/025-add-vrchat-stream-tag.sql`
- **内容**: VRChatタグ（ID: 17）をstream_tagsテーブルに追加
- **作業時間**: 10分
- **依存関係**: なし

```sql
--liquibase formatted sql

--changeset shirogane:025-add-vrchat-stream-tag
--comment: Add VRChat tag to stream_tags table

INSERT INTO public.stream_tags (id, name, description)
VALUES (17, 'VRChat', 'VRChat')
ON CONFLICT (name) DO NOTHING;

--rollback DELETE FROM stream_tags WHERE name = 'VRChat';
```

#### タスク1-2: Liquibase設定確認
- **ファイル**: `backend/src/main/resources/db/changelog/changelog.xml`
- **確認事項**: `<includeAll path="changes"/>`により自動読み込みされることを確認
- **作業**: 確認のみ（変更不要）
- **作業時間**: 5分
- **依存関係**: タスク1-1

### 優先度2（推奨・Phase 1）

#### タスク2-1: stream_tag_extractor.pyへのキーワードマッチング追加
- **ファイル**: `tools/scripts/stream_tag_extractor.py`
- **内容**: VRChatキーワードマッチングロジックを追加
- **挿入位置**: 既存のタグマッチングロジックの末尾（189行目付近）
- **作業時間**: 15分
- **依存関係**: なし

```python
elif tag_name == "VRChat":
    keywords = ["VRChat", "VRC", "vrchat", "バーチャル", "アバター", "ワールド巡り"]
    if any(keyword in title for keyword in keywords):
        matched_tags.append(tag_id)
```

### 優先度3（必須・Phase 2）

#### タスク3-1: ローカル環境でのマイグレーション実行
- **コマンド**: Docker Compose経由でLiquibaseマイグレーション実行
- **確認事項**:
  - マイグレーションの成功確認
  - stream_tagsテーブルにVRChatタグが追加されたことを確認
  - IDが17であることを確認
- **作業時間**: 10分
- **依存関係**: タスク1-1, タスク1-2

#### タスク3-2: データベース直接確認
- **コマンド**: PostgreSQLクライアントでstream_tagsテーブルを確認
- **SQL**: `SELECT * FROM stream_tags WHERE name = 'VRChat';`
- **作業時間**: 5分
- **依存関係**: タスク3-1

### 優先度4（必須・Phase 3）

#### タスク4-1: バックエンドAPIテスト
- **エンドポイント**: GET /api/stream-tags
- **確認事項**:
  - レスポンスにVRChatが含まれることを確認
  - タグの順序がアルファベット順であることを確認
- **作業時間**: 10分
- **依存関係**: タスク3-1

#### タスク4-2: フロントエンドE2Eテスト（Playwright）
- **テスト対象**: アーカイブページ（http://localhost:3001）
- **確認事項**:
  1. アーカイブページが正常に表示される
  2. ストリームタグのフィルタ選択肢にVRChatが表示される
  3. VRChatタグを選択してフィルタリングできる
  4. フィルタリング結果が正しく表示される
- **ツール**: Playwright MCPツール
- **作業時間**: 20分
- **依存関係**: タスク4-1

#### タスク4-3: ツールテスト（オプション）
- **対象**: stream_tag_extractor.py
- **コマンド**: `just stream-tags-extract-local`
- **確認事項**: VRChatキーワードが正しく抽出される
- **作業時間**: 10分
- **依存関係**: タスク2-1, タスク3-1

### 優先度5（必須・Phase 4）

#### タスク5-1: コミット
- **コミットメッセージ**:
```
feat: add VRChat tag to stream_tags table

- Add migration file 025-add-vrchat-stream-tag.sql
- Add VRChat keyword matching logic to stream_tag_extractor.py
- VRChat tag will be available for filtering in frontend

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```
- **作業時間**: 5分
- **依存関係**: 全テスト完了

#### タスク5-2: プッシュ
- **コマンド**: `git push origin feature/add-vrchat-stream-tag`
- **作業時間**: 5分
- **依存関係**: タスク5-1

## ファイル変更計画

### 新規作成（2ファイル）

1. **backend/src/main/resources/db/changelog/changes/025-add-vrchat-stream-tag.sql**
   - **目的**: VRChatタグをstream_tagsテーブルに追加
   - **内容**: INSERT文とロールバックSQL
   - **行数**: 約10行

2. **docs/plan/plan_20251014_101500.md**（本ファイル）
   - **目的**: 実装計画の文書化
   - **内容**: 実装方針、タスク分解、リスク分析
   - **行数**: 約400行

### 修正（1ファイル）

1. **tools/scripts/stream_tag_extractor.py**
   - **修正箇所**: 189行目付近（タグマッチングロジック末尾）
   - **追加内容**: VRChatキーワードマッチングロジック（約5行）
   - **変更理由**: タイトルと説明からVRChatタグを自動抽出するため

### 削除

- なし

### 変更不要（理由付き）

1. **backend/src/main/resources/db/changelog/changelog.xml**
   - **理由**: `<includeAll path="changes"/>`で自動読み込み

2. **backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/VideoRepositoryImpl.kt**
   - **理由**: `getAllStreamTags()`がデータベースから動的にタグを取得

3. **backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/VideoController.kt**
   - **理由**: Repositoryから取得したタグをそのまま返す

4. **backend/src/main/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouter.kt**
   - **理由**: Controllerのメソッドを呼び出すのみ

5. **frontend/src/features/archives/api/archiveClient.ts**
   - **理由**: `/stream-tags` APIから動的にタグを取得

6. **frontend/src/features/archives/hooks/useAllStreamTags.ts**
   - **理由**: APIから取得したタグをReactコンポーネントに提供

7. **tools/scripts/stream_tags_importer.py**
   - **理由**: タグ名からIDを自動解決する設計

## テスト戦略

### 1. データベーステスト（単体）

#### テスト1-1: マイグレーション実行成功
- **目的**: マイグレーションファイルが正常に実行されることを確認
- **手順**:
  1. Docker Composeでマイグレーション実行
  2. エラーログがないことを確認
- **期待結果**: マイグレーション成功

#### テスト1-2: VRChatタグ追加確認
- **目的**: stream_tagsテーブルにVRChatタグが追加されていることを確認
- **手順**:
  1. PostgreSQLクライアントで接続
  2. `SELECT * FROM stream_tags WHERE name = 'VRChat';`を実行
- **期待結果**: id=17, name='VRChat', description='VRChat'のレコードが存在

#### テスト1-3: UNIQUE制約動作確認
- **目的**: UNIQUE制約が正常に機能することを確認
- **手順**:
  1. マイグレーションを再実行
  2. `ON CONFLICT DO NOTHING`により重複エラーが発生しないことを確認
- **期待結果**: エラーなく完了

### 2. バックエンドAPIテスト（統合）

#### テスト2-1: GET /stream-tags レスポンス確認
- **目的**: APIレスポンスにVRChatが含まれることを確認
- **手順**:
  1. バックエンドを起動
  2. `curl http://localhost:3001/api/stream-tags`を実行
- **期待結果**: レスポンス配列に"VRChat"が含まれる

#### テスト2-2: タグ順序確認
- **目的**: タグがアルファベット順でソートされていることを確認
- **手順**:
  1. APIレスポンスを確認
  2. タグの順序を検証
- **期待結果**: ORDER BY name通りにソートされている

### 3. フロントエンドE2Eテスト（Playwright）

#### テスト3-1: アーカイブページ表示確認
- **目的**: アーカイブページが正常に表示されることを確認
- **手順**:
  1. Playwright MCPツールでhttp://localhost:3001に移動
  2. ページスナップショットを取得
- **期待結果**: アーカイブページが正常に表示される

#### テスト3-2: VRChatタグ表示確認
- **目的**: ストリームタグフィルタにVRChatが表示されることを確認
- **手順**:
  1. アーカイブページのタグフィルタを確認
  2. VRChatが選択肢に含まれることを確認
- **期待結果**: VRChatがフィルタ選択肢として表示される

#### テスト3-3: VRChatタグフィルタリング動作確認
- **目的**: VRChatタグでフィルタリングが正常に動作することを確認
- **手順**:
  1. VRChatタグを選択
  2. 動画一覧が更新されることを確認
  3. URLパラメータにVRChatが含まれることを確認
- **期待結果**: フィルタリングが正常に動作する

### 4. ツールテスト（オプション）

#### テスト4-1: stream_tag_extractor.py キーワード抽出確認
- **目的**: VRChatキーワードが正しく抽出されることを確認
- **手順**:
  1. テストデータでstream_tag_extractor.pyを実行
  2. 出力CSVファイルを確認
- **期待結果**: VRChatキーワードを含む動画にVRChatタグが付与される

#### テスト4-2: stream_tags_importer.py インポート確認
- **目的**: VRChatタグが正しくインポートされることを確認
- **手順**:
  1. stream_tags_importer.pyを実行
  2. video_stream_tagsテーブルを確認
- **期待結果**: VRChatタグが正しくインポートされる

## リスク分析と対策

### リスク1: マイグレーションの実行失敗

- **発生確率**: 低
- **影響度**: 中
- **原因**:
  - SQLシンタックスエラー
  - データベース接続エラー
  - Liquibase設定エラー
- **対策**:
  - マイグレーションファイルのSQLを事前に検証
  - ローカル環境で先にテスト実行
  - Liquibaseのロールバック機能を活用
- **検知方法**: マイグレーション実行時のエラーログ
- **リカバリ手順**: `liquibase rollback`コマンドで元に戻す

### リスク2: UNIQUE制約違反

- **発生確率**: 低
- **影響度**: 中
- **原因**: 既にVRChatタグが存在している
- **対策**:
  - `ON CONFLICT (name) DO NOTHING`句を使用
  - マイグレーション実行前にstream_tagsテーブルを確認
- **検知方法**: マイグレーション実行時のエラーログ
- **リカバリ手順**: 既存データを確認し、必要に応じてマイグレーションをスキップ

### リスク3: ID番号の競合

- **発生確率**: 低
- **影響度**: 中
- **原因**: 他のマイグレーションで既にID=17が使用されている
- **対策**:
  - マイグレーション実行前に最新のIDを確認
  - 調査済み（既存タグはID 1-16まで）
- **検知方法**: マイグレーション実行時のPRIMARY KEY制約エラー
- **リカバリ手順**: IDを18に変更してマイグレーションを再実行

### リスク4: フロントエンド/バックエンドのキャッシュ問題

- **発生確率**: 低
- **影響度**: 低
- **原因**: タグ取得APIのキャッシュが更新されない
- **対策**:
  - E2Eテストでブラウザのキャッシュをクリア
  - 必要に応じてアプリケーションの再起動
- **検知方法**: E2EテストでVRChatタグが表示されない
- **リカバリ手順**: ブラウザのキャッシュクリア、アプリケーション再起動

### リスク5: 他の開発者との競合

- **発生確絡**: 低
- **影響度**: 低
- **原因**: 同時期に別のマイグレーションが作成される
- **対策**:
  - feature/add-vrchat-stream-tagブランチで作業
  - mainブランチへのマージ前に最新を取り込む
- **検知方法**: プルリクエスト作成時のコンフリクト
- **リカバリ手順**: mainブランチをマージし、マイグレーション番号を調整

### リスク6: stream_tag_extractor.pyの修正ミス

- **発生確率**: 低
- **影響度**: 低
- **原因**:
  - キーワードマッチングロジックの誤実装
  - インデントエラー
  - 既存ロジックの破壊
- **対策**:
  - テストデータで動作確認
  - 既存のロジックと同様のパターンで実装
  - Pythonの構文チェック
- **検知方法**: stream_tag_extractor.py実行時のエラー
- **リカバリ手順**: コードレビューと修正、再テスト

## 実装スケジュール

### Phase 1: 実装（所要時間: 30分）
- タスク1-1: マイグレーションファイル作成（10分）
- タスク1-2: Liquibase設定確認（5分）
- タスク2-1: stream_tag_extractor.py修正（15分）

### Phase 2: ローカルテスト（所要時間: 15分）
- タスク3-1: ローカル環境でのマイグレーション実行（10分）
- タスク3-2: データベース直接確認（5分）

### Phase 3: E2Eテスト（所要時間: 40分）
- タスク4-1: バックエンドAPIテスト（10分）
- タスク4-2: フロントエンドE2Eテスト（Playwright）（20分）
- タスク4-3: ツールテスト（オプション）（10分）

### Phase 4: コミット・プッシュ（所要時間: 10分）
- タスク5-1: コミット（5分）
- タスク5-2: プッシュ（5分）

### 合計所要時間
- **実装**: 30分
- **テスト**: 55分
- **合計**: 約1時間30分

## 成功基準

### 必須条件
1. マイグレーションが正常に実行され、VRChatタグが追加される
2. バックエンドAPIのレスポンスにVRChatが含まれる
3. フロントエンドのアーカイブページでVRChatタグが選択できる
4. VRChatタグでのフィルタリングが正常に動作する
5. 全てのテストが成功する

### 推奨条件
1. stream_tag_extractor.pyでVRChatキーワードが正しく抽出される
2. ロールバックが正常に動作することを確認
3. E2Eテストが全てグリーンになる

## 次のアクション

1. **IMPLEMENTフェーズに移行**
   - 本プランに基づいて実装を開始
   - タスクを順番に実行
   - 進捗をTODOリストで管理

2. **実装時の注意点**
   - Playwrightのスナップショットを使用して実際の画面を確認
   - 確認できていないことは「確認できていない」と正直に報告
   - 問題が解決していない場合は「解決していない」と明確に報告
   - 絶対に嘘をつかない

3. **実装完了後**
   - コミット・プッシュ
   - プルリクエスト作成（別タスク）

## 参考資料

### 調査レポート
- [investigate_20251014_100942.md](../investigate/investigate_20251014_100942.md)

### 関連ファイル

#### データベース
- `backend/src/main/resources/db/changelog/changes/009-create-stream-tag-tables.sql`
- `backend/src/main/resources/db/changelog/changes/014-insert-initial-stream-tags.sql`
- `backend/src/main/resources/db/changelog/changelog.xml`
- `backend/docs/database-schema.md`

#### バックエンド
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/VideoRepositoryImpl.kt:128-140`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/controller/VideoController.kt:28-29`
- `backend/src/main/kotlin/com/shirogane/holy/knights/infrastructure/lambda/ApiGatewayRouter.kt:63-65`
- `backend/src/main/kotlin/com/shirogane/holy/knights/adapter/gateway/entity/VideoEntities.kt:58-65`

#### フロントエンド
- `frontend/src/features/archives/api/archiveClient.ts:42-44`
- `frontend/src/features/archives/hooks/useAllStreamTags.ts`

#### ツール
- `tools/scripts/stream_tag_extractor.py:84-189`
- `tools/scripts/stream_tags_importer.py`
- `tools/justfile`

## 承認

- **プラン作成者**: Claude
- **承認者**: 実装前にユーザー承認が必要
- **実装担当**: Claude
- **レビュー担当**: ユーザー

---

**次フェーズ**: IMPLEMENT
**予想所要時間**: 約1時間30分
**リスクレベル**: 低