# SongSearchResultsSummary リファクタリング実装計画

**策定日時**: 2025年09月25日 01:13:08
**基準調査**: docs/investigate/investigate_20250925_010357.md
**対象ブランチ**: feature/song-search-results-refactor

## 1. 実装方針

### 基本方針
SongSearchResultsSummaryコンポーネントを他機能（Calendar、News、Discography、Archive）と統一した実装パターンに変更。基底コンポーネント（SearchResultsSummary）をラップする形にリファクタリングする。

### 実装アプローチ
- **完全置換方式**: 現在の134行の独自実装を削除し、基底コンポーネントラッパーとして再実装
- **機能統一**: 個別クリア機能を削除し、全クリア機能に統一
- **型変換**: SongFilterOptions → 基底コンポーネント対応形式への変換ロジック実装

## 2. 詳細実装タスク

### 優先度1: コア実装
1. **SongSearchResultsSummary.tsx 完全リファクタリング**
   - 既存134行の独自実装を削除
   - 基底コンポーネント（SearchResultsSummary）をインポート
   - フィルターサマリー生成ロジック実装
   - frequencyCategories → selectedTags 変換実装
   - 約40行のラッパーコンポーネントとして再実装

2. **Props Interface調整**
   - 個別クリア関数の削除: onClearSearch, onClearDateFilters, onClearFrequencyFilters
   - searchTarget プロパティの処理調整（現在未使用）

### 優先度2: 使用箇所修正
3. **songs/page.tsx修正**
   - 137行目: onClearSearch プロパティの削除
   - 使用箇所での不要なprops削除

## 3. ファイル変更計画

### 修正対象ファイル
| ファイルパス | 変更種別 | 変更規模 | 変更内容 |
|-------------|----------|----------|----------|
| `frontend/src/features/songs/components/display/results/SongSearchResultsSummary.tsx` | 完全書き換え | 134行 → 40行 | 基底コンポーネントラッパー実装 |
| `frontend/src/app/songs/page.tsx` | 部分修正 | 1箇所 | onClearSearchプロパティ削除 |

### 新規作成ファイル
なし（既存ファイルの修正のみ）

### 削除ファイル
なし

## 4. 実装詳細仕様

### 4.1 新しいSongSearchResultsSummary実装イメージ
```typescript
export const SongSearchResultsSummary = ({
  searchQuery,
  searchTarget,
  totalCount,
  filters,
  onClearAllFilters
}: SongSearchResultsSummaryProps) => {
  // フィルターサマリー生成
  const filterParts: string[] = [];
  if (searchTarget !== SearchTarget.ALL) {
    filterParts.push(`検索対象: ${SEARCH_TARGET_LABELS[searchTarget]}`);
  }
  if (filters.frequencyCategories?.length) {
    const frequencies = filters.frequencyCategories
      .map(cat => FREQUENCY_LABELS[cat]).join(', ');
    filterParts.push(`歌唱回数: ${frequencies}`);
  }
  const filterSummary = filterParts.join(' / ');

  // 基底コンポーネント用filters変換
  const baseFilters = {
    selectedTags: filters.frequencyCategories
      ?.map(cat => FREQUENCY_LABELS[cat]),
    startDate: filters.startDate,
    endDate: filters.endDate,
  };

  const hasFilters = Boolean(searchQuery.trim()) ||
    Boolean(filters.startDate) ||
    Boolean(filters.endDate) ||
    Boolean(filters.frequencyCategories?.length);

  return (
    <SearchResultsSummary
      searchQuery={searchQuery}
      filterSummary={filterSummary}
      totalCount={totalCount}
      onClearAllFilters={onClearAllFilters}
      hasFilters={hasFilters}
      filters={baseFilters}
    />
  );
};
```

### 4.2 Props Interface変更
```typescript
// 変更前
interface SongSearchResultsSummaryProps {
  searchQuery: string;
  searchTarget?: SearchTarget;
  totalCount: number;
  filters: SongFilterOptions;
  onClearSearch: () => void;           // 削除
  onClearAllFilters: () => void;
  onClearDateFilters?: () => void;     // 削除
  onClearFrequencyFilters?: () => void; // 削除
}

// 変更後
interface SongSearchResultsSummaryProps {
  searchQuery: string;
  searchTarget?: SearchTarget;
  totalCount: number;
  filters: SongFilterOptions;
  onClearAllFilters: () => void;
}
```

## 5. テスト戦略

### 5.1 E2Eテスト（Playwright MCP）
**テスト環境**: http://localhost:3001/songs

**テストケース**:
1. **検索機能テスト**
   - クエリ入力 → 検索実行 → 結果表示
   - サマリーコンポーネント表示確認

2. **フィルター機能テスト**
   - 日付フィルター適用 → サマリー表示確認
   - 頻度カテゴリフィルター適用 → サマリー表示確認
   - 複数フィルター組み合わせテスト

3. **クリア機能テスト**
   - 全クリアボタンクリック → 全フィルタークリア確認
   - サマリーコンポーネント非表示確認

4. **UI表示テスト**
   - フィルターサマリーテキスト表示確認
   - レスポンシブ表示確認（モバイル・デスクトップ）

### 5.2 単体・統合テスト
- フィルター変換ロジックのテスト
- フィルターサマリー生成ロジックのテスト

## 6. リスク分析と対策

### 6.1 高リスク事項

**リスク1: UX劣化**
- **内容**: 個別クリアボタン削除による操作性低下
- **影響度**: 中
- **対策**: 全クリアボタンで代替。必要に応じて将来的に基底コンポーネント拡張を検討

**リスク2: 表示差異**
- **内容**: 基底コンポーネントのスタイル適用による表示変更
- **影響度**: 低
- **対策**: テスト段階で表示確認し、必要に応じて調整

### 6.2 中リスク事項

**リスク3: SearchTarget表示制約**
- **内容**: 現在未使用だが、将来的な拡張制約
- **影響度**: 低
- **対策**: filterSummaryで対応可能

## 7. 実装順序とマイルストーン

### Phase 1: コア実装
1. SongSearchResultsSummary.tsx リファクタリング
2. Props Interface調整
3. 型定義・インポート調整

### Phase 2: 統合・修正
4. songs/page.tsx修正
5. 統合テスト・問題修正

### Phase 3: テスト・検証
6. E2Eテスト実施（Playwright MCP）
7. 表示確認・調整
8. 最終確認・コミット準備

## 8. 完了判定基準

### 必須条件
- [ ] SongSearchResultsSummary.tsxが基底コンポーネントラッパーとして実装済み
- [ ] songs/page.tsxの使用箇所が正常に動作
- [ ] 検索・フィルター・クリア機能が正常動作
- [ ] E2Eテストが全て通過

### 品質条件
- [ ] フィルターサマリーが適切に表示される
- [ ] レスポンシブ表示が正常
- [ ] エラーが発生しない
- [ ] 他機能との統一性が保たれている

## 9. 追加検討事項

### 将来的拡張の余地
- 基底コンポーネントの個別クリア機能拡張
- SearchTarget表示の活用
- フィルター表示の詳細化

### コードメンテナンス性
- 他機能との統一パターン確立
- 重複コード削減効果
- 保守コスト削減

---

## 最終ステータス

**status**: SUCCESS
**next**: IMPLEMENT
**details**: "実装プラン策定完了。plan_20250925_011308.mdに詳細記録。実装フェーズに移行。"