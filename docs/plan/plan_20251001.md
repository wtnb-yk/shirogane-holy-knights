# ボタンコンポーネント共通化 - 実装計画書

## 作成日: 2025-10-01
## ブランチ: feature/button-component-consolidation
## 参照: docs/investigate/investigate_20251001.md

---

## 1. 実装方針

### フェーズ分けしない理由
- フェーズ分けは先延ばしでしかない
- 今できることを後回しにする理由がない
- 一気に完成させる方が効率的

### YAGNI原則に従う
- 今必要なものだけ実装
- 将来のための過剰設計をしない
- 無理な共通化はしない

---

## 2. 実装内容

### 2.1 Button.tsx完全作り直し

**現状の問題**:
- テンプレートリテラルで実装（CVA未使用）
- アイコン非対応
- ローディング状態なし
- バリアント不足
- サイズ不足

**新実装**:
- CVAで完全実装
- アイコン対応（先頭/末尾）
- ローディング状態対応
- 必要な全バリアント
- 全サイズ（xs, sm, md, lg, xl）

**API設計**:
```tsx
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost' | 'danger';
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';
  loading?: boolean;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
  children: React.ReactNode;
}
```

**実装例**:
```tsx
'use client';

import React from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/lib/utils';
import { Loader2 } from 'lucide-react';

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:pointer-events-none",
  {
    variants: {
      variant: {
        primary: "bg-accent-blue text-white hover:bg-accent-blue/80 focus:ring-accent-blue",
        secondary: "bg-text-secondary text-white hover:bg-text-secondary/90 focus:ring-text-secondary",
        outline: "border border-accent-blue/20 text-accent-blue hover:text-accent-blue/80 hover:bg-accent-blue/10 focus:ring-accent-blue",
        ghost: "text-text-secondary hover:text-text-primary hover:bg-bg-accent focus:ring-text-secondary",
        danger: "bg-red-500 text-white hover:bg-red-600 focus:ring-red-500"
      },
      size: {
        xs: "px-2 py-1 text-xs min-h-[24px]",
        sm: "px-3 py-1.5 text-sm min-h-[32px]",
        md: "px-4 py-2 text-sm min-h-[40px]",
        lg: "px-6 py-3 text-base min-h-[48px]",
        xl: "px-8 py-4 text-lg min-h-[56px]"
      }
    },
    defaultVariants: {
      variant: "secondary",
      size: "md"
    }
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  loading?: boolean;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
  children: React.ReactNode;
}

export const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, loading, leftIcon, rightIcon, children, disabled, ...props }, ref) => {
    return (
      <button
        ref={ref}
        className={cn(buttonVariants({ variant, size, className }))}
        disabled={disabled || loading}
        {...props}
      >
        {loading && <Loader2 className="h-4 w-4 animate-spin" />}
        {!loading && leftIcon && <span className="inline-flex">{leftIcon}</span>}
        {children}
        {!loading && rightIcon && <span className="inline-flex">{rightIcon}</span>}
      </button>
    );
  }
);

Button.displayName = 'Button';
```

---

### 2.2 IconButton.tsx新規作成

**用途**:
- アイコン専用ボタン
- ModalHeader/BottomSheetHeaderで今すぐ使う
- 閉じる、戻る、ナビゲーション等

**API設計**:
```tsx
interface IconButtonProps {
  icon: React.ReactNode;
  onClick?: () => void;
  variant?: 'default' | 'ghost' | 'danger';
  size?: 'sm' | 'md' | 'lg';
  'aria-label': string; // 必須
  className?: string;
  disabled?: boolean;
}
```

**実装例**:
```tsx
'use client';

import React from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/lib/utils';

const iconButtonVariants = cva(
  "inline-flex items-center justify-center rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",
  {
    variants: {
      variant: {
        default: "text-text-secondary hover:text-text-primary hover:bg-surface-hover focus:ring-accent-gold",
        ghost: "text-text-secondary hover:text-text-primary hover:bg-transparent",
        danger: "text-text-danger hover:text-text-danger-dark hover:bg-red-50 focus:ring-red-500"
      },
      size: {
        sm: "min-w-[32px] min-h-[32px] w-8 h-8",
        md: "min-w-[40px] min-h-[40px] w-10 h-10",
        lg: "min-w-[44px] min-h-[44px] w-11 h-11"
      }
    },
    defaultVariants: {
      variant: "default",
      size: "md"
    }
  }
);

export interface IconButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof iconButtonVariants> {
  icon: React.ReactNode;
  'aria-label': string;
}

export const IconButton = React.forwardRef<HTMLButtonElement, IconButtonProps>(
  ({ className, variant, size, icon, ...props }, ref) => {
    return (
      <button
        ref={ref}
        className={cn(iconButtonVariants({ variant, size, className }))}
        {...props}
      >
        {icon}
      </button>
    );
  }
);

IconButton.displayName = 'IconButton';
```

---

### 2.3 SearchOptionsButton使用（4ファイル修正）

**対象ファイル**:
1. ArchiveSearchSection.tsx
2. NewsSearchSection.tsx
3. SongSearchSection.tsx
4. DiscographySearchSection.tsx

**変更内容**:

**Before**:
```tsx
{/* TODO: 共通化*/}
<button
  onClick={onFilterClick}
  className={`w-full py-2.5 px-4 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-all border ${
    hasActiveOptions
      ? 'border-text-secondary text-text-secondary bg-text-secondary/10 hover:bg-text-secondary/20'
      : 'border-surface-border text-text-secondary bg-white hover:text-text-primary hover:border-text-secondary hover:bg-bg-accent/20'
  }`}
>
  <Settings className="w-4 h-4" />
  <span>検索オプション</span>
  {hasActiveOptions && (
    <span className="ml-1 w-2 h-2 bg-text-secondary rounded-full"></span>
  )}
</button>
```

**After**:
```tsx
import { SearchOptionsButton } from '@/components/Button/SearchOptionsButton';

<SearchOptionsButton
  onClick={onFilterClick}
  hasActiveOptions={hasActiveOptions}
/>
```

---

### 2.4 移行ファイル

#### ModalHeader.tsx
**変更内容**: IconButton使用

**Before**:
```tsx
<button
  onClick={backButton.onClick}
  className="p-2 text-text-primary hover:text-accent-gold transition-colors rounded-lg hover:bg-surface-hover"
  aria-label="戻る"
>
  <ChevronLeft className="w-6 h-6" />
</button>
```

**After**:
```tsx
import { IconButton } from '@/components/Button/IconButton';

<IconButton
  icon={<ChevronLeft className="w-6 h-6" />}
  onClick={backButton.onClick}
  aria-label="戻る"
/>
```

#### BottomSheetHeader.tsx
**変更内容**: 同上

#### CalendarHeader.tsx
**変更内容**: ナビゲーションボタンをIconButtonに、今日ボタンを新Button.tsxに

**Before**:
```tsx
<button
  onClick={() => navigateDate('prev')}
  className="p-2 text-text-secondary hover:text-accent-blue hover:bg-bg-accent rounded-md transition-all duration-200 interactive-hover"
>
  <ChevronLeft className="w-5 h-5" />
</button>
```

**After**:
```tsx
<IconButton
  icon={<ChevronLeft className="w-5 h-5" />}
  onClick={() => navigateDate('prev')}
  aria-label="前月"
  size="md"
/>
```

#### Toast.tsx
**変更内容**: 閉じるボタンをIconButtonに

#### ErrorDisplay.tsx / ErrorBoundary.tsx
**変更内容**: 新Button.tsx使用

---

## 3. タスク分解

### タスク1: コアコンポーネント作成
1.1. Button.tsx完全書き直し（CVA、アイコン、ローディング）
1.2. IconButton.tsx新規作成

### タスク2: SearchOptionsButton使用（4ファイル）
2.1. ArchiveSearchSection.tsx
2.2. NewsSearchSection.tsx
2.3. SongSearchSection.tsx
2.4. DiscographySearchSection.tsx

### タスク3: IconButton移行（3ファイル）
3.1. ModalHeader.tsx
3.2. BottomSheetHeader.tsx
3.3. CalendarHeader.tsx（ナビゲーションボタン）
3.4. Toast.tsx

### タスク4: Button.tsx移行（3ファイル）
4.1. CalendarHeader.tsx（今日ボタン）
4.2. ErrorDisplay.tsx
4.3. ErrorBoundary.tsx

### タスク5: テスト
5.1. Playwrightで動作確認
5.2. ビルドチェック

---

## 4. ファイル変更一覧

### 完全書き直し（1ファイル）
- `/frontend/src/components/Button/Button.tsx`

### 新規作成（1ファイル）
- `/frontend/src/components/Button/IconButton.tsx`

### 修正（10ファイル）
1. `/frontend/src/features/archives/components/search/internals/ArchiveSearchSection.tsx`
2. `/frontend/src/features/news/components/layout/internals/NewsSearchSection.tsx`
3. `/frontend/src/features/songs/components/search/internals/SongSearchSection.tsx`
4. `/frontend/src/features/discography/components/DiscographySidebar/DiscographySearchSection.tsx`
5. `/frontend/src/components/Modal/ModalHeader.tsx`
6. `/frontend/src/components/BottomSheet/BottomSheetHeader.tsx`
7. `/frontend/src/features/calendar/components/calender/internals/CalendarHeader.tsx`
8. `/frontend/src/components/Feedback/Toast.tsx`
9. `/frontend/src/components/Error/ErrorDisplay.tsx`
10. `/frontend/src/components/Error/ErrorBoundary.tsx`

---

## 5. テスト計画

### 5.1 E2Eテスト（Playwright）

**テスト対象ページ**:
- `/archives` - SearchOptionsButton
- `/news` - SearchOptionsButton
- `/songs` - SearchOptionsButton
- `/discography` - SearchOptionsButton
- 各ページのモーダル - IconButton（閉じる、戻る）
- カレンダー - IconButton（ナビゲーション）、Button（今日）

**テスト項目**:
- ボタン表示確認
- クリック動作確認
- スタイル確認
- アクセシビリティ確認

### 5.2 ビルドチェック
```bash
cd frontend && pnpm build
```

---

## 6. リスク分析

### リスクレベル: 低

**理由**:
- Button.tsxは既存使用箇所が3ファイルのみ
- IconButtonは新規作成
- SearchOptionsButtonは既存コンポーネント使用

### 想定リスクと対策

**リスク1: スタイル崩れ**
- 対策: E2Eテストで全画面確認

**リスク2: TypeScriptエラー**
- 対策: ビルドチェックで早期発見

**リスク3: 既存機能への影響**
- 対策: 段階的コミットで問題の切り分け

---

## 7. 実装手順

### Step 1: コアコンポーネント作成（60分）
1. Button.tsx完全書き直し
2. IconButton.tsx新規作成
3. ビルドチェック

### Step 2: SearchOptionsButton使用（30分）
1. 4ファイル一括修正
2. ビルドチェック

### Step 3: IconButton移行（45分）
1. ModalHeader/BottomSheetHeader修正
2. CalendarHeader修正
3. Toast修正
4. ビルドチェック

### Step 4: Button.tsx移行（30分）
1. CalendarHeader（今日ボタン）修正
2. ErrorDisplay/ErrorBoundary修正
3. ビルドチェック

### Step 5: テスト（45分）
1. Playwright起動
2. 全ページ動作確認
3. 問題があれば修正

**合計推定時間**: 約3.5時間

---

## 8. 成功基準

- [ ] Button.tsx CVA実装完了
- [ ] IconButton.tsx作成完了
- [ ] SearchOptionsButton 4ファイルで使用
- [ ] IconButton 7箇所で使用
- [ ] TypeScriptエラー0件
- [ ] ビルド成功
- [ ] E2Eテスト全件パス
- [ ] コード重複90%削減達成

---

## 9. やらないこと（YAGNI）

- SegmentedControl共通化 → 既にCVA実装済み、専用UI
- Pagination共通化 → 複雑な状態管理、専用ロジック
- カレンダーイベントボタン共通化 → 動的ポジショニング、色分け必要
- フェーズ分け → 先延ばしでしかない

---

## 10. 完了条件

1. 全タスク完了
2. ビルド成功
3. E2Eテスト全件パス
4. コミット完了
5. 動作確認完了

実装完了後、IMPLEMENTフェーズに移行。
