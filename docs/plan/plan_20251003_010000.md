# Specials機能コンポーネントリファクタリング実装プラン

## プラン作成日時
2025-10-03 01:00:00

## プラン対象
frontend/src/features/specials/componentsのコンポーネント分割と設計改善

## 背景と目的

### 現状の問題点
調査結果（`docs/investigate/investigate_20251003_005327.md`）に基づき、以下の問題が確認されました：

1. **コンポーネントの分割不足**
   - `SpecialsGrid.tsx`（68行）に全てのUIロジックが集約
   - カードコンポーネント、ステータスバッジが分離されていない
   - 再利用性が低い

2. **ディレクトリ構造の不足**
   - `cards/`, `grids/`, `internals/`ディレクトリが存在しない
   - 他機能（News、Archives）との一貫性がない

3. **デザインパターンの未適用**
   - `InteractiveCard`や`StaggeredItem`などの既存コンポーネントを活用していない
   - パフォーマンス最適化（`React.memo`, `useCallback`, `useMemo`）が不足

### 目的
他機能との一貫性を保ちつつ、保守性・再利用性・パフォーマンスを向上させる

## アーキテクチャ設計

### ディレクトリ構造（完成形）
```
frontend/src/features/specials/components/
├── cards/
│   ├── SpecialEventCard.tsx
│   ├── SkeletonSpecialEventCard.tsx
│   └── internals/
│       ├── SpecialEventCardDescription.tsx
│       └── SpecialEventStatusBadge.tsx
└── grids/
    ├── SpecialsGrid.tsx
    └── internals/
        └── SpecialsListGrid.tsx
```

### コンポーネント設計

#### 1. SpecialEventStatusBadge
- **ファイル**: `cards/internals/SpecialEventStatusBadge.tsx`
- **責務**: ステータスバッジの表示とスタイリング
- **Props**:
  - `status: 'upcoming' | 'active' | 'ended'`
- **スタイル**:
  - `active`: `bg-accent-green text-white`
  - `upcoming`: `bg-accent-blue text-white`
  - `ended`: `bg-surface-tertiary text-text-secondary`
- **表示テキスト**:
  - `active`: "開催中"
  - `upcoming`: "開催予定"
  - `ended`: "終了"

#### 2. SpecialEventCardDescription
- **ファイル**: `cards/internals/SpecialEventCardDescription.tsx`
- **責務**: タイトルと説明文の表示
- **Props**:
  - `title: string`
  - `description: string`
- **スタイル**:
  - タイトル: `text-xl font-bold text-text-primary mb-2`
  - 説明文: `text-text-secondary mb-4 line-clamp-3`（3行制限）

#### 3. SkeletonSpecialEventCard
- **ファイル**: `cards/SkeletonSpecialEventCard.tsx`
- **責務**: ローディング中のスケルトン表示
- **Props**:
  - `index: number`
- **使用コンポーネント**: `StaggeredItem`, `Card`, `Skeleton`
- **パターン**: NewsCardのSkeletonパターンに準拠
- **最適化**: `React.memo`

#### 4. SpecialEventCard
- **ファイル**: `cards/SpecialEventCard.tsx`
- **責務**: 単一のイベントカード表示
- **Props**:
  - `event: SpecialEventDto`
  - `index: number`
  - `onEventClick: (event: SpecialEventDto) => void`
- **使用コンポーネント**:
  - `InteractiveCard`（クリック可能なカード基盤）
  - `StaggeredItem`（アニメーション効果）
  - `SpecialEventCardDescription`（タイトルと説明）
  - `SpecialEventStatusBadge`（ステータス表示）
- **レイアウト**:
  - 上部: タイトルと説明
  - 下部: 日付とステータスバッジを横並び
- **最適化**: `React.memo`

#### 5. SpecialsListGrid
- **ファイル**: `grids/internals/SpecialsListGrid.tsx`
- **責務**: グリッドレイアウトと状態管理（ローディング、エラー、空状態）
- **Props**:
  - `items: T[]`
  - `loading: boolean`
  - `error: ApiError | null`
  - `renderItem: (item: T, index: number) => ReactElement`
  - `renderSkeleton: (index: number) => ReactElement`
  - `emptyMessage?: { title: string; subtitle: string }`
  - `skeletonCount?: number`
- **グリッドレイアウト**: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6`
- **パターン**: NewsListGridと同様のジェネリックコンポーネント
- **最適化**: `React.memo`

#### 6. SpecialsGrid（リファクタリング）
- **ファイル**: `grids/SpecialsGrid.tsx`
- **責務**: イベントグリッドの調整とレンダリングロジック
- **Props**:
  - `events: SpecialEventDto[]`
  - `loading: boolean`
  - `error: ApiError | null`
  - `onEventClick: (event: SpecialEventDto) => void`
- **使用コンポーネント**: `SpecialsListGrid`
- **最適化**:
  - `useCallback`で`renderItem`、`renderSkeleton`をメモ化
  - `useMemo`で`emptyMessage`をメモ化
  - `React.memo`でコンポーネント全体をメモ化

## 実装手順

### フェーズ1: 内部コンポーネント作成
1. `frontend/src/features/specials/components/cards/internals/`ディレクトリ作成
2. `SpecialEventStatusBadge.tsx`実装
3. `SpecialEventCardDescription.tsx`実装

### フェーズ2: カードコンポーネント作成
1. `frontend/src/features/specials/components/cards/`ディレクトリ作成
2. `SkeletonSpecialEventCard.tsx`実装
3. `SpecialEventCard.tsx`実装

### フェーズ3: グリッドコンポーネント作成
1. `frontend/src/features/specials/components/grids/`ディレクトリ作成
2. `frontend/src/features/specials/components/grids/internals/`ディレクトリ作成
3. `SpecialsListGrid.tsx`実装
4. `SpecialsGrid.tsx`リファクタリング

### フェーズ4: 既存ファイル整理
1. `frontend/src/features/specials/components/SpecialsGrid.tsx`削除
2. `frontend/src/app/specials/page.tsx`のインポートパス更新
   - 変更前: `@/features/specials/components/SpecialsGrid`
   - 変更後: `@/features/specials/components/grids/SpecialsGrid`

### フェーズ5: E2Eテスト
1. Playwright MCPツールでブラウザ起動
2. `http://localhost:3001/specials`にアクセス
3. 以下を確認:
   - イベント一覧の表示
   - ローディング状態（スケルトン表示）
   - エラー状態の表示
   - 空状態の表示
   - カードクリックイベント
   - レスポンシブデザイン（モバイル、タブレット、デスクトップ）
   - ステータスバッジの表示（upcoming, active, ended）
   - アニメーション効果（StaggeredItem）

## 技術的制約

### 使用する共通コンポーネント
- `InteractiveCard` (`frontend/src/components/Card/InteractiveCard.tsx`)
- `StaggeredItem` (`frontend/src/components/Card/StaggeredItem.tsx`)
- `Card` (`frontend/src/components/Card/card.tsx`)
- `Skeleton` (`frontend/src/components/Loading/skeleton.tsx`)
- `ErrorDisplay` (`frontend/src/components/Error/ErrorDisplay.tsx`)

### スタイリング規則
- **Tailwind CSS使用**
- **カラーパレット**:
  - 背景: `bg-bg-primary`
  - テキスト: `text-text-primary`, `text-text-secondary`, `text-text-tertiary`
  - アクセント: `accent-green`, `accent-blue`, `surface-tertiary`
- **レスポンシブ**: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`

### パフォーマンス要件
- `React.memo`でコンポーネントをメモ化
- `useCallback`でコールバックの再生成を防止
- `useMemo`で計算結果をキャッシュ

## テスト戦略

### E2Eテスト（Playwright MCP）
#### 動作確認項目
1. **イベント一覧の表示**
   - カードが正しく表示される
   - タイトル、説明、日付が正しく表示される
   - ステータスバッジが正しく表示される

2. **ローディング状態の表示**
   - スケルトンカードが表示される
   - アニメーション効果が動作する

3. **エラー状態の表示**
   - ErrorDisplayが表示される
   - エラーメッセージが表示される

4. **空状態の表示**
   - 空メッセージが表示される

5. **カードクリックイベント**
   - カードをクリックできる
   - onEventClickが呼ばれる

6. **レスポンシブデザイン**
   - モバイル: 1列
   - タブレット: 2列
   - デスクトップ: 3列

7. **ステータスバッジの表示**
   - `active`: 緑色、"開催中"
   - `upcoming`: 青色、"開催予定"
   - `ended`: グレー、"終了"

8. **アニメーション効果**
   - StaggeredItemの遅延アニメーションが動作する

## リスク分析と対策

### リスク1: 既存の動作の破壊
- **リスク内容**: リファクタリングにより既存の動作が破壊される可能性
- **対策**:
  - 段階的な実装（フェーズごとに確認）
  - 各フェーズでのE2Eテスト実施
  - 既存のpropsインターフェースを維持

### リスク2: パフォーマンスの低下
- **リスク内容**: コンポーネント分割により再レンダリングが増加する可能性
- **対策**:
  - `React.memo`で不要な再レンダリングを防止
  - `useCallback`、`useMemo`で依存配列を適切に管理
  - NewsCardの実績あるパターンを踏襲

### リスク3: スタイリングの不整合
- **リスク内容**: 分割により見た目が変わる可能性
- **対策**:
  - 既存のTailwindクラスを正確に移植
  - E2Eテストでビジュアルリグレッションを確認
  - スクリーンショットで比較

### リスク4: インポートパスの変更による影響
- **リスク内容**: インポートパス変更により他ファイルが影響を受ける可能性
- **対策**:
  - `page.tsx`のインポートを最後に更新
  - TypeScriptコンパイルエラーを確認
  - `npm run build`でビルドエラーを確認

## 期待される効果

### 1. コードの保守性向上
- 68行の単一コンポーネント → 責務が明確な複数コンポーネント
- 各コンポーネントが独立してテスト可能

### 2. 他機能との一貫性確保
- NewsCardパターンに準拠
- 統一されたディレクトリ構造

### 3. パフォーマンス最適化
- 不要な再レンダリングの防止
- メモ化による計算コストの削減

### 4. 再利用性向上
- 内部コンポーネントの独立性
- 他機能での再利用が容易

### 5. 将来的な拡張の容易性
- CountdownTimerコンポーネントの追加が容易
- 新機能の追加が容易

## 依存関係とコミット戦略

### 作業ブランチ
- **現在**: `feat/specials`
- **方針**: 同ブランチで作業を継続

### コミット計画
1. `feat: add SpecialEventCard internal components`
   - SpecialEventStatusBadge.tsx
   - SpecialEventCardDescription.tsx

2. `feat: add SpecialEventCard and SkeletonSpecialEventCard`
   - SpecialEventCard.tsx
   - SkeletonSpecialEventCard.tsx

3. `feat: add SpecialsListGrid component`
   - SpecialsListGrid.tsx

4. `refactor: modernize SpecialsGrid with new component structure`
   - SpecialsGrid.tsx（リファクタリング）
   - page.tsx（インポートパス更新）
   - 既存SpecialsGrid.tsx削除

5. `test: verify Specials feature with E2E tests`
   - Playwright MCPによる動作確認

## タスクリストとの対応

### 対応するタスク
- タスク4: `SpecialEventCard コンポーネントを構築` → 本プランで実装
- タスク6: `SpecialsGrid コンポーネントを構築` → 本プランでリファクタリング

### 未対応のタスク（将来実装）
- タスク5: CountdownTimer コンポーネントの実装
- タスク7: SpecialDetailModal コンポーネントの作成
- タスク10: ルーティングとナビゲーションの追加
- タスク11-12: ユニットテストと統合テストの作成

## 結論

調査結果に基づき、Specials機能のコンポーネントを以下の方針でリファクタリングします：

1. **内部コンポーネント** → **カードコンポーネント** → **グリッドコンポーネント**の順で実装
2. NewsCardの実績あるパターンを踏襲
3. React.memo、useCallback、useMemoで最適化
4. 各フェーズでE2Eテストを実施
5. 段階的なコミットで安全に進行

これにより、保守性・再利用性・パフォーマンスが向上し、他機能との一貫性が確保されます。
